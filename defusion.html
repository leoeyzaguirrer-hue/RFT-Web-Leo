<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Defusi√≥n: Entrenamiento Cl√≠nico</title>
<meta name="description" content="Entrena tu habilidad de defusi√≥n cognitiva con ejercicios progresivos basados en ACT y RFT">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #e8f4f8;
  --bg-card: #1b5e7b;
  --bg-card-hover: #1a7a9a;
  --bg-surface: #15516d;
  --blue-dark: #0e3d54;
  --blue-mid: #2874a6;
  --blue-bright: #2196c8;
  --blue-light: #4fc3f7;
  --gold: #d4a017;
  --gold-dim: #b8860b;
  --gold-bright: #f0c040;
  --white: #ffffff;
  --white-dim: #dce8ec;
  --white-muted: #a8c4d0;
  --green: #2ecc71;
  --green-dim: #1a5c35;
  --red: #e74c3c;
  --red-dim: #5c1a1a;
  --text-dark: #1a3a4a;
  --text-mid: #2c5f73;
  --font-body: 'DM Sans', sans-serif;
  --font-display: 'Playfair Display', serif;
  --radius: 16px;
  --radius-sm: 10px;
  --radius-xs: 6px;
  --shadow: 0 8px 32px rgba(27,94,123,0.2);
  --shadow-sm: 0 4px 16px rgba(27,94,123,0.15);
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-dark);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* === AMBIENT BACKGROUND === */
.bg-ambient {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0; pointer-events: none; overflow: hidden;
  background: linear-gradient(160deg, #e8f4f8 0%, #d4eef6 40%, #e0f0e8 100%);
}
.bg-line {
  position: absolute; background: linear-gradient(90deg, transparent, var(--gold-bright), transparent);
  opacity: 0.18; border-radius: 2px;
}
.bg-line:nth-child(1) {
  width: 200%; height: 1.5px; top: 18%; left: -50%;
  animation: lineSlide 18s linear infinite;
  transform: rotate(-12deg);
}
.bg-line:nth-child(2) {
  width: 180%; height: 1px; top: 42%; left: -40%;
  animation: lineSlide 24s linear infinite reverse;
  transform: rotate(8deg); opacity: 0.12;
}
.bg-line:nth-child(3) {
  width: 160%; height: 1.5px; top: 68%; left: -30%;
  animation: lineSlide 20s linear infinite;
  transform: rotate(-5deg); opacity: 0.15;
}
.bg-line:nth-child(4) {
  width: 140%; height: 1px; top: 88%; left: -20%;
  animation: lineSlide 22s linear infinite reverse;
  transform: rotate(15deg); opacity: 0.1;
}
.bg-circle {
  position: absolute; border: 1.5px solid var(--gold-bright); border-radius: 50%; opacity: 0.1;
  animation: circleFloat 25s ease-in-out infinite;
}
.bg-circle:nth-child(5) { width: 300px; height: 300px; top: -80px; right: -60px; }
.bg-circle:nth-child(6) { width: 200px; height: 200px; bottom: 10%; left: -40px; animation-delay: -8s; opacity: 0.08; }
.bg-circle:nth-child(7) { width: 150px; height: 150px; top: 40%; right: -30px; animation-delay: -15s; opacity: 0.07; }
@keyframes lineSlide {
  0% { transform: translateX(-10%) rotate(var(--r, -12deg)); }
  50% { transform: translateX(10%) rotate(var(--r, -12deg)); }
  100% { transform: translateX(-10%) rotate(var(--r, -12deg)); }
}
@keyframes circleFloat {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(20px, -25px) scale(1.05); }
  66% { transform: translate(-15px, 20px) scale(0.95); }
}

/* === LAYOUT === */
.app-container { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 0 16px; }

/* === HEADER === */
.header {
  text-align: center; padding: 32px 0 24px; animation: fadeInDown 0.8s ease-out;
}
.header h1 {
  font-family: var(--font-display); font-size: 1.6rem; font-weight: 700;
  background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 50%, var(--gold) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; line-height: 1.3;
}
.header p { color: var(--text-mid); font-size: 0.85rem; margin-top: 6px; font-weight: 300; }

/* === PROGRESS BAR GLOBAL === */
.global-progress {
  background: rgba(27,94,123,0.1); border-radius: 20px; padding: 12px 16px;
  margin-bottom: 20px; display: flex; align-items: center; gap: 12px;
  border: 1px solid rgba(27,94,123,0.12); backdrop-filter: blur(8px);
}
.global-progress-bar {
  flex: 1; height: 8px; background: rgba(27,94,123,0.15); border-radius: 4px; overflow: hidden;
}
.global-progress-fill {
  height: 100%; border-radius: 4px; transition: width 0.6s ease;
  background: linear-gradient(90deg, var(--blue-bright), var(--gold));
}
.global-progress-text { font-size: 0.75rem; color: var(--gold-dim); font-weight: 600; white-space: nowrap; }

/* === LEVEL CARDS === */
.levels-grid { display: flex; flex-direction: column; gap: 12px; padding-bottom: 24px; }
.level-card {
  background: var(--bg-card); border-radius: var(--radius); padding: 20px;
  border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
  transition: var(--transition); position: relative; overflow: hidden;
  color: var(--white); box-shadow: var(--shadow-sm);
}
.level-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--blue-bright), var(--gold));
  opacity: 0; transition: var(--transition);
}
.level-card:hover, .level-card:active { background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: var(--shadow); }
.level-card:hover::before, .level-card.active::before { opacity: 1; }
.level-card.locked { opacity: 0.5; pointer-events: none; }
.level-card.completed { border-color: var(--green); }
.level-card.completed::before { background: var(--green); opacity: 0.6; }

.level-header { display: flex; align-items: center; gap: 14px; margin-bottom: 10px; }
.level-icon {
  width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; background: rgba(0,0,0,0.15); flex-shrink: 0;
}
.level-info { flex: 1; }
.level-num { font-size: 0.7rem; color: var(--gold-bright); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
.level-title { font-size: 1.05rem; font-weight: 600; margin-top: 2px; }
.level-desc { font-size: 0.8rem; color: rgba(255,255,255,0.7); margin-top: 4px; line-height: 1.4; }

.level-progress { margin-top: 12px; }
.level-progress-bar { height: 5px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; }
.level-progress-fill { height: 100%; border-radius: 3px; background: var(--gold-bright); transition: width 0.4s ease; }
.level-progress-text { font-size: 0.7rem; color: rgba(255,255,255,0.65); margin-top: 4px; text-align: right; }
.level-lock-badge {
  position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.2);
  padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; color: rgba(255,255,255,0.6);
}
.level-complete-badge {
  position: absolute; top: 12px; right: 12px; background: rgba(46,204,113,0.2);
  padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; color: var(--green); font-weight: 600;
}

/* === EXERCISE VIEW === */
.view { display: none; animation: fadeIn 0.4s ease-out; }
.view.active { display: block; }

.exercise-header {
  display: flex; align-items: center; gap: 12px; padding: 16px 0;
  border-bottom: 1px solid rgba(27,94,123,0.12); margin-bottom: 20px;
}
.btn-back {
  width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card);
  border: none; color: var(--white); font-size: 1.2rem;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
  transition: var(--transition); box-shadow: var(--shadow-sm);
}
.btn-back:hover { background: var(--bg-card-hover); }
.exercise-header-info { flex: 1; }
.exercise-header-info .level-num { font-size: 0.65rem; color: var(--blue-mid); }
.exercise-header-info .ex-title { font-size: 0.95rem; font-weight: 600; margin-top: 2px; color: var(--text-dark); }
.exercise-counter {
  font-size: 0.7rem; color: var(--gold-dim); background: rgba(212,160,23,0.12);
  padding: 4px 10px; border-radius: 20px; font-weight: 600;
}

.exercise-progress-mini {
  display: flex; gap: 4px; margin-bottom: 20px;
}
.exercise-dot {
  flex: 1; height: 4px; border-radius: 2px; background: rgba(27,94,123,0.15); transition: var(--transition);
}
.exercise-dot.done { background: var(--green); }
.exercise-dot.current { background: var(--gold); }

/* === EXERCISE CONTENT === */
.exercise-card {
  background: var(--bg-card); border-radius: var(--radius); padding: 24px 20px;
  border: 1px solid rgba(255,255,255,0.08); margin-bottom: 16px;
  color: var(--white); box-shadow: var(--shadow-sm);
}
.exercise-card h3 {
  font-family: var(--font-display); font-size: 1.2rem; line-height: 1.3;
  margin-bottom: 16px; color: var(--white);
}
.exercise-card .scenario {
  background: rgba(0,0,0,0.15); border-radius: var(--radius-sm); padding: 16px;
  margin-bottom: 16px; border-left: 3px solid var(--gold);
  font-size: 0.9rem; line-height: 1.6; color: var(--white-dim);
}
.exercise-card .scenario em { color: var(--gold-bright); font-style: italic; }
.exercise-card .scenario .speaker {
  font-weight: 600; color: var(--blue-light); display: block; margin-bottom: 4px; font-size: 0.8rem;
}
.exercise-card .instruction {
  font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 16px; line-height: 1.5;
}

/* === OPTION BUTTONS === */
.options { display: flex; flex-direction: column; gap: 10px; }
.option-btn {
  background: rgba(0,0,0,0.12); border: 1.5px solid rgba(255,255,255,0.12);
  border-radius: var(--radius-sm); padding: 14px 16px; text-align: left;
  color: var(--white); font-size: 0.88rem; line-height: 1.5; cursor: pointer;
  transition: var(--transition); font-family: var(--font-body); position: relative;
  display: flex; align-items: flex-start; gap: 12px;
}
.option-btn:hover { border-color: var(--gold-bright); background: rgba(0,0,0,0.2); }
.option-btn:active { transform: scale(0.98); }
.option-btn .opt-letter {
  width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.1);
  display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
  font-weight: 600; color: rgba(255,255,255,0.6); flex-shrink: 0;
}
.option-btn.selected { border-color: var(--gold); background: rgba(212,160,23,0.15); }
.option-btn.selected .opt-letter { background: var(--gold); color: var(--blue-dark); }
.option-btn.correct { border-color: var(--green); background: rgba(46,204,113,0.15); }
.option-btn.correct .opt-letter { background: var(--green); color: white; }
.option-btn.incorrect { border-color: var(--red); background: rgba(231,76,60,0.12); }
.option-btn.incorrect .opt-letter { background: var(--red); color: white; }
.option-btn.disabled { pointer-events: none; }
.option-btn .opt-text { flex: 1; }

/* Multi-select checkbox style */
.option-btn.multi .opt-letter {
  border-radius: 6px; border: 2px solid rgba(255,255,255,0.2); background: transparent;
}
.option-btn.multi.selected .opt-letter { border-color: var(--gold); background: var(--gold); color: var(--blue-dark); }
.option-btn.multi.selected .opt-letter::after { content: '‚úì'; }
.option-btn.multi.correct .opt-letter { border-color: var(--green); background: var(--green); }
.option-btn.multi.correct .opt-letter::after { content: '‚úì'; }

/* === ORDERING EXERCISE === */
.ordering-list { display: flex; flex-direction: column; gap: 8px; }
.ordering-item {
  background: rgba(0,0,0,0.12); border: 1.5px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm); padding: 12px 16px; cursor: grab;
  display: flex; align-items: center; gap: 12px; transition: var(--transition);
  user-select: none; font-size: 0.88rem; color: var(--white);
}
.ordering-item:active { cursor: grabbing; transform: scale(0.98); background: rgba(0,0,0,0.2); }
.ordering-item .drag-handle { color: rgba(255,255,255,0.5); font-size: 1.1rem; }
.ordering-item .order-num {
  width: 26px; height: 26px; border-radius: 50%; background: rgba(255,255,255,0.12);
  display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
  font-weight: 600; color: var(--gold-bright); flex-shrink: 0;
}
.ordering-item.correct-pos { border-color: var(--green); }
.ordering-item.incorrect-pos { border-color: var(--red); }
.ordering-arrows { display: flex; flex-direction: column; gap: 2px; margin-left: auto; }
.arrow-btn {
  width: 30px; height: 24px; border: none; background: rgba(255,255,255,0.1);
  border-radius: 4px; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 0.8rem;
  display: flex; align-items: center; justify-content: center; transition: var(--transition);
}
.arrow-btn:hover { background: rgba(255,255,255,0.2); color: var(--white); }

/* === MATCHING EXERCISE === */
.matching-grid { display: flex; flex-direction: column; gap: 10px; }
.matching-row {
  display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.12);
  border-radius: var(--radius-sm); padding: 12px; border: 1.5px solid rgba(255,255,255,0.08);
}
.matching-label { flex: 1; font-size: 0.85rem; color: var(--white-dim); line-height: 1.4; }
.matching-select {
  background: rgba(0,0,0,0.2); border: 1.5px solid rgba(255,255,255,0.15);
  border-radius: var(--radius-xs); padding: 8px 12px; color: var(--white);
  font-size: 0.8rem; font-family: var(--font-body); min-width: 120px;
  appearance: none; cursor: pointer;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a8c4d0' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
  padding-right: 28px;
}
.matching-select option { background: var(--bg-card); color: var(--white); }
.matching-row.correct { border-color: var(--green); }
.matching-row.incorrect { border-color: var(--red); }

/* === CLASSIFY EXERCISE === */
.classify-items { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.classify-chip {
  background: rgba(0,0,0,0.1); border: 1.5px solid rgba(255,255,255,0.15);
  border-radius: 20px; padding: 8px 14px; font-size: 0.8rem; cursor: pointer;
  transition: var(--transition); color: var(--white-dim);
}
.classify-chip:hover { border-color: var(--gold); }
.classify-chip.placed { opacity: 0.35; pointer-events: none; }
.classify-chip.correct-chip { border-color: var(--green); background: rgba(46,204,113,0.15); color: var(--green); }
.classify-chip.incorrect-chip { border-color: var(--red); background: rgba(231,76,60,0.12); color: var(--red); }
.classify-zones { display: flex; flex-direction: column; gap: 12px; }
.classify-zone {
  background: rgba(0,0,0,0.08); border: 2px dashed rgba(255,255,255,0.15);
  border-radius: var(--radius-sm); padding: 14px; min-height: 60px;
}
.classify-zone-title { font-size: 0.8rem; color: var(--gold-bright); font-weight: 600; margin-bottom: 8px; }
.classify-zone-items { display: flex; flex-wrap: wrap; gap: 6px; }
.classify-zone-item {
  background: rgba(0,0,0,0.12); border-radius: 16px; padding: 6px 12px;
  font-size: 0.78rem; color: var(--white-dim); cursor: pointer; transition: var(--transition);
}
.classify-zone-item:hover { background: rgba(231,76,60,0.2); }

/* === DIALOGUE EXERCISE === */
.dialogue-bubble {
  max-width: 85%; padding: 14px 16px; border-radius: 16px;
  font-size: 0.88rem; line-height: 1.5; margin-bottom: 12px;
  animation: bubbleIn 0.3s ease-out;
}
.dialogue-bubble.client {
  background: rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.08);
  color: var(--white-dim); margin-right: auto; border-bottom-left-radius: 4px;
}
.dialogue-bubble.client .bubble-name { color: var(--blue-light); font-weight: 600; font-size: 0.75rem; margin-bottom: 4px; }
.dialogue-bubble.therapist {
  background: linear-gradient(135deg, rgba(212,160,23,0.2), rgba(240,192,64,0.1));
  border: 1px solid rgba(212,160,23,0.3); color: var(--white);
  margin-left: auto; border-bottom-right-radius: 4px;
}
.dialogue-bubble.therapist .bubble-name { color: var(--gold-bright); font-weight: 600; font-size: 0.75rem; margin-bottom: 4px; }
.dialogue-choices { margin-top: 16px; }

@keyframes bubbleIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* === FEEDBACK === */
.feedback-box {
  border-radius: var(--radius-sm); padding: 16px; margin-top: 16px;
  animation: fadeIn 0.3s ease-out; font-size: 0.88rem; line-height: 1.6;
}
.feedback-box.correct {
  background: rgba(46,204,113,0.12); border: 1px solid rgba(46,204,113,0.25);
}
.feedback-box.correct .fb-title { color: #5fde9a; font-weight: 600; margin-bottom: 6px; }
.feedback-box.incorrect {
  background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.25);
}
.feedback-box.incorrect .fb-title { color: #f09080; font-weight: 600; margin-bottom: 6px; }
.feedback-box .fb-explanation { color: var(--white-dim); font-size: 0.84rem; }
.feedback-box .fb-process {
  margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08);
  font-size: 0.78rem; color: rgba(255,255,255,0.55); font-style: italic;
}

/* === BUTTONS === */
.btn-primary {
  width: 100%; padding: 14px 24px; border: none; border-radius: var(--radius-sm);
  background: linear-gradient(135deg, var(--blue-bright), var(--blue-mid));
  color: white; font-size: 0.95rem; font-weight: 600; cursor: pointer;
  font-family: var(--font-body); transition: var(--transition);
  box-shadow: 0 4px 16px rgba(33,150,200,0.3);
}
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(33,150,200,0.4); }
.btn-primary:active { transform: scale(0.98); }
.btn-primary.gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-dim));
  box-shadow: 0 4px 16px rgba(240,180,41,0.3);
}
.btn-primary:disabled { opacity: 0.4; pointer-events: none; }

.btn-check {
  width: 100%; padding: 14px 24px; border: 2px solid var(--gold);
  border-radius: var(--radius-sm); background: rgba(212,160,23,0.08);
  color: var(--gold-bright); font-size: 0.95rem; font-weight: 600; cursor: pointer;
  font-family: var(--font-body); transition: var(--transition); margin-top: 16px;
}
.btn-check:hover { background: rgba(212,160,23,0.18); }

/* === LEVEL COMPLETE SCREEN === */
.level-complete {
  text-align: center; padding: 40px 20px;
}
.level-complete .trophy { font-size: 4rem; margin-bottom: 16px; animation: bounce 1s ease infinite; }
.level-complete h2 { font-family: var(--font-display); font-size: 1.5rem; margin-bottom: 8px; color: var(--text-dark); }
.level-complete .score { color: var(--gold-dim); font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
.level-complete .message { color: var(--text-mid); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.5; }

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* === FEEDBACK FORM === */
.feedback-section {
  background: rgba(27,94,123,0.08); border-radius: var(--radius); padding: 24px 20px;
  border: 1px solid rgba(27,94,123,0.12); margin: 24px 0 40px;
}
.feedback-section h3 {
  font-family: var(--font-display); font-size: 1.1rem; margin-bottom: 4px; color: var(--text-dark);
}
.feedback-section p { color: var(--text-mid); font-size: 0.8rem; margin-bottom: 16px; }
.feedback-section textarea {
  width: 100%; min-height: 100px; background: white;
  border: 1.5px solid rgba(27,94,123,0.2); border-radius: var(--radius-sm);
  padding: 12px; color: var(--text-dark); font-family: var(--font-body); font-size: 0.88rem;
  resize: vertical; margin-bottom: 12px;
}
.feedback-section textarea:focus { outline: none; border-color: var(--blue-bright); }
.feedback-section textarea::placeholder { color: #8aabb8; }
.feedback-section .btn-send {
  padding: 10px 24px; border: none; border-radius: var(--radius-sm);
  background: var(--bg-card); color: var(--white); font-size: 0.85rem;
  font-weight: 500; cursor: pointer; font-family: var(--font-body); transition: var(--transition);
}
.feedback-section .btn-send:hover { background: var(--bg-card-hover); }
.feedback-section .send-ok { color: var(--green); font-size: 0.85rem; display: none; margin-top: 8px; }

/* === FOOTER === */
.footer {
  text-align: center; padding: 24px 0 40px; color: var(--text-mid); font-size: 0.75rem;
}
.footer a { color: var(--blue-mid); text-decoration: none; }
.footer a:hover { text-decoration: underline; }

/* === ANIMATIONS === */
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
.anim-fade-in { animation: fadeIn 0.5s ease-out; }
.anim-fade-up { animation: fadeInUp 0.5s ease-out; }
.anim-slide-in { animation: slideInRight 0.4s ease-out; }

/* === SCROLLBAR === */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(27,94,123,0.3); border-radius: 2px; }

/* === CONFETTI CANVAS === */
#confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }

/* Intro concept box */
.concept-box {
  background: rgba(27,94,123,0.06); 
  border: 1px solid rgba(27,94,123,0.18); border-radius: var(--radius-sm);
  padding: 16px; margin-bottom: 20px;
}
.concept-box h4 { color: var(--blue-dark); font-size: 0.85rem; margin-bottom: 6px; font-weight: 700; }
.concept-box p { color: var(--text-dark); font-size: 0.82rem; line-height: 1.5; }

/* === GLOSSARY TOOLTIPS === */
.glossary-term {
  color: var(--gold-bright); border-bottom: 1.5px dotted var(--gold-bright);
  cursor: help; position: relative; font-weight: 500;
  transition: color 0.2s;
}
.concept-box .glossary-term { color: var(--gold-dim); border-bottom-color: var(--gold-dim); }
.glossary-tooltip {
  position: fixed; z-index: 200; max-width: 320px; width: 90vw;
  background: #0e3d54; color: var(--white); border-radius: var(--radius-sm);
  padding: 14px 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.35);
  font-size: 0.82rem; line-height: 1.55; pointer-events: auto;
  animation: tooltipIn 0.2s ease-out;
  border: 1px solid rgba(255,255,255,0.1);
}
.glossary-tooltip::before {
  content: ''; position: absolute; top: -6px; left: 20px;
  width: 12px; height: 12px; background: #0e3d54;
  transform: rotate(45deg); border-left: 1px solid rgba(255,255,255,0.1);
  border-top: 1px solid rgba(255,255,255,0.1);
}
.glossary-tooltip.above::before {
  top: auto; bottom: -6px;
  border-left: none; border-top: none;
  border-right: 1px solid rgba(255,255,255,0.1);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.glossary-tooltip .gt-title {
  font-weight: 700; color: var(--gold-bright); font-size: 0.85rem; margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}
.glossary-tooltip .gt-title::before { content: 'üìñ'; font-size: 0.9rem; }
.glossary-tooltip .gt-def { margin-bottom: 8px; color: rgba(255,255,255,0.85); }
.glossary-tooltip .gt-example {
  background: rgba(255,255,255,0.08); border-radius: 6px; padding: 8px 10px;
  font-size: 0.78rem; color: rgba(255,255,255,0.7); font-style: italic;
}
.glossary-tooltip .gt-example::before { content: 'Ej: '; font-style: normal; font-weight: 600; color: var(--gold-bright); }
.glossary-tooltip .gt-close {
  position: absolute; top: 8px; right: 10px; background: none; border: none;
  color: rgba(255,255,255,0.4); font-size: 1.1rem; cursor: pointer; padding: 2px 6px;
}
.glossary-tooltip .gt-close:hover { color: var(--white); }
.glossary-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 199; background: transparent;
}
@keyframes tooltipIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Sandbox textarea */
.sandbox-area {
  width: 100%; min-height: 80px; background: rgba(0,0,0,0.12);
  border: 1.5px solid rgba(255,255,255,0.12); border-radius: var(--radius-sm);
  padding: 12px; color: var(--white); font-family: var(--font-body); font-size: 0.88rem;
  resize: vertical; margin-bottom: 4px;
}
.sandbox-area:focus { outline: none; border-color: var(--gold); }
.sandbox-area::placeholder { color: rgba(255,255,255,0.4); }
.sandbox-hint { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 12px; }

/* Reset button */
.btn-reset {
  display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
  background: rgba(231,76,60,0.1); border: 1px solid rgba(231,76,60,0.2);
  border-radius: var(--radius-xs); color: var(--red); font-size: 0.78rem;
  cursor: pointer; font-family: var(--font-body); transition: var(--transition);
  margin-top: 12px;
}
.btn-reset:hover { background: rgba(231,76,60,0.15); }
</style>
</head>
<body>

<div class="bg-ambient">
  <div class="bg-line"></div>
  <div class="bg-line"></div>
  <div class="bg-line"></div>
  <div class="bg-line"></div>
  <div class="bg-circle"></div>
  <div class="bg-circle"></div>
  <div class="bg-circle"></div>
</div>

<canvas id="confetti"></canvas>

<div class="app-container">

  <!-- ========== HOME VIEW ========== -->
  <div id="homeView" class="view active">
    <div class="header">
      <h1>Entrenamiento en Defusi√≥n Cognitiva</h1>
      <p>Ejercicios progresivos para psicoterapeutas ¬∑ Basado en ACT & RFT</p>
    </div>

    <div class="global-progress">
      <div class="global-progress-bar"><div class="global-progress-fill" id="globalFill" style="width:0%"></div></div>
      <div class="global-progress-text" id="globalText">0 / 34</div>
    </div>

    <div class="levels-grid" id="levelsGrid"></div>

    <!-- Feedback form -->
    <div class="feedback-section">
      <h3>üí¨ ¬øSugerencias?</h3>
      <p>Tu opini√≥n ayuda a mejorar estos ejercicios. Totalmente opcional.</p>
      <form id="feedbackForm" action="https://formspree.io/f/xbdadlnz" method="POST">
        <textarea name="message" placeholder="¬øQu√© mejorar√≠as? ¬øAlg√∫n ejercicio confuso? ¬øIdeas para nuevos ejercicios?"></textarea>
        <input type="hidden" name="_subject" value="Feedback - Entrenamiento Defusi√≥n">
        <button type="submit" class="btn-send">Enviar sugerencia</button>
        <div class="send-ok" id="sendOk">‚úì ¬°Gracias por tu feedback!</div>
      </form>
    </div>

    <div class="footer">
      <p>Creado por <a href="https://www.instagram.com/leo.eyzaguirre" target="_blank">@leo.eyzaguirre</a></p>
      <p style="margin-top:4px;">Basado en Assaz et al. (2018), Snyder et al. (2011), Dixon, Hayes & Belisle (2023),<br>Wilson & Luciano, Harte & Barnes-Holmes (2023)</p>
    </div>

    <button class="btn-reset" id="btnResetAll" style="margin: 0 auto 30px; display:flex;">
      ‚Ü∫ Reiniciar todo el progreso
    </button>
  </div>

  <!-- ========== EXERCISE VIEW ========== -->
  <div id="exerciseView" class="view">
    <div class="exercise-header">
      <button class="btn-back" id="btnBack">‚Üê</button>
      <div class="exercise-header-info">
        <div class="level-num" id="exLevelName"></div>
        <div class="ex-title" id="exTitle"></div>
      </div>
      <div class="exercise-counter" id="exCounter"></div>
    </div>
    <div class="exercise-progress-mini" id="exDots"></div>
    <div id="exerciseContent"></div>
    <div id="exerciseActions" style="margin-top:20px; padding-bottom:40px;"></div>
  </div>

  <!-- ========== LEVEL COMPLETE VIEW ========== -->
  <div id="completeView" class="view">
    <div class="level-complete">
      <div class="trophy">üèÜ</div>
      <h2 id="completeTitle"></h2>
      <div class="score" id="completeScore"></div>
      <div class="message" id="completeMsg"></div>
      <button class="btn-primary gold" id="btnNextLevel" style="margin-bottom:12px;"></button>
      <button class="btn-primary" id="btnRetry" style="background:var(--bg-card); box-shadow:var(--shadow-sm);">Repetir nivel</button>
      <br>
      <button class="btn-primary" id="btnGoHome" style="background:rgba(27,94,123,0.08); box-shadow:none; border:1px solid rgba(27,94,123,0.2); color:var(--text-dark); margin-top:12px;">Volver al inicio</button>
    </div>
  </div>

</div>

<script>
// ============================================================
// DATA: All 36 exercises organized by level
// ============================================================
const LEVELS = [
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NIVEL 1: RECONOCER LA FUSI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  id: 'nivel1', title: 'Reconocer la Fusi√≥n', icon: 'üëÅÔ∏è',
  subtitle: 'Aprende a identificar cu√°ndo un pensamiento controla la conducta',
  concept: {
    title: '¬øQu√© es la fusi√≥n cognitiva?',
    text: 'La fusi√≥n ocurre cuando un pensamiento domina la conducta de la persona como si fuera literalmente verdadero, sin que se discrimine entre el pensamiento y el evento al que refiere. La persona act√∫a "dentro" del pensamiento, no "observ√°ndolo". La funci√≥n del est√≠mulo verbal (Cfunc) domina sobre la relaci√≥n derivada (Crel).'
  },
  exercises: [
  {
    title: '¬øFusi√≥n o no fusi√≥n?',
    type: 'single',
    scenario: 'Mar√≠a piensa <em>"soy una mala madre"</em>. Deja de asistir a las reuniones de la escuela de su hija, se a√≠sla de otras madres y deja de proponer actividades familiares.',
    instruction: '¬øEste escenario describe fusi√≥n cognitiva?',
    options: [
      { text: 'S√≠, hay fusi√≥n ‚Äî el pensamiento est√° controlando directamente su conducta como si fuera un hecho literal', correct: true },
      { text: 'No hay fusi√≥n ‚Äî simplemente est√° deprimida', correct: false },
      { text: 'No hay fusi√≥n ‚Äî es una evaluaci√≥n realista de su desempe√±o', correct: false },
      { text: 'S√≠, hay fusi√≥n ‚Äî porque el pensamiento es negativo', correct: false }
    ],
    feedback: {
      correct: '¬°Exacto! La clave de la fusi√≥n no es que el pensamiento sea negativo, sino que est√° funcionando como regulador directo de la conducta. Mar√≠a act√∫a como si literalmente FUERA una mala madre, y toda su conducta se organiza en torno a eso.',
      incorrect: 'La fusi√≥n no se define por si el pensamiento es negativo o si la persona est√° deprimida. Se define por la relaci√≥n funcional: el pensamiento "soy mala madre" est√° controlando directamente la conducta de Mar√≠a (evitar reuniones, aislarse) como si fuera un hecho literal.',
      process: 'Proceso: La Cfunc (funci√≥n conductual) del pensamiento domina ‚Äî la relaci√≥n verbal transforma las funciones de est√≠mulo de las situaciones sociales en aversivas.'
    }
  },
  {
    title: 'Detectar la regla verbal',
    type: 'single',
    scenario: 'Carlos dice: <em>"Si voy a la fiesta, seguro que me pongo nervioso y todos se van a dar cuenta. Mejor me quedo en casa."</em>',
    instruction: '¬øCu√°l es la regla verbal que est√° operando?',
    options: [
      { text: '"Si situaci√≥n social ‚Üí ansiedad visible ‚Üí rechazo social", por lo tanto evitar', correct: true },
      { text: '"Las fiestas son peligrosas"', correct: false },
      { text: '"Soy introvertido y prefiero estar solo"', correct: false },
      { text: '"La gente siempre me juzga"', correct: false }
    ],
    feedback: {
      correct: 'Correcto. La regla verbal tiene estructura condicional: SI (fiesta) ‚Üí ENTONCES (nervios + ser descubierto) ‚Üí MEJOR (evitar). Es una regla de tipo augmental que amplifica las funciones aversivas de la situaci√≥n a trav√©s de la transformaci√≥n de funciones.',
      incorrect: 'Las otras opciones son pensamientos posibles, pero la regla verbal que controla la conducta es la cadena completa: "si voy ‚Üí me pondr√© nervioso ‚Üí se dar√°n cuenta ‚Üí mejor me quedo". Esta estructura condicional es lo que regula la evitaci√≥n.',
      process: 'Proceso: Comportamiento gobernado por reglas (rule-governed behavior). La regla verbal especifica contingencias que no est√°n presentes y transforma las funciones del est√≠mulo "fiesta".'
    }
  },
  {
    title: '¬øCu√°l es la funci√≥n del pensamiento?',
    type: 'single',
    scenario: 'Andrea repite internamente <em>"no puedo con esto, no puedo con esto"</em> antes de cada examen. Estudia compulsivamente 16 horas al d√≠a, revisa una y otra vez los mismos temas, y a√∫n as√≠ siente que no es suficiente.',
    instruction: '¬øQu√© funci√≥n cumple este pensamiento fusionado en la conducta de Andrea?',
    options: [
      { text: 'Funciona como un augmental motivacional ‚Äî amplifica la urgencia de estudiar m√°s como forma de evitar el resultado temido', correct: true },
      { text: 'Funciona como una descripci√≥n precisa de su capacidad cognitiva', correct: false },
      { text: 'Funciona como un pliance ‚Äî ella obedece lo que otros le dijeron', correct: false },
      { text: 'No cumple ninguna funci√≥n particular, es solo un s√≠ntoma de ansiedad', correct: false }
    ],
    feedback: {
      correct: 'Bien. "No puedo con esto" funciona como un augmental: transforma las funciones del est√≠mulo (el examen) amplificando sus propiedades aversivas, lo que incrementa la conducta de estudio compulsivo como forma de escape de la experiencia aversiva anticipada.',
      incorrect: 'El pensamiento "no puedo con esto" no es solo un s√≠ntoma ni una descripci√≥n. Cumple una funci√≥n conductual espec√≠fica: amplifica las funciones aversivas del examen (augmental) y mantiene la conducta de estudio compulsivo como operante de escape.',
      process: 'Proceso: Augmental ‚Äî un tipo de regla verbal que altera las funciones reforzantes/aversivas de los est√≠mulos a trav√©s de la transformaci√≥n de funciones de est√≠mulo.'
    }
  },
  {
    title: 'Fusi√≥n vs. pensamiento observado',
    type: 'classify',
    instruction: 'Clasifica cada ejemplo como FUSI√ìN (el pensamiento controla la conducta) o DEFUSI√ìN (la persona observa el pensamiento sin que domine su acci√≥n):',
    categories: ['Fusi√≥n', 'Defusi√≥n'],
    items: [
      { text: '"Me siento in√∫til" ‚Üí deja de buscar trabajo', cat: 0 },
      { text: '"Ah√≠ viene otra vez el pensamiento de que no sirvo" ‚Üí sigue con su tarea', cat: 1 },
      { text: '"Mi mente me dice que todo va a salir mal" ‚Üí lo nota y elige actuar seg√∫n sus valores', cat: 1 },
      { text: '"Esto es demasiado para m√≠" ‚Üí cancela todos sus compromisos', cat: 0 },
      { text: '"Nadie me quiere" ‚Üí llama a un amigo para verificar si es verdad', cat: 0 },
      { text: '"Noto que estoy teniendo pensamientos de que nadie me quiere" ‚Üí sigue con su d√≠a', cat: 1 }
    ],
    feedback: {
      correct: 'Excelente. La clave est√° en si la persona act√∫a DESDE el pensamiento (fusi√≥n) o si lo OBSERVA sin que controle su conducta (defusi√≥n). Nota que en el quinto ejemplo, aunque la persona "verifica", sigue regulada por el pensamiento ‚Äî eso es fusi√≥n.',
      incorrect: 'Revisa: la fusi√≥n se detecta cuando la conducta est√° directamente controlada por el contenido literal del pensamiento. La defusi√≥n aparece cuando hay un paso de observaci√≥n ("noto que...", "mi mente dice...") y la conducta sigue orientada por valores, no por el pensamiento.',
      process: 'Proceso: Dominancia de Cfunc (fusi√≥n) vs. dominancia de Crel (defusi√≥n). En la defusi√≥n, la persona discrimina la relaci√≥n derivada como relaci√≥n, no como realidad literal.'
    }
  },
  {
    title: 'Niveles de fusi√≥n',
    type: 'ordering',
    instruction: 'Ordena estos escenarios de MENOR a MAYOR nivel de fusi√≥n cognitiva:',
    items: [
      { text: '"Noto que mi mente est√° generando el pensamiento de que soy un fracaso" ‚Äî contin√∫a trabajando', order: 1 },
      { text: '"A veces pienso que soy un fracaso, pero no siempre es as√≠" ‚Äî busca evidencia a favor y en contra', order: 2 },
      { text: '"Soy un fracaso" ‚Äî evita nuevos proyectos por miedo a confirmar el pensamiento', order: 3 },
      { text: '"Soy un fracaso y siempre lo ser√©" ‚Äî deja su trabajo y se a√≠sla completamente', order: 4 }
    ],
    feedback: {
      correct: 'Perfecto. De menor a mayor fusi√≥n: (1) Observaci√≥n con distancia funcional, (2) Evaluaci√≥n parcial a√∫n fusionada (buscar evidencia = el pensamiento sigue regulando), (3) Evitaci√≥n gobernada por el pensamiento, (4) Fusi√≥n total con generalizaci√≥n y rigidez conductual.',
      incorrect: 'El orden correcto va desde la observaci√≥n distanciada (m√≠nima fusi√≥n) hasta la rigidez conductual total (m√°xima fusi√≥n). Nota que "buscar evidencia" a√∫n implica fusi√≥n parcial, porque la conducta sigue regulada por el contenido del pensamiento.',
      process: 'Proceso: La "masa" relacional (Dixon et al., 2023). A mayor fusi√≥n, mayor resistencia al cambio y mayor impacto en la conducta ‚Äî como un objeto con m√°s masa, requiere m√°s fuerza disruptiva para cambiar.'
    }
  },
  {
    title: '¬øQu√© hace que la fusi√≥n se mantenga?',
    type: 'multi',
    instruction: 'Selecciona TODOS los factores que contribuyen al mantenimiento de la fusi√≥n cognitiva:',
    options: [
      { text: 'Reforzamiento negativo: evitar situaciones aversivas producido por obedecer al pensamiento', correct: true },
      { text: 'Coherencia verbal: la red relacional se auto-confirma (si pienso X, entonces Y "tiene sentido")', correct: true },
      { text: 'Ausencia de contextos que promuevan Crel sobre Cfunc', correct: true },
      { text: 'La persona tiene poca inteligencia verbal', correct: false },
      { text: 'Derivaci√≥n relacional que transforma las funciones de est√≠mulos presentes a trav√©s de marcos temporales y causales', correct: true },
      { text: 'La persona elige conscientemente creer en sus pensamientos', correct: false }
    ],
    feedback: {
      correct: '¬°Muy bien! La fusi√≥n se mantiene por m√∫ltiples procesos: reforzamiento negativo de la evitaci√≥n, coherencia de la red relacional, ausencia de contextos que promuevan discriminaci√≥n relacional (Crel), y la transformaci√≥n de funciones a trav√©s de marcos de relaci√≥n.',
      incorrect: 'La fusi√≥n no tiene que ver con inteligencia ni con elecci√≥n consciente. Se mantiene por procesos conductuales: reforzamiento negativo, coherencia verbal (las redes de relaci√≥n son auto-confirmantes), falta de contextos que promuevan discriminaci√≥n, y la propia transformaci√≥n de funciones.',
      process: 'Proceso: Desde RFT, la fusi√≥n es el producto natural del lenguaje ‚Äî la transformaci√≥n de funciones (Cfunc) es la operaci√≥n por defecto. La defusi√≥n requiere contextos espec√≠ficos que promuevan la discriminaci√≥n de Crel.'
    }
  },
  {
    title: 'Sandbox: Tu propio ejemplo',
    type: 'sandbox',
    instruction: 'Piensa en un caso cl√≠nico (real o hipot√©tico). Describe brevemente: (1) el pensamiento fusionado, (2) la conducta que produce, y (3) qu√© tipo de regla verbal opera. Este ejercicio es para tu reflexi√≥n ‚Äî no se califica.',
    placeholder: 'Ej: "Mi paciente piensa ¬´si pido ayuda es se√±al de debilidad¬ª. Esto funciona como un pliance derivado de su contexto familiar. La conducta resultante es..."',
    reflection: 'Reflexiona: ¬øPudiste identificar la regla verbal? ¬øEs un pliance, tracking, o augmental? ¬øQu√© funciones del est√≠mulo se transforman? En los siguientes niveles aprender√°s qu√© hacer con esta fusi√≥n.'
  }
  ]
},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NIVEL 2: T√âCNICAS DE DEBILITAMIENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  id: 'nivel2', title: 'T√©cnicas de Debilitamiento', icon: 'üîß',
  subtitle: 'Practica t√©cnicas que reducen el impacto literal del pensamiento',
  concept: {
    title: 'El principio del debilitamiento',
    text: 'Las t√©cnicas de defusi√≥n no cambian el contenido del pensamiento. Cambian la funci√≥n que el pensamiento tiene sobre la conducta. Seg√∫n Assaz et al. (2018), operan por al menos 4 procesos: extinci√≥n respondiente, reforzamiento diferencial, recontextualizaci√≥n narrativa, y distanciamiento espacial.'
  },
  exercises: [
  {
    title: 'Repetici√≥n de palabra: ¬øqu√© proceso opera?',
    type: 'single',
    scenario: 'La t√©cnica cl√°sica de Titchener: el terapeuta pide al cliente que repita la palabra <em>"lim√≥n"</em> r√°pidamente durante 30-60 segundos. Despu√©s de repetirla muchas veces, la palabra pierde su capacidad de evocar la imagen, el sabor y la sensaci√≥n del lim√≥n real.',
    instruction: '¬øQu√© proceso conductual explica principalmente este efecto?',
    options: [
      { text: 'Extinci√≥n respondiente: la exposici√≥n repetida al est√≠mulo verbal sin el referente debilita la respuesta condicionada', correct: true },
      { text: 'Castigo positivo: la repetici√≥n se vuelve aversiva', correct: false },
      { text: 'Habituaci√≥n sensorial: el o√≠do se acostumbra al sonido', correct: false },
      { text: 'Reestructuraci√≥n cognitiva: la persona cambia lo que piensa sobre la palabra', correct: false }
    ],
    feedback: {
      correct: 'Correcto. La repetici√≥n r√°pida funciona como un procedimiento de extinci√≥n respondiente. El est√≠mulo verbal (la palabra) se presenta repetidamente sin las funciones del referente (el lim√≥n real), debilitando la transformaci√≥n de funciones. La palabra se convierte en "solo un sonido".',
      incorrect: 'No es habituaci√≥n ni castigo. El proceso es extinci√≥n respondiente: la palabra "lim√≥n" normalmente evoca funciones del lim√≥n real (sabor, imagen) por transformaci√≥n de funciones. Al repetirla sin el referente, esa relaci√≥n se debilita temporalmente.',
      process: 'Proceso: Extinci√≥n respondiente/contracondicionamiento (Assaz et al., 2018). Se debilita la transformaci√≥n de funciones de est√≠mulo derivada de marcos de coordinaci√≥n.'
    }
  },
  {
    title: '¬øCu√°ndo usar cada t√©cnica?',
    type: 'matching',
    instruction: 'Conecta cada t√©cnica con el proceso conductual que la sustenta:',
    pairs: [
      { left: 'Repetir el pensamiento r√°pidamente 30 segundos', right: 'Extinci√≥n respondiente' },
      { left: '"Estoy teniendo el pensamiento de que..."', right: 'Autocl√≠tico descriptivo (recontextualizaci√≥n)' },
      { left: 'Cantar el pensamiento con melod√≠a de cumplea√±os', right: 'Extinci√≥n + contracondicionamiento' },
      { left: 'Visualizar pensamientos como hojas en un r√≠o', right: 'Distanciamiento espacial' },
      { left: 'Notar el pensamiento y elegir actuar seg√∫n valores', right: 'Reforzamiento diferencial' }
    ],
    feedback: {
      correct: 'Excelente mapeo. Cada t√©cnica de defusi√≥n opera por un proceso conductual distinto. Saber esto te permite elegir la t√©cnica seg√∫n el an√°lisis funcional del caso, no por costumbre o preferencia.',
      incorrect: 'Revisa las conexiones: la repetici√≥n opera por extinci√≥n respondiente, los prefijos ("estoy teniendo el pensamiento...") son autocl√≠ticos descriptivos que recontextualizan, cantar combina extinci√≥n con contracondicionamiento (la melod√≠a evoca funciones incompatibles), las met√°foras visuales generan distanciamiento espacial, y actuar seg√∫n valores pese al pensamiento es reforzamiento diferencial de conducta no-fusionada.',
      process: 'Proceso: Los 4 procesos de Assaz et al. (2018): extinci√≥n/contracondicionamiento, reforzamiento diferencial, recontextualizaci√≥n narrativa (autocl√≠ticos), distanciamiento espacial.'
    }
  },
  {
    title: 'El prefijo de defusi√≥n',
    type: 'single',
    scenario: 'Un cliente dice: <em>"Soy un fracaso total"</em>. El terapeuta le pide que reformule usando el prefijo de defusi√≥n.',
    instruction: '¬øCu√°l es la reformulaci√≥n m√°s efectiva para promover defusi√≥n?',
    options: [
      { text: '"Estoy notando que tengo el pensamiento de que soy un fracaso total"', correct: true },
      { text: '"No soy un fracaso, tengo muchas cualidades positivas"', correct: false },
      { text: '"Tal vez soy un fracaso, tal vez no"', correct: false },
      { text: '"Mi terapeuta me dice que no piense eso"', correct: false }
    ],
    feedback: {
      correct: 'Exacto. "Estoy notando que tengo el pensamiento de que..." es un autocl√≠tico descriptivo. No cambia el contenido del pensamiento, pero altera el contexto funcional: ahora la persona est√° en relaci√≥n de observaci√≥n CON el pensamiento, en lugar de estar DENTRO de √©l.',
      incorrect: 'Las otras opciones son reestructuraci√≥n cognitiva (cambiar el contenido), relativismo verbal, o pliance. La defusi√≥n no busca cambiar el pensamiento sino la relaci√≥n funcional con √©l. El autocl√≠tico "estoy notando que tengo el pensamiento de que..." mantiene el contenido intacto pero cambia el marco relacional.',
      process: 'Proceso: Recontextualizaci√≥n narrativa a trav√©s de autocl√≠ticos descriptivos (Assaz et al., 2018). Se introduce un marco de√≠ctico (yo-aqu√≠-ahora observando el pensamiento) que promueve Crel sobre Cfunc.'
    }
  },
  {
    title: 'Cantar el pensamiento: ¬øpor qu√© funciona?',
    type: 'multi',
    instruction: 'El cliente canta "soy un perdedor" con la melod√≠a de "Feliz Cumplea√±os". ¬øQu√© procesos operan? Selecciona TODOS los que aplican:',
    options: [
      { text: 'Contracondicionamiento: la melod√≠a alegre evoca funciones incompatibles con las funciones aversivas del pensamiento', correct: true },
      { text: 'Extinci√≥n respondiente: la repetici√≥n en contexto nuevo debilita la transformaci√≥n de funciones original', correct: true },
      { text: 'Distracci√≥n: el cliente deja de pensar en el contenido', correct: false },
      { text: 'Cambio de contexto funcional: el pensamiento aparece en un marco de coordinaci√≥n con "juego/humor" en lugar de "evaluaci√≥n literal"', correct: true },
      { text: 'Supresi√≥n del pensamiento: cantar evita que aparezca el pensamiento', correct: false }
    ],
    feedback: {
      correct: 'Correcto. Cantar el pensamiento combina extinci√≥n respondiente, contracondicionamiento (funciones incompatibles de la melod√≠a alegre), y cambio de contexto funcional. No es distracci√≥n ni supresi√≥n ‚Äî el contenido del pensamiento permanece intacto.',
      incorrect: 'Cantar el pensamiento no es distracci√≥n ni supresi√≥n. El contenido permanece id√©ntico ("soy un perdedor"). Lo que cambia es: (1) la transformaci√≥n de funciones se debilita por repetici√≥n, (2) las funciones alegres de la melod√≠a son incompatibles con las aversivas, (3) el contexto funcional cambia de "evaluaci√≥n seria" a "juego verbal".',
      process: 'Proceso: Extinci√≥n + contracondicionamiento + cambio de contexto funcional. Como se√±ala Dixon et al. (2023): "no cambiamos el pensamiento, cambiamos c√≥mo interactuamos con √©l".'
    }
  },
  {
    title: 'Agradecer a la mente',
    type: 'single',
    scenario: 'El cliente reporta: <em>"Mi mente no para de decirme que todo va a salir mal"</em>. El terapeuta responde: <em>"Ah, interesante. ¬øPuedes agradecerle a tu mente por ese aviso? Algo como: Gracias, mente, por tratar de protegerme. Lo noto."</em>',
    instruction: '¬øQu√© funci√≥n cl√≠nica cumple "agradecer a la mente"?',
    options: [
      { text: 'Introduce un marco de√≠ctico (yo vs. mente) y de perspectiva que promueve la observaci√≥n del proceso verbal como proceso, sin luchar contra √©l', correct: true },
      { text: 'Reduce la ansiedad mediante pensamiento positivo', correct: false },
      { text: 'Refuerza el pensamiento negativo al validarlo', correct: false },
      { text: 'Es una t√©cnica de reestructuraci√≥n cognitiva encubierta', correct: false }
    ],
    feedback: {
      correct: 'Exacto. "Agradecer a la mente" crea una distinci√≥n funcional entre el yo-como-contexto y el contenido verbal. El marco de√≠ctico (yo ‚â† mi mente) permite que la persona observe el proceso verbal sin fusionarse con √©l. Adem√°s, el "gracias" evita la lucha contra el pensamiento.',
      incorrect: 'No es pensamiento positivo ni reestructuraci√≥n. El pensamiento sigue siendo "todo va a salir mal". Lo que cambia es el contexto relacional: se introduce una perspectiva del yo que observa a "la mente" como algo que produce contenidos, no como fuente de verdad literal.',
      process: 'Proceso: Marco de√≠ctico + distanciamiento funcional. Se promueve el yo-como-contexto (self-as-context) y la dominancia de Crel: la persona responde a la relaci√≥n (la mente produce pensamientos) en lugar del contenido (todo va a salir mal).'
    }
  },
  {
    title: 'Etiquetar el proceso',
    type: 'single',
    scenario: 'El cliente comienza a explicar por qu√© no puede ir a la entrevista de trabajo: <em>"Es que no tiene sentido, yo nunca voy a conseguir nada bueno, siempre me sale todo mal, adem√°s la econom√≠a est√° terrible y..."</em>',
    instruction: 'Como terapeuta ACT, ¬øcu√°l ser√≠a la intervenci√≥n de defusi√≥n m√°s apropiada en este momento?',
    options: [
      { text: '"Noto que tu mente se acaba de poner muy activa dando razones. ¬øPuedes notar eso conmigo? Tu mente est√° haciendo su trabajo de dar razones."', correct: true },
      { text: '"Tienes raz√≥n, la econom√≠a est√° dif√≠cil, pero no pierdas la esperanza."', correct: false },
      { text: '"Esas son distorsiones cognitivas. Est√°s catastrofizando y generalizando."', correct: false },
      { text: '"No te preocupes, todo va a salir bien."', correct: false }
    ],
    feedback: {
      correct: 'Perfecto. Etiquetar el proceso ("tu mente est√° dando razones") es una intervenci√≥n de defusi√≥n que: (1) distingue al cliente de su mente, (2) describe el PROCESO verbal (dar razones) en lugar de discutir el CONTENIDO, y (3) no invalida ni pelea con el pensamiento.',
      incorrect: 'Las otras opciones entran en el contenido (dar la raz√≥n, corregir distorsiones, o tranquilizar). La defusi√≥n no discute si los pensamientos son verdaderos o falsos. Etiquetar el proceso ("la mente dando razones") promueve discriminaci√≥n del comportamiento verbal como comportamiento, no como verdad.',
      process: 'Proceso: Recontextualizaci√≥n narrativa. Se establece un contexto funcional donde el comportamiento verbal es observado como proceso (dar razones) en lugar de tomado como descripci√≥n literal de la realidad.'
    }
  },
  {
    title: 'Sandbox: Practica la t√©cnica',
    type: 'sandbox',
    instruction: 'Elige un pensamiento dif√≠cil (tuyo o de un caso cl√≠nico). Escr√≠belo y luego aplica 3 t√©cnicas diferentes: (1) el prefijo de defusi√≥n, (2) agradecerle a la mente, (3) etiquetar el proceso. Observa qu√© cambia en cada caso.',
    placeholder: 'Pensamiento: "___"\n\n1. Prefijo: "Estoy notando que tengo el pensamiento de que..."\n2. Agradecer: "Gracias, mente, por..."\n3. Etiquetar: "Mi mente est√° haciendo el trabajo de..."',
    reflection: '¬øNotaste c√≥mo cada t√©cnica cambia algo distinto? El prefijo introduce un marco de√≠ctico, agradecer reduce la lucha, etiquetar promueve discriminaci√≥n del proceso. En la pr√°ctica cl√≠nica, combinar t√©cnicas seg√∫n el an√°lisis funcional es m√°s poderoso que usar una sola.'
  }
  ]
},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NIVEL 3: MET√ÅFORAS Y RECONTEXTUALIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  id: 'nivel3', title: 'Met√°foras y Recontextualizaci√≥n', icon: 'üåä',
  subtitle: 'Domina las met√°foras cl√≠nicas y aprende cu√°ndo aplicar cada una',
  concept: {
    title: 'El poder de las met√°foras en defusi√≥n',
    text: 'Las met√°foras en ACT no son "ilustraciones". Son intervenciones que establecen marcos de relaci√≥n alternativos a los que mantienen la fusi√≥n. Cada met√°fora genera un contexto relacional espec√≠fico (marcos de√≠cticos, jer√°rquicos, espaciales) que compite funcionalmente con la red relacional fusionada.'
  },
  exercises: [
  {
    title: 'Los Pasajeros del Autob√∫s',
    type: 'single',
    scenario: 'En la met√°fora de los Pasajeros del Autob√∫s (Hayes et al., 1999), t√∫ eres el conductor y los pensamientos/emociones son pasajeros que gritan amenazas. Los pasajeros dicen <em>"¬°Para el autob√∫s! ¬°Da la vuelta! ¬°No sigas por ah√≠!"</em>. La clave es que puedes seguir conduciendo en tu direcci√≥n elegida aunque los pasajeros griten.',
    instruction: '¬øQu√© funci√≥n cl√≠nica cumple esta met√°fora?',
    options: [
      { text: 'Establece un marco jer√°rquico (yo > pensamientos) y de√≠ctico (yo ‚â† pensamientos) donde la persona discrimina que puede actuar seg√∫n valores aunque est√©n presentes los eventos privados aversivos', correct: true },
      { text: 'Ense√±a que los pensamientos no son reales', correct: false },
      { text: 'Promueve la supresi√≥n de los pensamientos molestos', correct: false },
      { text: 'Genera distracci√≥n para no pensar en los problemas', correct: false }
    ],
    feedback: {
      correct: 'Exacto. La met√°fora establece: (1) Marco jer√°rquico: t√∫ contienes a los pasajeros, no al rev√©s; (2) Marco de√≠ctico: t√∫ ‚â† los pensamientos; (3) Contexto de disposici√≥n: puedes seguir en la direcci√≥n valiosa MIENTRAS los pensamientos est√°n presentes. No se trata de eliminarlos.',
      incorrect: 'Los pasajeros (pensamientos) siguen en el autob√∫s ‚Äî no se eliminan ni se distraen. La met√°fora establece una relaci√≥n jer√°rquica y de√≠ctica donde la persona discrimina que puede actuar seg√∫n sus valores con los pensamientos presentes, no contra ellos.',
      process: 'Proceso: Marco jer√°rquico + de√≠ctico + distanciamiento funcional. Promueve disposici√≥n (willingness) como alternativa a la evitaci√≥n experiencial.'
    }
  },
  {
    title: 'Hojas en el R√≠o',
    type: 'single',
    scenario: 'En este ejercicio de mindfulness, el cliente visualiza un arroyo con hojas flotando. Cada pensamiento o sensaci√≥n que aparece se "coloca" sobre una hoja y se observa alejarse con la corriente, sin agarrarlo ni empujarlo.',
    instruction: '¬øQu√© proceso de defusi√≥n opera principalmente en este ejercicio?',
    options: [
      { text: 'Distanciamiento espacial: se crea una relaci√≥n de marco espacial (yo-aqu√≠ observando, pensamiento-all√° flotando) que reduce la dominancia de Cfunc', correct: true },
      { text: 'Extinci√≥n respondiente como en la repetici√≥n de palabra', correct: false },
      { text: 'Reforzamiento positivo de la relajaci√≥n', correct: false },
      { text: 'Reestructuraci√≥n del contenido cognitivo', correct: false }
    ],
    feedback: {
      correct: 'Correcto. Hojas en el r√≠o opera por distanciamiento espacial (Assaz et al., 2018). Se establece un marco espacial: yo-aqu√≠ observando vs. pensamiento-all√° movi√©ndose. Esta distancia funcional reduce la capacidad del pensamiento de transformar las funciones de est√≠mulo presentes.',
      incorrect: 'No es extinci√≥n (no hay repetici√≥n del est√≠mulo), ni relajaci√≥n (la relajaci√≥n puede ocurrir pero no es el objetivo), ni reestructuraci√≥n (el contenido no cambia). Es distanciamiento espacial: crear una relaci√≥n de perspectiva donde el pensamiento se observa "desde fuera".',
      process: 'Proceso: Distanciamiento espacial (Assaz et al., 2018). Se introduce un marco de relaci√≥n espacial (aqu√≠/all√°) entre el yo-como-contexto y el contenido verbal, debilitando la dominancia de Cfunc.'
    }
  },
  {
    title: 'El Tablero de Ajedrez',
    type: 'single',
    scenario: 'Wilson y Luciano (2002) describen esta met√°fora: las fichas blancas son los pensamientos/emociones "positivos" y las negras los "negativos". El cliente ha estado luchando ‚Äî poni√©ndose del lado de las blancas contra las negras. Pero cuanto m√°s lucha, m√°s grandes se hacen las fichas. La alternativa es ser el tablero: el contexto que contiene a ambos tipos de fichas sin ser ninguna de ellas.',
    instruction: '¬øCu√°l es la principal funci√≥n de la met√°fora del tablero?',
    options: [
      { text: 'Introduce el yo-como-contexto: la persona aprende a discriminarse como el "lugar" donde ocurren los eventos privados, no como los eventos mismos', correct: true },
      { text: 'Ense√±a que no hay que tener emociones negativas', correct: false },
      { text: 'Promueve el equilibrio entre pensamientos positivos y negativos', correct: false },
      { text: 'Demuestra que la persona tiene control sobre sus emociones', correct: false }
    ],
    feedback: {
      correct: 'Exacto. El tablero representa el yo-como-contexto (self-as-context): el marco de√≠ctico estable desde el cual se observan todos los contenidos. Wilson y Luciano se√±alan que la clave es distinguir entre el contexto (tablero/yo) y el contenido (fichas/pensamientos), sin luchar contra ninguno.',
      incorrect: 'El tablero contiene TODAS las fichas ‚Äî blancas y negras. No se trata de eliminar las negras ni de equilibrar. Se trata de discriminar que T√ö eres el tablero (el contexto), no las fichas (el contenido). Esto rompe la fusi√≥n con los eventos privados.',
      process: 'Proceso: Yo-como-contexto (self-as-context). Se establece un marco jer√°rquico donde el yo contiene a los contenidos verbales, promoviendo la defusi√≥n desde la perspectiva, no desde la t√©cnica.'
    }
  },
  {
    title: 'Elige la met√°fora correcta',
    type: 'matching',
    instruction: 'Para cada situaci√≥n cl√≠nica, selecciona la met√°fora m√°s apropiada:',
    pairs: [
      { left: 'Cliente que lucha constantemente contra pensamientos intrusivos, intentando suprimirlos', right: 'Tablero de ajedrez (dejar de luchar contra las fichas)' },
      { left: 'Cliente que no puede "soltar" una preocupaci√≥n recurrente y queda atrapado rumiando', right: 'Hojas en el r√≠o (observar pasar sin agarrar)' },
      { left: 'Cliente que evita actuar por miedo a lo que pueda pasar, cediendo ante las "amenazas" de la ansiedad', right: 'Pasajeros del autob√∫s (seguir conduciendo pese a los gritos)' },
      { left: 'Cliente con adicci√≥n que siente que las ansias son incontrolables y "van a explotar"', right: 'La gran ola (las ansias crecen, llegan al m√°ximo, y se disipan solas)' }
    ],
    feedback: {
      correct: 'Perfecto. La selecci√≥n de met√°foras debe basarse en el an√°lisis funcional: lucha activa ‚Üí Tablero (dejar de luchar); rumiaci√≥n ‚Üí Hojas (dejar pasar); evitaci√≥n por amenaza ‚Üí Autob√∫s (seguir hacia valores); ansias "explosivas" ‚Üí Ola (las emociones tienen un pico y bajan solas).',
      incorrect: 'La clave es el an√°lisis funcional: ¬øQu√© mantiene la fusi√≥n? Si es lucha activa ‚Üí Tablero. Si es quedarse atrapado ‚Üí Hojas. Si es ceder ante amenazas ‚Üí Autob√∫s. Si es miedo a que la emoci√≥n "explote" ‚Üí Ola. Cada met√°fora aborda un patr√≥n funcional distinto.',
      process: 'Proceso: Selecci√≥n de intervenci√≥n basada en an√°lisis funcional, no por preferencia del terapeuta. Cada met√°fora establece marcos relacionales diferentes que compiten con el patr√≥n de fusi√≥n espec√≠fico.'
    }
  },
  {
    title: 'La Mente como Radio',
    type: 'single',
    scenario: 'El terapeuta dice: <em>"Imagina que tu mente es como una radio que siempre est√° encendida. A veces pone m√∫sica agradable, a veces noticias alarmantes, a veces est√°tica. T√∫ no eres la radio ni la programaci√≥n. Eres la persona en la habitaci√≥n que puede escuchar lo que dice la radio y elegir qu√© hacer con su d√≠a."</em>',
    instruction: '¬øQu√© distingue esta met√°fora de simplemente decir "no hagas caso a tus pensamientos"?',
    options: [
      { text: 'Establece un marco de√≠ctico funcional (yo ‚â† radio/contenido) sin invalidar los pensamientos ni promover supresi√≥n ‚Äî los pensamientos siguen "sonando" y eso est√° bien', correct: true },
      { text: 'Es m√°s amable pero dice lo mismo', correct: false },
      { text: 'Promueve ignorar activamente los pensamientos', correct: false },
      { text: 'Es una t√©cnica de relajaci√≥n basada en imaginer√≠a', correct: false }
    ],
    feedback: {
      correct: 'Exacto. La diferencia crucial es: "no hagas caso" promueve supresi√≥n (que parad√≥jicamente aumenta la fusi√≥n). La met√°fora de la radio promueve disposici√≥n: los pensamientos siguen sonando, t√∫ los escuchas, y TAMBI√âN act√∫as en tu direcci√≥n elegida. No es ignorar ‚Äî es no obedecer.',
      incorrect: 'La diferencia es funcional, no cosm√©tica. "No hagas caso" implica supresi√≥n (luchar contra el pensamiento). La radio implica disposici√≥n: el sonido sigue ah√≠, t√∫ lo notas, pero tu conducta se orienta por lo que te importa. Es la diferencia entre evitaci√≥n experiencial y defusi√≥n.',
      process: 'Proceso: Marco de√≠ctico + disposici√≥n (willingness). Se distingue la persona del proceso verbal sin promover evitaci√≥n experiencial. La radio sigue sonando ‚Äî y est√° bien.'
    }
  },
  {
    title: 'Crear recontextualizaciones',
    type: 'single',
    scenario: 'Un cliente est√° fusionado con el pensamiento <em>"si no lo hago perfecto, ser√° un desastre"</em>. Ya has trabajado desesperanza creativa y el cliente entiende que la lucha contra el pensamiento no funciona.',
    instruction: '¬øCu√°l es el siguiente paso m√°s coherente con defusi√≥n?',
    options: [
      { text: 'Ayudar al cliente a notar el pensamiento como proceso verbal: "Tu mente acaba de generar la regla de que imperfecto = desastre. ¬øPuedes notar esa regla funcionando?"', correct: true },
      { text: 'Desafiar la evidencia: "¬øAlguna vez no hiciste algo perfecto y no fue un desastre?"', correct: false },
      { text: 'Reemplazar con un pensamiento positivo: "Puedes pensar que lo har√°s bien"', correct: false },
      { text: 'Usar relajaci√≥n para reducir la ansiedad que genera el pensamiento', correct: false }
    ],
    feedback: {
      correct: 'Correcto. Despu√©s de la desesperanza creativa, el paso coherente es promover la discriminaci√≥n del proceso verbal como proceso. "Tu mente gener√≥ la regla imperfecto=desastre" es una recontextualizaci√≥n que: (1) distingue al cliente de la regla, (2) describe el proceso (generar reglas), (3) no discute el contenido.',
      incorrect: 'Desafiar la evidencia es reestructuraci√≥n cognitiva (entra en el contenido). Pensamiento positivo es supresi√≥n/sustituci√≥n. Relajaci√≥n aborda el s√≠ntoma, no la fusi√≥n. La defusi√≥n trabaja la RELACI√ìN con el pensamiento, no el pensamiento mismo.',
      process: 'Proceso: Recontextualizaci√≥n narrativa + etiquetar el proceso verbal. Se promueve Crel (observar la regla como regla) sobre Cfunc (obedecer la regla como verdad literal).'
    }
  },
  {
    title: 'Sandbox: Dise√±a tu met√°fora',
    type: 'sandbox',
    instruction: 'Piensa en un caso cl√≠nico y dise√±a una met√°fora original de defusi√≥n que sea coherente con el an√°lisis funcional. Describe: (1) el patr√≥n de fusi√≥n del caso, (2) tu met√°fora, (3) qu√© marco relacional establece.',
    placeholder: 'Caso: Mi cliente est√° fusionado con...\n\nMet√°fora: ...\n\nMarco relacional que establece: ...',
    reflection: 'Las mejores met√°foras cl√≠nicas no son "bonitas" ‚Äî son funcionalmente precisas. Deben establecer marcos de relaci√≥n alternativos a los que mantienen el problema. Preg√∫ntate: ¬ømi met√°fora promueve observaci√≥n, disposici√≥n, y acci√≥n valiosa? ¬øO promueve evitaci√≥n, lucha, o distracci√≥n?'
  }
  ]
},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NIVEL 4: AN√ÅLISIS FUNCIONAL DE LA DEFUSI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  id: 'nivel4', title: 'An√°lisis Funcional de la Defusi√≥n', icon: 'üî¨',
  subtitle: 'Identifica procesos, dise√±a intervenciones y eval√∫a resultados',
  concept: {
    title: 'De la t√©cnica al proceso',
    text: 'La defusi√≥n competente no es aplicar t√©cnicas sino analizar la funci√≥n de la fusi√≥n en cada caso y dise√±ar intervenciones que alteren esa funci√≥n espec√≠fica. El terapeuta ACT funcional piensa en procesos (Crel/Cfunc, ROE-M, transformaci√≥n de funciones) no en protocolos.'
  },
  exercises: [
  {
    title: 'Identifica el proceso de Assaz',
    type: 'matching',
    instruction: 'Para cada intervenci√≥n, identifica el proceso principal seg√∫n Assaz et al. (2018):',
    pairs: [
      { left: 'El cliente repite "soy tonto" durante 45 segundos hasta que la palabra pierde impacto emocional', right: 'Extinci√≥n respondiente' },
      { left: 'El terapeuta refuerza socialmente cada vez que el cliente nota un pensamiento sin actuar desde √©l', right: 'Reforzamiento diferencial' },
      { left: 'El cliente practica decir "estoy notando que mi mente dice que soy tonto"', right: 'Recontextualizaci√≥n narrativa (autocl√≠ticos)' },
      { left: 'El cliente visualiza sus pensamientos escritos en nubes que pasan por el cielo', right: 'Distanciamiento espacial' }
    ],
    feedback: {
      correct: 'Excelente. Identificar el proceso te permite: (1) elegir la intervenci√≥n m√°s apropiada para el caso, (2) explicar al supervisando POR QU√â funciona, (3) adaptarla flexiblemente cuando la t√©cnica "est√°ndar" no es aplicable.',
      incorrect: 'Revisa los 4 procesos: Extinci√≥n respondiente = exposici√≥n repetida al est√≠mulo verbal sin referente. Reforzamiento diferencial = reforzar conducta no-fusionada. Recontextualizaci√≥n = cambiar el marco relacional con autocl√≠ticos. Distanciamiento espacial = marcos espaciales yo-aqu√≠/pensamiento-all√°.',
      process: 'Proceso: Los 4 mecanismos de Assaz et al. (2018). Cada t√©cnica de defusi√≥n puede analizarse seg√∫n qu√© proceso conductual la sustenta.'
    }
  },
  {
    title: 'Caso cl√≠nico: ¬øQu√© intervenci√≥n?',
    type: 'single',
    scenario: '<span class="speaker">Caso:</span>Pedro, 35 a√±os. Desde hace meses evita conducir porque tuvo un pensamiento intrusivo: <em>"¬øY si pierdo el control y atropello a alguien?"</em>. Cada vez que se acerca al coche, el pensamiento se intensifica y √©l "obedece" alej√°ndose. La evitaci√≥n se ha generalizado: ahora tambi√©n evita cuchillos, herramientas, y estar cerca de ventanas altas. Su repertorio conductual se ha reducido dr√°sticamente.',
    instruction: '¬øCu√°l ser√≠a la primera intervenci√≥n de defusi√≥n m√°s apropiada para este caso?',
    options: [
      { text: 'Trabajar primero con recontextualizaci√≥n: ayudar a Pedro a discriminar "estoy teniendo el pensamiento de que podr√≠a perder el control" ‚Äî distinguiendo el pensamiento del hecho, sin entrar a discutir su veracidad', correct: true },
      { text: 'Repetici√≥n de palabra: que repita "atropellar" hasta que pierda significado', correct: false },
      { text: 'Exposici√≥n directa: que conduzca inmediatamente', correct: false },
      { text: 'Discutir la probabilidad estad√≠stica de atropellar a alguien', correct: false }
    ],
    feedback: {
      correct: 'Bien razonado. Con pensamientos intrusivos ego-dist√≥nicos y alto nivel de fusi√≥n, la recontextualizaci√≥n es el primer paso m√°s seguro. No se entra al contenido (¬øes probable o no?) sino a la relaci√≥n funcional. La repetici√≥n podr√≠a ser percibida como invalidante en esta fase. La exposici√≥n conductual vendr√° despu√©s, con la defusi√≥n como base.',
      incorrect: 'La repetici√≥n directa de "atropellar" podr√≠a ser aversiva e iatrog√©nica con pensamientos intrusivos intensos. Discutir probabilidades es reestructuraci√≥n cognitiva (entramos al contenido). La exposici√≥n conductual es valiosa pero requiere primero que Pedro pueda observar el pensamiento sin fusionarse. La recontextualizaci√≥n es el paso funcional m√°s seguro.',
      process: 'Proceso: Secuenciaci√≥n basada en an√°lisis funcional. En fusi√≥n intensa con pensamientos ego-dist√≥nicos, la recontextualizaci√≥n (Crel) precede a la exposici√≥n funcional.'
    }
  },
  {
    title: '¬øQu√© NO es defusi√≥n?',
    type: 'multi',
    instruction: 'Selecciona TODAS las intervenciones que NO son defusi√≥n (aunque puedan parecer similares):',
    options: [
      { text: '"Ese pensamiento es irracional, vamos a buscar evidencia en contra" (reestructuraci√≥n cognitiva)', correct: true },
      { text: '"Intenta no pensar en eso, piensa en algo positivo" (supresi√≥n/sustituci√≥n)', correct: true },
      { text: '"Estoy notando que tengo el pensamiento de que no sirvo" (autocl√≠tico descriptivo)', correct: false },
      { text: '"¬øCu√°ntas veces has pensado eso y no se ha cumplido?" (cuestionamiento socr√°tico)', correct: true },
      { text: '"Mi mente me est√° diciendo una historia sobre el fracaso" (etiquetar el proceso)', correct: false },
      { text: '"Respira profundo y deja ir ese pensamiento" (relajaci√≥n/letting go como evitaci√≥n)', correct: true }
    ],
    feedback: {
      correct: 'Excelente discriminaci√≥n. La defusi√≥n NO cambia el contenido (‚â† reestructuraci√≥n), NO suprime (‚â† sustituci√≥n), NO debate la veracidad (‚â† cuestionamiento socr√°tico), y NO usa relajaci√≥n como forma de escapar del pensamiento. La defusi√≥n cambia la FUNCI√ìN del pensamiento sin alterar su contenido.',
      incorrect: 'Revisa: la clave es que la defusi√≥n NO entra al contenido del pensamiento. Si la intervenci√≥n busca cambiar LO QUE piensas (reestructuraci√≥n), eliminar el pensamiento (supresi√≥n), debatir si es verdad (cuestionamiento), o escapar de √©l (relajaci√≥n como evitaci√≥n), NO es defusi√≥n.',
      process: 'Proceso: La defusi√≥n opera sobre la relaci√≥n funcional con el pensamiento (Cfunc ‚Üí Crel), no sobre el contenido del pensamiento. Esta distinci√≥n es fundamental para la fidelidad al modelo ACT.'
    }
  },
  {
    title: 'An√°lisis ROE-M de un caso',
    type: 'matching',
    instruction: 'En el caso de Pedro (pensamientos intrusivos sobre da√±ar a otros), mapea cada componente del ROE-M:',
    pairs: [
      { left: 'R (Relating/Relacionar): La derivaci√≥n relacional activa', right: '"Pensamiento de da√±ar" ‚Üí en marco de causalidad ‚Üí "Yo soy peligroso"' },
      { left: 'O (Orienting/Orientar): Hacia d√≥nde se dirige la atenci√≥n', right: 'Atenci√≥n focalizada en se√±ales de "peligro" interno (pensamientos, impulsos)' },
      { left: 'E (Evoking/Evocar): Funciones conductuales que se activan', right: 'Funciones aversivas (miedo, repulsi√≥n) que evocan escape/evitaci√≥n' },
      { left: 'M (Motivating/Motivar): Operaciones motivacionales', right: 'El alivio de la evitaci√≥n funciona como reforzamiento negativo que mantiene el patr√≥n' }
    ],
    feedback: {
      correct: 'Excelente an√°lisis ROE-M. Esta unidad de an√°lisis (Harte & Barnes-Holmes, 2023) permite ver c√≥mo los cuatro elementos interact√∫an din√°micamente para mantener la fusi√≥n. La intervenci√≥n de defusi√≥n puede apuntar a cualquiera de los elementos para interrumpir el patr√≥n.',
      incorrect: 'El ROE-M analiza la fusi√≥n como interacci√≥n din√°mica: R = qu√© relaciones se derivan, O = hacia d√≥nde se orienta la atenci√≥n, E = qu√© funciones se activan, M = qu√© operaciones motivacionales mantienen el patr√≥n. Cada elemento influye en los dem√°s.',
      process: 'Proceso: Unidad de an√°lisis ROE-M (Relating-Orienting-Evoking-Motivating) de Harte & Barnes-Holmes (2023). Permite un an√°lisis m√°s fino de la fusi√≥n que la dicotom√≠a simple fusi√≥n/defusi√≥n.'
    }
  },
  {
    title: 'Dise√±ar la intervenci√≥n',
    type: 'ordering',
    instruction: 'Ordena la secuencia de intervenci√≥n de defusi√≥n m√°s apropiada para un caso de fusi√≥n moderada con pensamientos de autocr√≠tica ("no valgo nada"):',
    items: [
      { text: 'Validar la experiencia del cliente y establecer contexto terap√©utico de apertura', order: 1 },
      { text: 'Introducir la desesperanza creativa: explorar qu√© ha hecho el cliente para luchar contra el pensamiento y c√≥mo le ha ido', order: 2 },
      { text: 'Presentar la defusi√≥n como alternativa: no cambiar el pensamiento sino la relaci√≥n con √©l', order: 3 },
      { text: 'Practicar t√©cnicas concretas (prefijo, etiquetar, met√°fora) ajustadas al an√°lisis funcional', order: 4 },
      { text: 'Conectar la defusi√≥n con los valores del cliente: "ahora que puedes notar el pensamiento sin que te domine, ¬øhacia d√≥nde quieres caminar?"', order: 5 }
    ],
    feedback: {
      correct: 'Perfecto. La secuencia es: (1) Validaci√≥n, (2) Desesperanza creativa (el cliente contacta que la lucha no funciona), (3) Presentar la alternativa conceptualmente, (4) Practicar t√©cnicas ajustadas al caso, (5) Conectar con valores. La defusi√≥n sin valores es un ejercicio vac√≠o.',
      incorrect: 'La secuencia l√≥gica es: primero validar (contexto terap√©utico), luego desesperanza creativa (contactar la ineficacia de la lucha), despu√©s presentar la alternativa (defusi√≥n), practicar t√©cnicas concretas, y finalmente conectar con valores. Saltarse pasos reduce la eficacia.',
      process: 'Proceso: Secuenciaci√≥n funcional de la intervenci√≥n ACT. La defusi√≥n se inserta en un proceso terap√©utico m√°s amplio donde los valores dan direcci√≥n y la desesperanza creativa crea el contexto motivacional.'
    }
  },
  {
    title: '¬øCu√°ndo la defusi√≥n no es suficiente?',
    type: 'multi',
    instruction: 'Selecciona las situaciones donde la defusi√≥n SOLA probablemente no ser√° suficiente y se necesitan otros procesos ACT:',
    options: [
      { text: 'El cliente puede notar sus pensamientos sin fusionarse, pero no sabe qu√© le importa en la vida (falta clarificaci√≥n de valores)', correct: true },
      { text: 'El cliente se defusiona moment√°neamente pero inmediatamente vuelve a la evitaci√≥n porque el reforzamiento negativo es muy potente (falta trabajo con aceptaci√≥n/disposici√≥n)', correct: true },
      { text: 'El cliente tiene pensamientos negativos frecuentes', correct: false },
      { text: 'El cliente puede defusionarse pero no tiene las habilidades conductuales para actuar en la direcci√≥n valiosa (falta acci√≥n comprometida)', correct: true },
      { text: 'El cliente no puede mantener la perspectiva de observador porque se identifica completamente con sus roles y narrativas (falta yo-como-contexto)', correct: true }
    ],
    feedback: {
      correct: 'Excelente comprensi√≥n del modelo. La defusi√≥n es un proceso necesario pero no suficiente. Se necesita: valores (para qu√© defusionarse), aceptaci√≥n (disposici√≥n a tener lo que aparezca), acci√≥n comprometida (habilidades para actuar), y yo-como-contexto (perspectiva estable de observaci√≥n). Los 6 procesos trabajan juntos.',
      incorrect: 'Tener pensamientos negativos frecuentes NO significa que la defusi√≥n sea insuficiente ‚Äî la defusi√≥n permite tener esos pensamientos sin que dominen. Los otros casos s√≠ requieren procesos adicionales: valores, aceptaci√≥n, acci√≥n comprometida, y yo-como-contexto.',
      process: 'Proceso: Modelo de flexibilidad psicol√≥gica (Hexaflex). Los 6 procesos ACT son interdependientes. La defusi√≥n habilita pero no reemplaza a los otros procesos.'
    }
  },
  {
    title: 'Sandbox: An√°lisis funcional completo',
    type: 'sandbox',
    instruction: 'Toma un caso cl√≠nico y realiza: (1) An√°lisis funcional de la fusi√≥n, (2) Identifica los 4 procesos de Assaz relevantes, (3) Dise√±a una secuencia de intervenci√≥n de 3 pasos. Puedes usar el modelo ROE-M si quieres mayor precisi√≥n.',
    placeholder: 'Caso:\n\nAn√°lisis funcional de la fusi√≥n:\n- R (Relacionar):\n- O (Orientar):\n- E (Evocar):\n- M (Motivar):\n\nProcesos de Assaz relevantes:\n\nSecuencia de intervenci√≥n:\n1.\n2.\n3.',
    reflection: 'Este tipo de an√°lisis funcional es lo que distingue al terapeuta ACT competente del que solo "aplica t√©cnicas". En el siguiente nivel, practicar√°s todo esto en formato de sesi√≥n simulada.'
  }
  ]
},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ NIVEL 5: SESI√ìN SIMULADA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{
  id: 'nivel5', title: 'Sesi√≥n Simulada', icon: 'üéØ',
  subtitle: 'Pon todo en pr√°ctica en escenarios cl√≠nicos realistas',
  concept: {
    title: 'Integrando todo',
    text: 'En la pr√°ctica real, la defusi√≥n no ocurre como una "t√©cnica aislada". Emerge en el flujo terap√©utico, responde al momento presente de la sesi√≥n, y se conecta con el resto de procesos ACT. Aqu√≠ practicar√°s tomando decisiones como terapeuta.'
  },
  exercises: [
  {
    title: 'Sesi√≥n 1: La trampa del contenido',
    type: 'dialogue',
    intro: 'Tu cliente Sof√≠a llega angustiada. Lleva semanas sin dormir bien. Has identificado que est√° altamente fusionada con pensamientos de autocr√≠tica intensa.',
    steps: [
      {
        speaker: 'client', name: 'Sof√≠a',
        text: 'Es que no puedo m√°s. Mi mente no para. Toda la noche pensando "no voy a poder con esto, no voy a poder". Y es verdad, mira c√≥mo estoy. No puedo ni dormir.'
      },
      {
        speaker: 'choose',
        instruction: 'Como terapeuta, ¬øc√≥mo respondes?',
        options: [
          {
            text: '"Sof√≠a, noto que tu mente est√° muy activa ahora mismo, dando el mensaje de que no puedes. ¬øPuedes notar eso conmigo? Que hay una parte que observa y otra parte que dice cosas."',
            correct: true,
            response: { speaker: 'client', name: 'Sof√≠a', text: '(pausa)... S√≠, es como que siempre est√° ah√≠ diciendo lo mismo. Como un disco rayado.' }
          },
          {
            text: '"No te preocupes, seguro que puedes con esto. Eres m√°s fuerte de lo que crees."',
            correct: false,
            response: { speaker: 'client', name: 'Sof√≠a', text: 'Eso me dicen todos, pero no me ayuda. Si pudiera sentirme fuerte, lo har√≠a. No es tan f√°cil.' },
            why: 'Tranquilizar invalida la experiencia y entra en el contenido. Adem√°s, "eres m√°s fuerte" contradice lo que Sof√≠a experimenta, lo que puede generar m√°s fusi√≥n (ahora con "deber√≠a poder y no puedo").'
          },
          {
            text: '"Vamos a analizar si realmente no puedes. ¬øCu√°les son las evidencias de que no puedes?"',
            correct: false,
            response: { speaker: 'client', name: 'Sof√≠a', text: 'Las evidencias est√°n clar√≠simas, mira c√≥mo estoy, no duermo, no puedo concentrarme en nada...' },
            why: 'Pedir evidencias es reestructuraci√≥n cognitiva. Entra en el contenido del pensamiento y puede reforzar la fusi√≥n: ahora Sof√≠a genera m√°s "evidencia" de que no puede.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Como un disco rayado... Entonces hay un disco que suena, y hay alguien que escucha el disco. ¬øQui√©n es la que est√° escuchando ahora mismo?"'
      },
      {
        speaker: 'client', name: 'Sof√≠a',
        text: '(leve sonrisa) Pues... yo. Yo lo escucho. Pero es que es muy fuerte, es como si me gritara.'
      },
      {
        speaker: 'choose',
        instruction: '¬øCu√°l es tu siguiente movimiento?',
        options: [
          {
            text: '"Claro que grita fuerte. Y t√∫ est√°s aqu√≠, escuch√°ndolo, y al mismo tiempo sentada en esta silla, hablando conmigo. El disco grita y t√∫ est√°s aqu√≠. ¬øPuedes notar las dos cosas al mismo tiempo?"',
            correct: true,
            response: { speaker: 'client', name: 'Sof√≠a', text: '(pausa larga)... S√≠. Es raro. S√≠ puedo notar las dos cosas. El pensamiento est√° ah√≠ pero tambi√©n estoy aqu√≠.' }
          },
          {
            text: '"Vamos a intentar que deje de gritar. Te voy a ense√±ar una t√©cnica de relajaci√≥n para bajar el volumen."',
            correct: false,
            response: { speaker: 'client', name: 'Sof√≠a', text: 'S√≠, por favor, quiero que se calle de una vez.' },
            why: 'Ofrecer "bajar el volumen" del pensamiento entra en la agenda de control. Refuerza la idea de que el pensamiento debe cambiar para que Sof√≠a pueda funcionar.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: 'Est√°s notando que el disco suena Y t√∫ est√°s aqu√≠. Eso que acabas de hacer ‚Äî notarlo ‚Äî es exactamente lo que vamos a practicar. No a apagar el disco, sino a poder moverte en tu vida mientras suena.'
      }
    ],
    feedback: {
      correct: 'Has navegado esta interacci√≥n manteniendo el foco en la defusi√≥n: distinguir al observador del contenido, validar sin tranquilizar, y no entrar en la agenda de control. La met√°fora del disco emergi√≥ del propio lenguaje de la cliente, lo que la hace m√°s potente.',
      process: 'Proceso: Marco de√≠ctico (yo observando vs. contenido), met√°fora emergente del lenguaje del cliente, disposici√≥n como alternativa a control.'
    }
  },
  {
    title: 'Sesi√≥n 2: Resistencia a la defusi√≥n',
    type: 'dialogue',
    intro: 'Tu cliente Marcos ha estado trabajando defusi√≥n por 3 sesiones, pero hoy llega frustrado. Parece estar "usando" la defusi√≥n como otra forma de control.',
    steps: [
      {
        speaker: 'client', name: 'Marcos',
        text: 'Estuve practicando lo del "estoy teniendo el pensamiento de que..." pero no funciona. Sigo sinti√©ndome igual de mal. Hice lo que me dijiste y nada cambi√≥.'
      },
      {
        speaker: 'choose',
        instruction: '¬øC√≥mo respondes?',
        options: [
          {
            text: '"Marcos, cuando dices que no funcion√≥... ¬øpara qu√© estabas usando la defusi√≥n? ¬øQu√© esperabas que pasara?"',
            correct: true,
            response: { speaker: 'client', name: 'Marcos', text: 'Pues... que dejara de sentirme as√≠. Que el pensamiento se fuera.' }
          },
          {
            text: '"Tal vez no la est√°s haciendo bien. Vamos a practicar de nuevo con m√°s atenci√≥n."',
            correct: false,
            response: { speaker: 'client', name: 'Marcos', text: '(frustrado) Ya, seguro que estoy haciendo otra cosa mal tambi√©n.' },
            why: 'Corregir la t√©cnica refuerza la fusi√≥n con la idea de que hay una forma "correcta" de sentir. Adem√°s, Marcos ya se autocritica ‚Äî a√±adir m√°s "correcci√≥n" amplifica ese patr√≥n.'
          },
          {
            text: '"A veces lleva tiempo. Ten paciencia, sigue practicando."',
            correct: false,
            response: { speaker: 'client', name: 'Marcos', text: '(suspira) Eso espero...' },
            why: 'Ser gen√©rico evita el momento terap√©utico. Marcos est√° mostrando fusi√≥n EN VIVO: est√° usando la defusi√≥n como herramienta de control/evitaci√≥n. Esto necesita abordarse directamente.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Perfecto, Marcos. F√≠jate en algo interesante: estabas usando el \'estoy teniendo el pensamiento...\' para librarte del pensamiento. ¬øEso te suena familiar? ¬øEs parecido a lo que ya hab√≠as estado haciendo antes de venir aqu√≠ ‚Äî intentar que los pensamientos se vayan?"'
      },
      {
        speaker: 'client', name: 'Marcos',
        text: '(pausa)... S√≠. Es lo mismo. Estaba usando la t√©cnica como otra forma de escapar. (r√≠e un poco) Vaya.'
      },
      {
        speaker: 'choose',
        instruction: '¬øCu√°l es tu siguiente intervenci√≥n?',
        options: [
          {
            text: '"Exacto. Y f√≠jate que ahora mismo acabas de hacer algo diferente: NOTASTE que estabas haciendo eso. Ese notar ‚Äî eso s√≠ es defusi√≥n. No la t√©cnica en s√≠, sino este darte cuenta."',
            correct: true,
            response: { speaker: 'client', name: 'Marcos', text: 'Entonces... no se trata de la frase en s√≠, sino de darme cuenta de lo que estoy haciendo.' }
          },
          {
            text: '"No te preocupes, es un error com√∫n. Vamos a intentar con otra t√©cnica diferente."',
            correct: false,
            response: { speaker: 'client', name: 'Marcos', text: 'Bueno, a ver si esta nueva funciona.' },
            why: 'Cambiar de t√©cnica evita el insight m√°s importante: que la defusi√≥n no es una t√©cnica sino un proceso de notar. Adem√°s, refuerza la b√∫squeda de "la t√©cnica que funcione" ‚Äî otra forma de control.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Eso es. La defusi√≥n no es una herramienta para sentirte mejor. Es la capacidad de notar lo que tu mente hace ‚Äî incluyendo cuando usa la defusi√≥n como escape. Y desde ah√≠, elegir. ¬øQu√© quieres hacer con tu tarde hoy, independientemente de lo que diga el disco?"'
      }
    ],
    feedback: {
      correct: 'Excelente manejo de un momento cl√≠nico sutil. Cuando la defusi√≥n se usa como control, el terapeuta funcional no "ense√±a mejor la t√©cnica" sino que usa ESE MOMENTO para promover la discriminaci√≥n: notar que estabas usando la defusi√≥n como escape ES defusi√≥n. Conectar con valores al final cierra el loop.',
      process: 'Proceso: Meta-defusi√≥n (noticing the process of noticing), desesperanza creativa aplicada a la propia t√©cnica de defusi√≥n, conexi√≥n con valores como direcci√≥n.'
    }
  },
  {
    title: 'Sesi√≥n 3: Defusi√≥n en crisis',
    type: 'dialogue',
    intro: 'Tu cliente Luc√≠a llega en crisis. Acaba de recibir una cr√≠tica de su jefe y est√° completamente fusionada. Llorando, repite el mismo pensamiento.',
    steps: [
      {
        speaker: 'client', name: 'Luc√≠a',
        text: '(llorando) Me dijo que mi trabajo es mediocre. Mediocre. Eso es lo que soy. Toda mi vida he sido mediocre. En todo. No sirvo para nada. Deber√≠a dejarlo todo.'
      },
      {
        speaker: 'choose',
        instruction: 'Luc√≠a est√° en alta activaci√≥n emocional y fusi√≥n. ¬øCu√°l es tu primer movimiento?',
        options: [
          {
            text: '(Pausa, contacto visual, tono calmado) "Luc√≠a, estoy aqu√≠ contigo. ¬øPuedes sentir la silla debajo de ti? Est√°s aqu√≠, en este espacio, ahora mismo."',
            correct: true,
            response: { speaker: 'client', name: 'Luc√≠a', text: '(respiraci√≥n entrecortada, asiente)... S√≠... estoy aqu√≠.' }
          },
          {
            text: '"Vamos a usar la t√©cnica: \'estoy teniendo el pensamiento de que soy mediocre\'."',
            correct: false,
            response: { speaker: 'client', name: 'Luc√≠a', text: '(m√°s frustrada) ¬°No es un pensamiento, ES LA REALIDAD! ¬°Mi jefe me lo dijo!' },
            why: 'Introducir la t√©cnica de defusi√≥n cuando el cliente est√° en alta activaci√≥n emocional puede sentirse invalidante. Primero se necesita contacto con el presente y validaci√≥n.'
          },
          {
            text: '"Tu jefe no tiene raz√≥n. Tu trabajo es valioso."',
            correct: false,
            response: { speaker: 'client', name: 'Luc√≠a', text: '¬°T√∫ no lo viste! No sabes lo que dijo... fue delante de todos.' },
            why: 'Contradecir la experiencia genera reactancia y puede romper la alianza terap√©utica. Luc√≠a necesita sentirse escuchada, no corregida.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Est√°s aqu√≠. Y noto que lleg√≥ un dolor muy grande. Tu mente ha agarrado esa palabra ‚Äî mediocre ‚Äî y la ha conectado con toda tu vida. ¬øPuedes notar eso conmigo? C√≥mo una palabra se ha expandido a todo."'
      },
      {
        speaker: 'client', name: 'Luc√≠a',
        text: '(m√°s calmada, pero a√∫n llorando) S√≠... es como que esa palabra se peg√≥ a todo. A mis recuerdos, a mi futuro... todo se volvi√≥ mediocre.'
      },
      {
        speaker: 'choose',
        instruction: 'Luc√≠a comienza a discriminar el proceso. ¬øC√≥mo avanzas?',
        options: [
          {
            text: '"S√≠. Esa palabra se peg√≥ a todo. Eso es exactamente lo que hace el lenguaje: una palabra se conecta con todo lo dem√°s. Y en este momento, ¬øqu√© ser√≠a lo m√°s importante para ti hacer, independientemente de lo que esa palabra diga?"',
            correct: true,
            response: { speaker: 'client', name: 'Luc√≠a', text: '(pausa)... No s√©... ¬øSeguir? No quiero que una palabra decida por m√≠.' }
          },
          {
            text: '"Vamos a repetir la palabra \'mediocre\' 40 veces r√°pido para que pierda su poder."',
            correct: false,
            response: { speaker: 'client', name: 'Luc√≠a', text: '(inc√≥moda) No... no quiero hacer eso ahora. Me da cosa.' },
            why: 'La repetici√≥n de palabra puede funcionar en otros momentos, pero justo ahora ser√≠a forzar una t√©cnica sin sensibilidad al momento cl√≠nico. Luc√≠a ya est√° discriminando ‚Äî mejor seguir ese hilo.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"No quieres que una palabra decida por ti. Eso es algo muy importante que acabas de decir. Podemos aprender a que las palabras est√©n ah√≠ ‚Äî incluso esa ‚Äî sin que nos dirijan la vida."'
      }
    ],
    feedback: {
      correct: 'Has demostrado sensibilidad al momento cl√≠nico: primero contacto con el presente, luego validaci√≥n, despu√©s discriminaci√≥n del proceso verbal ("la palabra se peg√≥ a todo"), y finalmente conexi√≥n con valores. La defusi√≥n en crisis requiere m√°s presencia del terapeuta y menos "t√©cnicas".',
      process: 'Proceso: Presente momento ‚Üí validaci√≥n ‚Üí recontextualizaci√≥n natural ‚Üí conexi√≥n con valores. En crisis, la defusi√≥n emerge del contacto terap√©utico, no de la aplicaci√≥n de t√©cnicas.'
    }
  },
  {
    title: 'Sesi√≥n 4: Defusi√≥n y adicci√≥n',
    type: 'dialogue',
    intro: 'Tu cliente Roberto, 40 a√±os, lleva 8 meses sin consumir alcohol. Hoy llega agitado. Ha tenido una discusi√≥n fuerte con su pareja y reporta ansias intensas de beber.',
    steps: [
      {
        speaker: 'client', name: 'Roberto',
        text: 'No aguanto m√°s. Necesito un trago. Lo necesito, es como un globo infl√°ndose aqu√≠ dentro (se√±ala el est√≥mago). Si no bebo va a explotar. Llevo toda la tarde luchando contra esto y cada vez es peor.'
      },
      {
        speaker: 'choose',
        instruction: 'Roberto est√° describiendo sus ansias con una met√°fora potente. ¬øC√≥mo respondes?',
        options: [
          {
            text: '"Roberto, noto que dices que es como un globo que se infla y va a explotar. ¬øY si ese globo fuera m√°s como una ola? Las olas crecen, crecen... llegan a un punto m√°ximo... y despu√©s simplemente rompen en la playa. ¬øPuedes quedarte un momento observando esa ola conmigo?"',
            correct: true,
            response: { speaker: 'client', name: 'Roberto', text: '(respira hondo)... Una ola... S√≠, puedo intentar verlo as√≠. Pero es que sube mucho.' }
          },
          {
            text: '"Piensa en tus 8 meses de sobriedad. No puedes tirar todo eso a la basura por una discusi√≥n."',
            correct: false,
            response: { speaker: 'client', name: 'Roberto', text: '¬°Ya lo s√©! ¬øNo crees que ya pens√© en eso? Pero saber eso no me quita las ganas.' },
            why: 'Apelar a la l√≥gica y al "no puedes" entra en la agenda de control racional. Roberto ya sabe que no deber√≠a beber ‚Äî el problema no es informativo, es funcional. Adem√°s, "no puedes tirar eso a la basura" puede funcionar como un augmental que amplifica la presi√≥n.'
          },
          {
            text: '"Vamos a hacer un ejercicio de relajaci√≥n para bajar la ansiedad."',
            correct: false,
            response: { speaker: 'client', name: 'Roberto', text: 'S√≠, algo que me quite esto de encima...' },
            why: 'Ofrecer relajaci√≥n para "quitar" las ansias refuerza la agenda de control. El mensaje impl√≠cito es: las ansias son el enemigo que hay que eliminar. Esto es exactamente lo que mantiene el ciclo de la adicci√≥n.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Sube mucho, s√≠. Y t√∫ est√°s aqu√≠, observ√°ndola subir. Eso ya es diferente a estar dentro de la ola. Cu√©ntame, ¬øc√≥mo es ahora mismo? ¬øLa ola est√° subiendo, est√° en su punto m√°ximo, o est√° empezando a bajar?"'
      },
      {
        speaker: 'client', name: 'Roberto',
        text: '(pausa, se concentra)... Creo que... est√° como en la cresta. Est√° muy fuerte. Pero... no explot√≥. Sigue ah√≠ pero no explot√≥.'
      },
      {
        speaker: 'choose',
        instruction: 'Roberto est√° contactando la experiencia sin actuar. ¬øCu√°l es tu siguiente movimiento?',
        options: [
          {
            text: '"No explot√≥. Tu mente te dijo que iba a explotar, y t√∫ te quedaste observando, y no explot√≥. ¬øQu√© te dice eso sobre lo que tu mente predice cuando tiene ansias?"',
            correct: true,
            response: { speaker: 'client', name: 'Roberto', text: '(sonr√≠e un poco)... Que no siempre tiene raz√≥n. Que me dice que va a explotar y en realidad... pasa.' }
          },
          {
            text: '"Bien, ya est√° bajando. ¬øVes? No era para tanto."',
            correct: false,
            response: { speaker: 'client', name: 'Roberto', text: '(se tensa) S√≠ era para tanto. Todav√≠a lo siento.' },
            why: 'Minimizar la experiencia ("no era para tanto") invalida a Roberto y puede romper la alianza terap√©utica. Adem√°s, el objetivo no es que las ansias no sean intensas, sino que Roberto pueda estar con ellas sin que controlen su conducta.'
          }
        ]
      },
      {
        speaker: 'therapist',
        text: '"Pasa. Las olas siempre pasan. Y lo que acaba de ocurrir aqu√≠ es que t√∫ te quedaste en la playa observando la ola, sin tirarte al agua. Ocho meses de sobriedad no los sostiene la lucha contra las ansias, Roberto ‚Äî los sostiene esta capacidad de ver la ola y dejarla pasar. ¬øQu√© quieres hacer con tu noche ahora?"'
      }
    ],
    feedback: {
      correct: 'Excelente manejo. Usaste la met√°fora de la ola (Wilson & Luciano) de manera natural, recontextualizando la met√°fora del propio cliente (globo ‚Üí ola). Mantuviste contacto con el presente, promoviste observaci√≥n sin lucha, y cerraste conectando con valores y acci√≥n. La defusi√≥n con adicciones requiere especial cuidado para no reforzar la agenda de control.',
      process: 'Proceso: Recontextualizaci√≥n de la met√°fora del cliente + distanciamiento espacial (observar la ola) + discriminaci√≥n experiencial (no explot√≥) + conexi√≥n con valores y acci√≥n comprometida.'
    }
  },
  {
    title: 'Secuencia terap√©utica completa',
    type: 'ordering',
    instruction: 'Un nuevo cliente presenta fusi√≥n intensa con "no merezco ser feliz". Ordena los pasos de una secuencia terap√©utica completa de defusi√≥n:',
    items: [
      { text: 'Explorar con empat√≠a la experiencia del cliente: validar el sufrimiento sin entrar al contenido del pensamiento', order: 1 },
      { text: 'Desesperanza creativa: explorar qu√© ha intentado el cliente para deshacerse de ese pensamiento y c√≥mo le ha ido', order: 2 },
      { text: 'Introducir la distinci√≥n entre el observador y lo observado: "Hay un pensamiento que dice X, y hay alguien que escucha ese pensamiento"', order: 3 },
      { text: 'Practicar t√©cnicas ajustadas al caso (ej: prefijo "estoy notando que...", etiquetar "mi mente est√° haciendo su trabajo de juzgar")', order: 4 },
      { text: 'Usar met√°fora apropiada al patr√≥n funcional (ej: Pasajeros del autob√∫s si hay evitaci√≥n, Tablero si hay lucha activa contra el pensamiento)', order: 5 },
      { text: 'Conectar con valores: "Ahora que puedes notar ese pensamiento sin que te dirija, ¬øhacia d√≥nde quieres caminar?"', order: 6 },
      { text: 'Dise√±ar acciones comprometidas concretas que el cliente pueda realizar entre sesiones, con el pensamiento presente', order: 7 }
    ],
    feedback: {
      correct: 'Perfecto. La secuencia sigue la l√≥gica funcional de ACT: primero crear contexto terap√©utico (validaci√≥n), luego socavar la agenda de control (desesperanza creativa), despu√©s introducir la alternativa gradualmente (observador ‚Üí t√©cnicas ‚Üí met√°foras), y finalmente darle direcci√≥n con valores y acci√≥n. Cada paso prepara el terreno para el siguiente.',
      incorrect: 'La secuencia l√≥gica es: (1) Validar ‚Üí (2) Desesperanza creativa ‚Üí (3) Introducir perspectiva de observador ‚Üí (4) T√©cnicas concretas ‚Üí (5) Met√°fora apropiada ‚Üí (6) Conectar valores ‚Üí (7) Acci√≥n comprometida. Saltar la validaci√≥n o la desesperanza creativa reduce la efectividad porque el cliente no tiene el contexto motivacional para las t√©cnicas.',
      process: 'Proceso: Secuenciaci√≥n funcional ACT completa. La defusi√≥n no es un evento aislado sino un proceso que se construye sobre validaci√≥n, desesperanza creativa, y se completa con valores y acci√≥n comprometida.'
    }
  },
  {
    title: 'Elegir el momento de la defusi√≥n',
    type: 'single',
    scenario: 'Est√°s en una sesi√≥n y tu cliente dice: <em>"Sabes qu√©, ya entend√≠ que son solo pensamientos. Pero la verdad es que estoy harto de mi trabajo. Mi jefe es un idiota y mis compa√±eros no hacen nada. Quiero cambiar de empleo pero no s√© por d√≥nde empezar."</em>',
    instruction: '¬øCu√°l es la respuesta m√°s apropiada?',
    options: [
      { text: 'No usar defusi√≥n ahora. El cliente est√° hablando desde sus valores (querer cambiar) y pidiendo ayuda pr√°ctica. Explorar acci√≥n comprometida: "¬øQu√© ser√≠a lo primero que har√≠as si decidieras avanzar en esa direcci√≥n?"', correct: true },
      { text: 'Aplicar defusi√≥n a "mi jefe es un idiota": "Est√°s teniendo el pensamiento de que tu jefe es un idiota."', correct: false },
      { text: 'Trabajar aceptaci√≥n del malestar laboral', correct: false },
      { text: 'Explorar si realmente quiere cambiar de trabajo o si es evitaci√≥n', correct: false }
    ],
    feedback: {
      correct: 'Excelente discriminaci√≥n cl√≠nica. No todo pensamiento necesita defusi√≥n. Cuando el cliente est√° movi√©ndose hacia sus valores y pidiendo ayuda concreta, la defusi√≥n puede ser contraproducente ‚Äî como "t√©cniquear" un momento de agencia. Aqu√≠ corresponde acci√≥n comprometida.',
      incorrect: 'Un error com√∫n es aplicar defusi√≥n a TODO lo que el cliente dice. "Mi jefe es un idiota" no est√° funcionando como fusi√≥n que paralice al cliente ‚Äî al contrario, el cliente est√° tomando direcci√≥n. Defusionar ah√≠ podr√≠a interrumpir un momento valioso de agencia.',
      process: 'Proceso: Discriminaci√≥n cl√≠nica de cu√°ndo usar cada proceso ACT. La defusi√≥n se aplica cuando la fusi√≥n impide la acci√≥n valiosa, no como respuesta autom√°tica a todo pensamiento.'
    }
  },
  {
    title: 'Integraci√≥n: Caso completo',
    type: 'multi',
    scenario: '<span class="speaker">Caso:</span>Elena, 28 a√±os. Evita relaciones √≠ntimas porque piensa <em>"si me acerco a alguien, me van a abandonar como mi padre"</em>. Cuando alguien muestra inter√©s, ella siente ansiedad intensa y se aleja. Ha perdido varias relaciones valiosas. Dice <em>"s√© que no es racional pero no puedo evitarlo"</em>.',
    instruction: '¬øQu√© procesos ACT necesitas trabajar con Elena? Selecciona TODOS los que aplican:',
    options: [
      { text: 'Defusi√≥n: ayudarla a notar la regla verbal "cercan√≠a = abandono" como una relaci√≥n derivada, no como ley natural', correct: true },
      { text: 'Aceptaci√≥n: disposici√≥n a sentir la ansiedad que aparece al acercarse, sin huir de ella', correct: true },
      { text: 'Valores: clarificar qu√© tipo de relaciones quiere tener y por qu√© le importan', correct: true },
      { text: 'Reestructuraci√≥n cognitiva: demostrarle que no todos la van a abandonar', correct: false },
      { text: 'Acci√≥n comprometida: pasos concretos hacia la intimidad, con la ansiedad presente', correct: true },
      { text: 'Yo-como-contexto: discriminar que ella no es su historia de abandono, es el contexto donde esa historia ocurre', correct: true }
    ],
    feedback: {
      correct: 'Perfecto. Elena necesita los 5 procesos ACT (excepto reestructuraci√≥n, que no es ACT): defusi√≥n de la regla verbal, aceptaci√≥n de la ansiedad, clarificaci√≥n de valores relacionales, acci√≥n comprometida hacia la intimidad, y yo-como-contexto para no identificarse con la historia de abandono.',
      incorrect: 'La reestructuraci√≥n cognitiva ("no todos te van a abandonar") entra en el contenido del pensamiento, que es justamente lo que Elena ya intenta hacer cuando dice "s√© que no es racional". El problema no es la racionalidad del pensamiento sino su funci√≥n sobre la conducta. Necesita los 5 procesos ACT.',
      process: 'Proceso: Modelo hexaflex completo. La defusi√≥n habilita la observaci√≥n de la regla, la aceptaci√≥n permite tolerar la ansiedad, los valores dan direcci√≥n, la acci√≥n comprometida genera cambio, y el yo-como-contexto ofrece perspectiva estable.'
    }
  },
  {
    title: 'Sandbox: Tu mini-sesi√≥n',
    type: 'sandbox',
    instruction: 'Dise√±a un fragmento de sesi√≥n (5-8 intercambios) donde apliques defusi√≥n de manera funcional. Incluye: el contexto del caso, qu√© dice el cliente, qu√© respondes t√∫ como terapeuta, y por qu√© eliges esa intervenci√≥n.',
    placeholder: 'Contexto del caso:\n\nCliente: "___"\nTerapeuta: "___" (Raz√≥n: ...)\nCliente: "___"\nTerapeuta: "___" (Raz√≥n: ...)\n...',
    reflection: 'Has completado el entrenamiento. La defusi√≥n competente no es un repertorio de t√©cnicas ‚Äî es la capacidad de discriminar cu√°ndo y c√≥mo alterar la relaci√≥n funcional entre el lenguaje y la conducta. Sigue practicando con casos reales y supervisi√≥n.'
  }
  ]
}
];

// ============================================================
// APP STATE & LOGIC
// ============================================================
const TOTAL_EXERCISES = LEVELS.reduce((sum, l) => sum + l.exercises.length, 0);
let state = loadState();

function loadState() {
  try {
    const saved = localStorage.getItem('defusion_app_state');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return { completed: {}, scores: {}, currentLevel: 0, currentExercise: 0 };
}

function saveState() {
  try { localStorage.setItem('defusion_app_state', JSON.stringify(state)); } catch(e) {}
}

function getCompletedCount() {
  return Object.keys(state.completed).length;
}

function isExerciseCompleted(levelIdx, exIdx) {
  return state.completed[`${levelIdx}-${exIdx}`] === true;
}

function completeExercise(levelIdx, exIdx, correct) {
  state.completed[`${levelIdx}-${exIdx}`] = true;
  if (!state.scores[levelIdx]) state.scores[levelIdx] = { correct: 0, total: 0 };
  state.scores[levelIdx].total++;
  if (correct) state.scores[levelIdx].correct++;
  saveState();
}

function isLevelUnlocked(idx) {
  if (idx === 0) return true;
  const prevLevel = LEVELS[idx - 1];
  const prevCompleted = prevLevel.exercises.filter((_, ei) => isExerciseCompleted(idx - 1, ei)).length;
  return prevCompleted >= Math.ceil(prevLevel.exercises.length * 0.6); // 60% to unlock next
}

function isLevelCompleted(idx) {
  return LEVELS[idx].exercises.every((_, ei) => isExerciseCompleted(idx, ei));
}

function getLevelProgress(idx) {
  const completed = LEVELS[idx].exercises.filter((_, ei) => isExerciseCompleted(idx, ei)).length;
  return { completed, total: LEVELS[idx].exercises.length };
}

// ============================================================
// GLOSSARY: Technical terms with definitions and examples
// ============================================================
const GLOSSARY = {
  'pliance': {
    title: 'Pliance',
    def: 'Conducta gobernada por reglas donde la persona sigue la regla porque hay una historia de reforzamiento social por obedecer, no porque la regla describa contingencias reales.',
    example: '"Un hombre no llora" ‚Üí el ni√±o aprende a suprimir el llanto porque el padre refuerza no llorar, no porque llorar tenga consecuencias naturales negativas.'
  },
  'augmental': {
    title: 'Augmental',
    def: 'Regla verbal que altera la capacidad reforzante o aversiva de un est√≠mulo a trav√©s de la transformaci√≥n de funciones. Cambia cu√°nto te importa algo.',
    example: '"Si no apruebo este examen, mi vida se arruinar√°" ‚Üí el examen adquiere funciones aversivas amplificadas que no corresponden a las contingencias reales.'
  },
  'tracking': {
    title: 'Tracking',
    def: 'Conducta gobernada por reglas donde la persona sigue la regla porque describe contingencias naturales precisas. Es sensible a las consecuencias directas.',
    example: '"Si toco la estufa caliente me quemar√©" ‚Üí la regla describe una contingencia real y verificable. La conducta de evitar tocarla se mantiene por las consecuencias naturales.'
  },
  'cfunc': {
    title: 'Cfunc (C-funcional)',
    def: 'La funci√≥n conductual que se transforma a trav√©s de una relaci√≥n derivada. Es lo que el pensamiento "te hace hacer o sentir". Cuando domina Cfunc, est√°s fusionado.',
    example: 'Pensar "soy un fracaso" activa funciones aversivas (tristeza, evitaci√≥n) como si FUERAS literalmente un fracaso. Eso es Cfunc dominando.'
  },
  'crel': {
    title: 'Crel (C-relacional)',
    def: 'El tipo de relaci√≥n derivada en s√≠ misma (coordinaci√≥n, oposici√≥n, jerarqu√≠a, etc.). Cuando domina Crel, notas la relaci√≥n COMO relaci√≥n ‚Äî eso es defusi√≥n.',
    example: 'Notar "mi mente est√° produciendo una relaci√≥n de coordinaci√≥n entre yo y fracaso" es responder a Crel: ves la relaci√≥n sin quedar atrapado en sus funciones.'
  },
  'marco de√≠ctico': {
    title: 'Marco de√≠ctico',
    def: 'Relaci√≥n de perspectiva basada en yo/t√∫, aqu√≠/all√≠, ahora/entonces. En ACT permite distinguir al observador (yo-aqu√≠-ahora) de lo observado (pensamiento-all√°).',
    example: '"YO estoy AQU√ç notando que ALL√Å hay un pensamiento sobre fracaso" ‚Äî establece una perspectiva que separa funcionalmente a la persona del contenido verbal.'
  },
  'marco jer√°rquico': {
    title: 'Marco jer√°rquico',
    def: 'Relaci√≥n donde un elemento contiene a otro. En ACT se usa para establecer que el yo contiene a los pensamientos, no al rev√©s.',
    example: 'En la met√°fora del tablero: T√ö (tablero) contienes a los pensamientos (fichas). El tablero es m√°s grande que cualquier ficha ‚Äî no puede ser destruido por ellas.'
  },
  'extinci√≥n respondiente': {
    title: 'Extinci√≥n respondiente',
    def: 'Debilitamiento de una respuesta condicionada al presentar el est√≠mulo repetidamente sin el referente original. La palabra pierde su capacidad de evocar funciones.',
    example: 'Repetir "lim√≥n" 45 segundos ‚Üí al inicio evoca sabor √°cido y salivaci√≥n, al final es solo un sonido. La transformaci√≥n de funciones se debilit√≥ temporalmente.'
  },
  'contracondicionamiento': {
    title: 'Contracondicionamiento',
    def: 'Proceso donde se asocian funciones incompatibles con las originales. El est√≠mulo verbal adquiere nuevas funciones que compiten con las aversivas.',
    example: 'Cantar "soy un perdedor" con melod√≠a de cumplea√±os: la alegr√≠a de la melod√≠a es incompatible con la tristeza del pensamiento, debilitando su impacto.'
  },
  'reforzamiento diferencial': {
    title: 'Reforzamiento diferencial',
    def: 'Reforzar selectivamente la conducta deseada (actuar sin fusionarse) mientras se extingue la no deseada (actuar desde la fusi√≥n).',
    example: 'El terapeuta refuerza socialmente cuando el cliente nota un pensamiento y elige actuar seg√∫n valores, y no refuerza cuando el cliente obedece al pensamiento.'
  },
  'autocl√≠tico descriptivo': {
    title: 'Autocl√≠tico descriptivo',
    def: 'En an√°lisis verbal de Skinner, un autocl√≠tico es una respuesta verbal sobre la propia conducta verbal. El "descriptivo" describe el proceso sin cambiarlo.',
    example: '"Estoy teniendo el pensamiento de que no sirvo" ‚Äî describe la conducta verbal (tener el pensamiento) sin alterar el contenido. Introduce perspectiva.'
  },
  'roe-m': {
    title: 'ROE-M',
    def: 'Unidad de an√°lisis propuesta por Harte & Barnes-Holmes (2023): Relating (derivar relaciones), Orienting (dirigir atenci√≥n), Evoking (activar funciones) y Motivating (mantener el patr√≥n).',
    example: 'Pensamiento "soy peligroso": R=relaci√≥n yo-peligro, O=atenci√≥n a se√±ales de amenaza interna, E=ansiedad y escape, M=alivio de evitar refuerza el patr√≥n.'
  },
  'transformaci√≥n de funciones': {
    title: 'Transformaci√≥n de funciones',
    def: 'Proceso central de RFT: las funciones de un est√≠mulo se transfieren a otro a trav√©s de relaciones derivadas, sin contacto directo con contingencias.',
    example: 'Si aprendes que A=B y B produce miedo, A tambi√©n producir√° miedo sin haber sido emparejado directamente. La palabra "c√°ncer" evoca miedo sin tener la enfermedad.'
  },
  'yo-como-contexto': {
    title: 'Yo-como-contexto (Self-as-context)',
    def: 'Perspectiva estable del yo como el "lugar" donde ocurren las experiencias, no como las experiencias mismas. Es el tablero, no las fichas.',
    example: '"He tenido miles de pensamientos diferentes en mi vida, algunos se contradicen. Si yo fuera mis pensamientos, ¬øcu√°l ser√≠a yo? Yo soy el que observa todos esos pensamientos."'
  },
  'desesperanza creativa': {
    title: 'Desesperanza creativa',
    def: 'Fase de ACT donde el cliente contacta experiencialmente que sus estrategias de control/evitaci√≥n no han funcionado. No es generar desesperanza, sino notar que la lucha es el problema.',
    example: '"Has intentado no pensar en eso, distraerte, beber, trabajar m√°s... ¬øC√≥mo te ha ido? ¬øAlguna de esas estrategias resolvi√≥ el problema a largo plazo?"'
  },
  'flexibilidad psicol√≥gica': {
    title: 'Flexibilidad psicol√≥gica',
    def: 'Capacidad de contactar el momento presente plenamente, con apertura a los eventos privados, y actuar en direcci√≥n a los valores. Es el objetivo central de ACT.',
    example: 'Sentir ansiedad ante una presentaci√≥n (aceptaci√≥n), notar el pensamiento "va a salir mal" sin obedecerlo (defusi√≥n), y presentar igual porque es importante (valores + acci√≥n).'
  },
  'comportamiento gobernado por reglas': {
    title: 'Comportamiento gobernado por reglas',
    def: 'Conducta controlada por est√≠mulos verbales (reglas) m√°s que por las contingencias directas del ambiente. Incluye pliance, tracking y augmenting.',
    example: '"No debo mostrar debilidad" controla la conducta de suprimir emociones, independientemente de si mostrar emociones realmente produce consecuencias negativas en el contexto actual.'
  }
};

// Process text to add glossary tooltips
function addGlossaryTerms(html) {
  if (!html) return '';
  // Sort terms by length (longest first) to avoid partial matches
  const terms = Object.keys(GLOSSARY).sort((a, b) => b.length - a.length);
  
  // Split html into tags and text segments to only process text
  const parts = html.split(/(<[^>]+>)/);
  
  for (let p = 0; p < parts.length; p++) {
    // Skip HTML tags
    if (parts[p].startsWith('<')) continue;
    
    let text = parts[p];
    terms.forEach(term => {
      const escaped = term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      const regex = new RegExp(`\\b(${escaped})\\b`, 'gi');
      text = text.replace(regex, (match) => {
        return `<span class="glossary-term" data-term="${term}">${match}</span>`;
      });
    });
    parts[p] = text;
  }
  
  return parts.join('');
}

// Show tooltip for a glossary term
function showGlossaryTooltip(termEl) {
  closeGlossaryTooltip(); // close any existing
  
  const termKey = termEl.dataset.term.toLowerCase();
  const entry = GLOSSARY[termKey];
  if (!entry) return;
  
  // Create overlay to catch outside clicks
  const overlay = document.createElement('div');
  overlay.className = 'glossary-overlay';
  overlay.addEventListener('click', closeGlossaryTooltip);
  document.body.appendChild(overlay);
  
  // Create tooltip
  const tooltip = document.createElement('div');
  tooltip.className = 'glossary-tooltip';
  tooltip.id = 'activeGlossaryTooltip';
  tooltip.innerHTML = `
    <button class="gt-close" onclick="closeGlossaryTooltip()">‚úï</button>
    <div class="gt-title">${entry.title}</div>
    <div class="gt-def">${entry.def}</div>
    <div class="gt-example">${entry.example}</div>
  `;
  document.body.appendChild(tooltip);
  
  // Position tooltip near the term
  const rect = termEl.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  let top = rect.bottom + 10;
  let left = Math.max(10, rect.left - 20);
  let isAbove = false;
  
  // If tooltip would go below viewport, show above
  if (top + tooltipRect.height > window.innerHeight - 20) {
    top = rect.top - tooltipRect.height - 10;
    isAbove = true;
    tooltip.classList.add('above');
  }
  
  // Keep within horizontal bounds
  if (left + tooltipRect.width > window.innerWidth - 10) {
    left = window.innerWidth - tooltipRect.width - 10;
  }
  
  tooltip.style.top = top + 'px';
  tooltip.style.left = left + 'px';
  
  // Adjust arrow position to point at term
  const arrowLeft = Math.max(15, Math.min(rect.left - left + rect.width/2 - 6, tooltipRect.width - 25));
  const beforeStyle = document.createElement('style');
  beforeStyle.id = 'glossary-arrow-style';
  const oldArrow = document.getElementById('glossary-arrow-style');
  if (oldArrow) oldArrow.remove();
  beforeStyle.textContent = `.glossary-tooltip::before { left: ${arrowLeft}px !important; }`;
  document.head.appendChild(beforeStyle);
}

function closeGlossaryTooltip() {
  const existing = document.getElementById('activeGlossaryTooltip');
  if (existing) existing.remove();
  const overlay = document.querySelector('.glossary-overlay');
  if (overlay) overlay.remove();
}

// Delegate click events for glossary terms
document.addEventListener('click', (e) => {
  const term = e.target.closest('.glossary-term');
  if (term) {
    e.preventDefault();
    e.stopPropagation();
    showGlossaryTooltip(term);
  }
});

// ============================================================
// RENDER FUNCTIONS
// ============================================================
function renderHome() {
  document.getElementById('homeView').classList.add('active');
  document.getElementById('exerciseView').classList.remove('active');
  document.getElementById('completeView').classList.remove('active');
  
  // Global progress
  const done = getCompletedCount();
  document.getElementById('globalFill').style.width = `${(done / TOTAL_EXERCISES) * 100}%`;
  document.getElementById('globalText').textContent = `${done} / ${TOTAL_EXERCISES}`;
  
  // Level cards
  const grid = document.getElementById('levelsGrid');
  grid.innerHTML = '';
  LEVELS.forEach((level, idx) => {
    const unlocked = isLevelUnlocked(idx);
    const completed = isLevelCompleted(idx);
    const prog = getLevelProgress(idx);
    
    const card = document.createElement('div');
    card.className = `level-card ${!unlocked ? 'locked' : ''} ${completed ? 'completed' : ''}`;
    card.innerHTML = `
      <div class="level-header">
        <div class="level-icon">${level.icon}</div>
        <div class="level-info">
          <div class="level-num">Nivel ${idx + 1}</div>
          <div class="level-title">${level.title}</div>
        </div>
      </div>
      <div class="level-desc">${level.subtitle}</div>
      <div class="level-progress">
        <div class="level-progress-bar"><div class="level-progress-fill" style="width:${(prog.completed/prog.total)*100}%"></div></div>
        <div class="level-progress-text">${prog.completed} / ${prog.total} ejercicios</div>
      </div>
      ${!unlocked ? '<div class="level-lock-badge">üîí Completa el anterior</div>' : ''}
      ${completed ? '<div class="level-complete-badge">‚úì Completado</div>' : ''}
    `;
    if (unlocked) {
      card.addEventListener('click', () => startLevel(idx));
    }
    grid.appendChild(card);
  });
}

function startLevel(levelIdx) {
  state.currentLevel = levelIdx;
  // Find first incomplete exercise
  const level = LEVELS[levelIdx];
  let startEx = 0;
  for (let i = 0; i < level.exercises.length; i++) {
    if (!isExerciseCompleted(levelIdx, i)) { startEx = i; break; }
    if (i === level.exercises.length - 1) startEx = 0; // all complete, restart
  }
  state.currentExercise = startEx;
  saveState();
  renderExercise();
}

function renderExercise() {
  document.getElementById('homeView').classList.remove('active');
  document.getElementById('exerciseView').classList.add('active');
  document.getElementById('completeView').classList.remove('active');
  
  const level = LEVELS[state.currentLevel];
  const ex = level.exercises[state.currentExercise];
  
  // Header
  document.getElementById('exLevelName').textContent = `Nivel ${state.currentLevel + 1} ¬∑ ${level.title}`;
  document.getElementById('exTitle').textContent = ex.title;
  document.getElementById('exCounter').textContent = `${state.currentExercise + 1}/${level.exercises.length}`;
  
  // Dots
  const dots = document.getElementById('exDots');
  dots.innerHTML = '';
  level.exercises.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = `exercise-dot ${isExerciseCompleted(state.currentLevel, i) ? 'done' : ''} ${i === state.currentExercise ? 'current' : ''}`;
    dot.addEventListener('click', () => { state.currentExercise = i; saveState(); renderExercise(); });
    dots.appendChild(dot);
  });
  
  // Content
  const content = document.getElementById('exerciseContent');
  const actions = document.getElementById('exerciseActions');
  content.innerHTML = '';
  actions.innerHTML = '';
  
  // Concept box for first exercise of each level
  if (state.currentExercise === 0 && level.concept) {
    content.innerHTML += `
      <div class="concept-box anim-fade-up">
        <h4>${level.concept.title}</h4>
        <p>${addGlossaryTerms(level.concept.text)}</p>
      </div>
    `;
  }
  
  switch(ex.type) {
    case 'single': renderSingleChoice(ex, content, actions); break;
    case 'multi': renderMultiChoice(ex, content, actions); break;
    case 'matching': renderMatching(ex, content, actions); break;
    case 'ordering': renderOrdering(ex, content, actions); break;
    case 'classify': renderClassify(ex, content, actions); break;
    case 'dialogue': renderDialogue(ex, content, actions); break;
    case 'sandbox': renderSandbox(ex, content, actions); break;
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// === SINGLE CHOICE ===
function renderSingleChoice(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    ${ex.scenario ? `<div class="scenario">${addGlossaryTerms(ex.scenario)}</div>` : ''}
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <div class="options" id="optionsContainer"></div>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  const opts = card.querySelector('#optionsContainer');
  const letters = ['A','B','C','D','E','F'];
  let answered = false;
  
  ex.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerHTML = `<span class="opt-letter">${letters[i]}</span><span class="opt-text">${addGlossaryTerms(opt.text)}</span>`;
    btn.addEventListener('click', () => {
      if (answered) return;
      answered = true;
      
      // Mark all
      opts.querySelectorAll('.option-btn').forEach((b, j) => {
        b.classList.add('disabled');
        if (ex.options[j].correct) b.classList.add('correct');
        if (j === i && !opt.correct) b.classList.add('incorrect');
      });
      
      showFeedback(card.querySelector('#feedbackArea'), opt.correct, ex.feedback);
      completeExercise(state.currentLevel, state.currentExercise, opt.correct);
      showNextButton(actions);
    });
    opts.appendChild(btn);
  });
}

// === MULTI CHOICE ===
function renderMultiChoice(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    ${ex.scenario ? `<div class="scenario">${addGlossaryTerms(ex.scenario)}</div>` : ''}
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <div class="options" id="optionsContainer"></div>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  const opts = card.querySelector('#optionsContainer');
  const letters = ['A','B','C','D','E','F'];
  const selected = new Set();
  let answered = false;
  
  ex.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn multi';
    btn.innerHTML = `<span class="opt-letter">${letters[i]}</span><span class="opt-text">${addGlossaryTerms(opt.text)}</span>`;
    btn.addEventListener('click', () => {
      if (answered) return;
      if (selected.has(i)) { selected.delete(i); btn.classList.remove('selected'); }
      else { selected.add(i); btn.classList.add('selected'); }
    });
    opts.appendChild(btn);
  });
  
  // Check button
  const checkBtn = document.createElement('button');
  checkBtn.className = 'btn-check';
  checkBtn.textContent = 'Verificar respuesta';
  checkBtn.addEventListener('click', () => {
    if (answered || selected.size === 0) return;
    answered = true;
    
    const correctSet = new Set(ex.options.map((o, i) => o.correct ? i : -1).filter(i => i >= 0));
    const isCorrect = selected.size === correctSet.size && [...selected].every(i => correctSet.has(i));
    
    opts.querySelectorAll('.option-btn').forEach((b, j) => {
      b.classList.add('disabled');
      if (ex.options[j].correct) b.classList.add('correct');
      if (selected.has(j) && !ex.options[j].correct) b.classList.add('incorrect');
    });
    
    showFeedback(card.querySelector('#feedbackArea'), isCorrect, ex.feedback);
    completeExercise(state.currentLevel, state.currentExercise, isCorrect);
    checkBtn.remove();
    showNextButton(actions);
  });
  actions.appendChild(checkBtn);
}

// === MATCHING ===
function renderMatching(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <div class="matching-grid" id="matchingGrid"></div>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  const grid = card.querySelector('#matchingGrid');
  const rights = ex.pairs.map(p => p.right);
  const shuffled = [...rights].sort(() => Math.random() - 0.5);
  let answered = false;
  
  ex.pairs.forEach((pair, i) => {
    const row = document.createElement('div');
    row.className = 'matching-row';
    row.innerHTML = `
      <div class="matching-label">${addGlossaryTerms(pair.left)}</div>
      <select class="matching-select" data-idx="${i}">
        <option value="">Seleccionar...</option>
        ${shuffled.map(r => `<option value="${r}">${r.length > 35 ? r.substring(0,35)+'...' : r}</option>`).join('')}
      </select>
    `;
    grid.appendChild(row);
  });
  
  const checkBtn = document.createElement('button');
  checkBtn.className = 'btn-check';
  checkBtn.textContent = 'Verificar respuestas';
  checkBtn.addEventListener('click', () => {
    if (answered) return;
    const selects = grid.querySelectorAll('select');
    const allFilled = [...selects].every(s => s.value !== '');
    if (!allFilled) return;
    
    answered = true;
    let allCorrect = true;
    selects.forEach((s, i) => {
      const row = s.closest('.matching-row');
      s.disabled = true;
      if (s.value === ex.pairs[i].right) {
        row.classList.add('correct');
      } else {
        row.classList.add('incorrect');
        allCorrect = false;
      }
    });
    
    showFeedback(card.querySelector('#feedbackArea'), allCorrect, ex.feedback);
    completeExercise(state.currentLevel, state.currentExercise, allCorrect);
    checkBtn.remove();
    showNextButton(actions);
  });
  actions.appendChild(checkBtn);
}

// === ORDERING ===
function renderOrdering(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <div class="ordering-list" id="orderingList"></div>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  let items = [...ex.items].sort(() => Math.random() - 0.5);
  let answered = false;
  
  function renderOrderList() {
    const list = card.querySelector('#orderingList');
    list.innerHTML = '';
    items.forEach((item, i) => {
      const el = document.createElement('div');
      el.className = 'ordering-item';
      el.innerHTML = `
        <span class="order-num">${i + 1}</span>
        <span style="flex:1">${addGlossaryTerms(item.text)}</span>
        <div class="ordering-arrows">
          <button class="arrow-btn" data-dir="up" data-idx="${i}" ${i === 0 ? 'disabled' : ''}>‚ñ≤</button>
          <button class="arrow-btn" data-dir="down" data-idx="${i}" ${i === items.length-1 ? 'disabled' : ''}>‚ñº</button>
        </div>
      `;
      list.appendChild(el);
    });
    
    list.querySelectorAll('.arrow-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (answered) return;
        const idx = parseInt(btn.dataset.idx);
        const dir = btn.dataset.dir;
        if (dir === 'up' && idx > 0) { [items[idx], items[idx-1]] = [items[idx-1], items[idx]]; }
        if (dir === 'down' && idx < items.length-1) { [items[idx], items[idx+1]] = [items[idx+1], items[idx]]; }
        renderOrderList();
      });
    });
  }
  renderOrderList();
  
  const checkBtn = document.createElement('button');
  checkBtn.className = 'btn-check';
  checkBtn.textContent = 'Verificar orden';
  checkBtn.addEventListener('click', () => {
    if (answered) return;
    answered = true;
    
    const isCorrect = items.every((item, i) => item.order === i + 1);
    const list = card.querySelector('#orderingList');
    list.querySelectorAll('.ordering-item').forEach((el, i) => {
      el.querySelectorAll('.arrow-btn').forEach(b => b.disabled = true);
      if (items[i].order === i + 1) el.classList.add('correct-pos');
      else el.classList.add('incorrect-pos');
    });
    
    showFeedback(card.querySelector('#feedbackArea'), isCorrect, ex.feedback);
    completeExercise(state.currentLevel, state.currentExercise, isCorrect);
    checkBtn.remove();
    showNextButton(actions);
  });
  actions.appendChild(checkBtn);
}

// === CLASSIFY ===
function renderClassify(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <div class="classify-items" id="classifyItems"></div>
    <div class="classify-zones" id="classifyZones"></div>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  const chipsArea = card.querySelector('#classifyItems');
  const zonesArea = card.querySelector('#classifyZones');
  let selectedChip = null;
  let placements = {};
  let answered = false;
  
  // Create zones
  ex.categories.forEach((cat, ci) => {
    const zone = document.createElement('div');
    zone.className = 'classify-zone';
    zone.dataset.cat = ci;
    zone.innerHTML = `<div class="classify-zone-title">${cat}</div><div class="classify-zone-items" id="zone${ci}"></div>`;
    zone.addEventListener('click', () => {
      if (answered || selectedChip === null) return;
      const zoneItems = zone.querySelector('.classify-zone-items');
      const item = document.createElement('span');
      item.className = 'classify-zone-item';
      item.textContent = ex.items[selectedChip].text.substring(0, 50) + (ex.items[selectedChip].text.length > 50 ? '...' : '');
      item.dataset.idx = selectedChip;
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        if (answered) return;
        delete placements[item.dataset.idx];
        chipsArea.querySelector(`[data-idx="${item.dataset.idx}"]`).classList.remove('placed');
        item.remove();
      });
      zoneItems.appendChild(item);
      placements[selectedChip] = ci;
      chipsArea.querySelector(`[data-idx="${selectedChip}"]`).classList.add('placed');
      selectedChip = null;
      chipsArea.querySelectorAll('.classify-chip').forEach(c => c.style.outline = '');
    });
    zonesArea.appendChild(zone);
  });
  
  // Create chips
  const shuffledItems = ex.items.map((item, i) => ({ ...item, origIdx: i })).sort(() => Math.random() - 0.5);
  shuffledItems.forEach(item => {
    const chip = document.createElement('span');
    chip.className = 'classify-chip';
    chip.textContent = item.text;
    chip.dataset.idx = item.origIdx;
    chip.addEventListener('click', () => {
      if (answered || chip.classList.contains('placed')) return;
      chipsArea.querySelectorAll('.classify-chip').forEach(c => c.style.outline = '');
      selectedChip = item.origIdx;
      chip.style.outline = '2px solid var(--gold)';
    });
    chipsArea.appendChild(chip);
  });
  
  const checkBtn = document.createElement('button');
  checkBtn.className = 'btn-check';
  checkBtn.textContent = 'Verificar clasificaci√≥n';
  checkBtn.addEventListener('click', () => {
    if (answered || Object.keys(placements).length < ex.items.length) return;
    answered = true;
    
    let allCorrect = true;
    Object.entries(placements).forEach(([idx, cat]) => {
      const chip = chipsArea.querySelector(`[data-idx="${idx}"]`);
      if (parseInt(cat) === ex.items[idx].cat) {
        chip.classList.add('correct-chip');
      } else {
        chip.classList.add('incorrect-chip');
        allCorrect = false;
      }
    });
    
    showFeedback(card.querySelector('#feedbackArea'), allCorrect, ex.feedback);
    completeExercise(state.currentLevel, state.currentExercise, allCorrect);
    checkBtn.remove();
    showNextButton(actions);
  });
  actions.appendChild(checkBtn);
}

// === DIALOGUE ===
function renderDialogue(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  
  const titleEl = document.createElement('h3');
  titleEl.textContent = ex.title;
  card.appendChild(titleEl);
  
  if (ex.intro) {
    const introEl = document.createElement('p');
    introEl.className = 'instruction';
    introEl.innerHTML = addGlossaryTerms(ex.intro);
    card.appendChild(introEl);
  }
  
  // Start button
  const startBtn = document.createElement('button');
  startBtn.className = 'btn-primary';
  startBtn.style.cssText = 'margin-top:16px; margin-bottom:8px;';
  startBtn.textContent = '‚ñ∂ Comenzar la sesi√≥n';
  card.appendChild(startBtn);
  
  const dialogueArea = document.createElement('div');
  dialogueArea.id = 'dialogueArea';
  dialogueArea.style.display = 'none';
  card.appendChild(dialogueArea);
  
  const feedbackArea = document.createElement('div');
  feedbackArea.id = 'feedbackArea';
  card.appendChild(feedbackArea);
  
  content.appendChild(card);
  
  let stepIdx = 0;
  let correctCount = 0;
  let totalChoices = 0;
  
  startBtn.addEventListener('click', () => {
    startBtn.style.display = 'none';
    dialogueArea.style.display = 'block';
    renderStep();
  });
  
  function renderStep() {
    if (stepIdx >= ex.steps.length) {
      // Dialogue complete
      const isCorrect = correctCount === totalChoices;
      showFeedback(card.querySelector('#feedbackArea'), isCorrect, ex.feedback);
      completeExercise(state.currentLevel, state.currentExercise, isCorrect);
      showNextButton(actions);
      return;
    }
    
    const step = ex.steps[stepIdx];
    
    if (step.speaker === 'client') {
      const bubble = document.createElement('div');
      bubble.className = 'dialogue-bubble client';
      bubble.innerHTML = `<div class="bubble-name">${step.name || 'Cliente'}</div>${addGlossaryTerms(step.text)}`;
      dialogueArea.appendChild(bubble);
      stepIdx++;
      setTimeout(renderStep, 300);
    }
    else if (step.speaker === 'therapist') {
      const bubble = document.createElement('div');
      bubble.className = 'dialogue-bubble therapist';
      bubble.innerHTML = `<div class="bubble-name">T√∫ (Terapeuta)</div>${step.text}`;
      dialogueArea.appendChild(bubble);
      stepIdx++;
      setTimeout(renderStep, 300);
    }
    else if (step.speaker === 'choose') {
      totalChoices++;
      const choiceDiv = document.createElement('div');
      choiceDiv.className = 'dialogue-choices';
      choiceDiv.innerHTML = `<p class="instruction" style="margin-bottom:10px">${addGlossaryTerms(step.instruction)}</p>`;
      
      const opts = document.createElement('div');
      opts.className = 'options';
      const letters = ['A','B','C'];
      let chosen = false;
      
      step.options.forEach((opt, oi) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `<span class="opt-letter">${letters[oi]}</span><span class="opt-text">${addGlossaryTerms(opt.text)}</span>`;
        btn.addEventListener('click', () => {
          if (chosen) return;
          chosen = true;
          
          opts.querySelectorAll('.option-btn').forEach((b, j) => {
            b.classList.add('disabled');
            if (step.options[j].correct) b.classList.add('correct');
            if (j === oi && !opt.correct) b.classList.add('incorrect');
          });
          
          if (opt.correct) correctCount++;
          
          // Show why if incorrect
          if (!opt.correct && opt.why) {
            const whyBox = document.createElement('div');
            whyBox.className = 'feedback-box incorrect';
            whyBox.innerHTML = `<div class="fb-explanation">${addGlossaryTerms(opt.why)}</div>`;
            opts.after(whyBox);
          }
          
          // Show response
          if (opt.response) {
            setTimeout(() => {
              const respBubble = document.createElement('div');
              respBubble.className = `dialogue-bubble ${opt.response.speaker || 'client'}`;
              respBubble.innerHTML = `<div class="bubble-name">${opt.response.name || 'Cliente'}</div>${opt.response.text}`;
              dialogueArea.appendChild(respBubble);
              
              stepIdx++;
              setTimeout(renderStep, 500);
            }, 400);
          } else {
            stepIdx++;
            setTimeout(renderStep, 300);
          }
        });
        opts.appendChild(btn);
      });
      
      choiceDiv.appendChild(opts);
      dialogueArea.appendChild(choiceDiv);
    }
    
    dialogueArea.scrollTop = dialogueArea.scrollHeight;
  }
}

// === SANDBOX ===
function renderSandbox(ex, content, actions) {
  const card = document.createElement('div');
  card.className = 'exercise-card anim-fade-up';
  card.innerHTML = `
    <h3>${ex.title}</h3>
    <p class="instruction">${addGlossaryTerms(ex.instruction)}</p>
    <textarea class="sandbox-area" placeholder="${ex.placeholder || 'Escribe aqu√≠ tu reflexi√≥n...'}" id="sandboxText"></textarea>
    <p class="sandbox-hint">Este ejercicio es para tu reflexi√≥n personal. Se completa al escribir tu respuesta.</p>
    <div id="feedbackArea"></div>
  `;
  content.appendChild(card);
  
  const doneBtn = document.createElement('button');
  doneBtn.className = 'btn-check';
  doneBtn.textContent = 'Completar reflexi√≥n';
  doneBtn.addEventListener('click', () => {
    const text = document.getElementById('sandboxText').value.trim();
    if (text.length < 10) return;
    
    const fb = card.querySelector('#feedbackArea');
    fb.innerHTML = `
      <div class="feedback-box correct">
        <div class="fb-title">‚úì Reflexi√≥n completada</div>
        <div class="fb-explanation">${addGlossaryTerms(ex.reflection)}</div>
      </div>
    `;
    
    completeExercise(state.currentLevel, state.currentExercise, true);
    doneBtn.remove();
    showNextButton(actions);
  });
  actions.appendChild(doneBtn);
}

// === HELPERS ===
function showFeedback(container, isCorrect, feedback) {
  if (!container || !feedback) return;
  const fb = feedback;
  container.innerHTML = `
    <div class="feedback-box ${isCorrect ? 'correct' : 'incorrect'}">
      <div class="fb-title">${isCorrect ? '‚úì ¬°Correcto!' : '‚úó No exactamente'}</div>
      <div class="fb-explanation">${addGlossaryTerms(isCorrect ? fb.correct : fb.incorrect)}</div>
      ${fb.process ? `<div class="fb-process">üî¨ ${addGlossaryTerms(fb.process)}</div>` : ''}
    </div>
  `;
}

function showNextButton(actions) {
  const level = LEVELS[state.currentLevel];
  const isLast = state.currentExercise >= level.exercises.length - 1;
  
  const btn = document.createElement('button');
  btn.className = 'btn-primary';
  btn.textContent = isLast ? 'Finalizar nivel' : 'Siguiente ejercicio ‚Üí';
  btn.style.marginTop = '16px';
  btn.addEventListener('click', () => {
    if (isLast) {
      showLevelComplete();
    } else {
      state.currentExercise++;
      saveState();
      renderExercise();
    }
  });
  actions.appendChild(btn);
}

function showLevelComplete() {
  document.getElementById('homeView').classList.remove('active');
  document.getElementById('exerciseView').classList.remove('active');
  document.getElementById('completeView').classList.add('active');
  
  const level = LEVELS[state.currentLevel];
  const score = state.scores[state.currentLevel] || { correct: 0, total: 0 };
  const pct = score.total > 0 ? Math.round((score.correct / score.total) * 100) : 100;
  
  document.getElementById('completeTitle').textContent = `¬°${level.title} completado!`;
  document.getElementById('completeScore').textContent = `${score.correct}/${score.total} respuestas correctas (${pct}%)`;
  
  let msg = '';
  if (pct >= 80) msg = 'Excelente comprensi√≥n. Est√°s listo para el siguiente nivel.';
  else if (pct >= 60) msg = 'Buen trabajo. Puedes avanzar, pero considera repasar los ejercicios donde fallaste.';
  else msg = 'Hay conceptos por reforzar. Te recomiendo repetir este nivel antes de avanzar.';
  document.getElementById('completeMsg').textContent = msg;
  
  const nextBtn = document.getElementById('btnNextLevel');
  if (state.currentLevel < LEVELS.length - 1) {
    nextBtn.style.display = 'block';
    nextBtn.textContent = `Ir al Nivel ${state.currentLevel + 2}: ${LEVELS[state.currentLevel + 1].title}`;
    nextBtn.onclick = () => startLevel(state.currentLevel + 1);
  } else {
    nextBtn.style.display = 'block';
    nextBtn.textContent = 'üéâ ¬°Entrenamiento completo!';
    nextBtn.onclick = () => renderHome();
  }
  
  document.getElementById('btnRetry').onclick = () => {
    // Reset level scores
    LEVELS[state.currentLevel].exercises.forEach((_, i) => {
      delete state.completed[`${state.currentLevel}-${i}`];
    });
    delete state.scores[state.currentLevel];
    saveState();
    startLevel(state.currentLevel);
  };
  
  document.getElementById('btnGoHome').onclick = () => renderHome();
  
  // Confetti
  if (pct >= 60) launchConfetti();
}

// ============================================================
// CONFETTI
// ============================================================
function launchConfetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  
  const pieces = [];
  const colors = ['#f0b429','#3498db','#2ecc71','#e74c3c','#ffd54f','#5dade2'];
  
  for (let i = 0; i < 80; i++) {
    pieces.push({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 200,
      w: 6 + Math.random() * 6,
      h: 4 + Math.random() * 4,
      color: colors[Math.floor(Math.random() * colors.length)],
      vy: 2 + Math.random() * 3,
      vx: -1 + Math.random() * 2,
      rot: Math.random() * Math.PI * 2,
      vrot: -0.05 + Math.random() * 0.1
    });
  }
  
  let frame = 0;
  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vrot;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });
    frame++;
    if (frame < 180) requestAnimationFrame(animate);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  animate();
}

// ============================================================
// EVENT LISTENERS
// ============================================================
document.getElementById('btnBack').addEventListener('click', renderHome);

document.getElementById('btnResetAll').addEventListener('click', function() {
  const btn = this;
  if (btn.dataset.confirm === 'true') {
    state = { completed: {}, scores: {}, currentLevel: 0, currentExercise: 0 };
    try { localStorage.removeItem('defusion_app_state'); } catch(e) {}
    saveState();
    btn.dataset.confirm = 'false';
    btn.textContent = '‚úì Progreso reiniciado';
    btn.style.borderColor = 'var(--green)';
    btn.style.color = 'var(--green)';
    setTimeout(() => {
      btn.innerHTML = '‚Ü∫ Reiniciar todo el progreso';
      btn.style.borderColor = '';
      btn.style.color = '';
      renderHome();
    }, 1200);
  } else {
    btn.dataset.confirm = 'true';
    btn.innerHTML = '‚ö† Toca de nuevo para confirmar';
    btn.style.borderColor = 'var(--red)';
    btn.style.color = 'var(--red)';
    setTimeout(() => {
      btn.dataset.confirm = 'false';
      btn.innerHTML = '‚Ü∫ Reiniciar todo el progreso';
      btn.style.borderColor = '';
      btn.style.color = '';
    }, 3000);
  }
});

// Feedback form
document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const textarea = form.querySelector('textarea');
  if (!textarea.value.trim()) return;
  
  try {
    await fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
      headers: { 'Accept': 'application/json' }
    });
    textarea.value = '';
    document.getElementById('sendOk').style.display = 'block';
    setTimeout(() => { document.getElementById('sendOk').style.display = 'none'; }, 4000);
  } catch(err) {
    alert('Error al enviar. Intenta de nuevo.');
  }
});

// ============================================================
// INIT
// ============================================================
renderHome();
</script>

</body>
</html>
