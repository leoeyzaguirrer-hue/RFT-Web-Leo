<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DBT Simulador ¬∑ Entrenamiento Cl√≠nico</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#08141E;--surface:#0F2035;--surface2:#172C48;--surface3:#1E3A5F;
  --accent:#F5C518;--accent2:#E8703A;--accent3:#5CB8FF;
  --correct:#3DBE8A;--wrong:#E85555;
  --text:#E2EAF4;--text-muted:#8AADCA;--text-dim:#3A5E7A;
  --patient-bg:#172C48;--border:rgba(255,255,255,0.08);
  --shadow:0 8px 32px rgba(0,0,0,0.55);--radius:18px;--radius-sm:12px;
  --fs-body:17px;--fs-sm:14px;--fs-xs:12px;--fs-h1:32px;--fs-h2:22px;--fs-h3:19px;
}
[data-theme="light"]{
  --bg:#EEF4FB;--surface:#FFFFFF;--surface2:#E0EBF7;--surface3:#CDD9EE;
  --accent:#1B3A6B;--accent2:#E8703A;--accent3:#2370C0;
  --text:#0F1E35;--text-muted:#4A6A8A;--text-dim:#9AB0C5;
  --patient-bg:#E0EBF7;--border:rgba(0,0,0,0.09);--shadow:0 8px 32px rgba(0,0,0,0.12);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-size:var(--fs-body)}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;line-height:1.6;transition:background .3s,color .3s}

.screen{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;display:none;flex-direction:column}
.screen.active{display:flex}

@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes slideRight{from{opacity:0;transform:translateX(-16px)}to{opacity:1;transform:none}}
@keyframes slideLeft{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}
@keyframes shimmer{0%,100%{opacity:.4}50%{opacity:1}}

/* ===== SHARED COMPONENTS ===== */
.back-btn{width:40px;height:40px;border-radius:50%;background:var(--surface);border:none;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;transition:all .2s}
.back-btn:hover{background:var(--surface2)}
.theme-btn{width:40px;height:40px;border-radius:50%;background:var(--surface);border:1.5px solid var(--border);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;transition:all .2s}
.btn-primary{background:var(--accent2);color:white;border:none;border-radius:var(--radius-sm);padding:17px 22px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-body);font-weight:600;cursor:pointer;transition:all .2s;text-align:center;width:100%}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-secondary{background:var(--surface);color:var(--text);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:15px 22px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-body);font-weight:500;cursor:pointer;transition:all .2s;text-align:center;width:100%}
.btn-secondary:hover{background:var(--surface2)}
.section-chip{font-size:var(--fs-xs);font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim)}
.source-tag{display:inline-block;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);font-size:11px;font-weight:600;letter-spacing:.5px;padding:3px 10px;border-radius:20px;margin-top:6px}
.highlight-box{background:var(--surface2);border-left:3px solid var(--accent3);border-radius:0 var(--radius-sm) var(--radius-sm) 0;padding:14px 16px;margin:12px 0;font-size:var(--fs-sm);color:var(--text);line-height:1.65;font-style:italic}

/* ===== HOME ===== */
#home{background:var(--bg);min-height:100%}
.home-top{padding:56px 22px 20px;display:flex;justify-content:space-between;align-items:flex-start;animation:fadeUp .5s ease both}
.brand-label{font-size:var(--fs-xs);font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:8px}
.brand-title{font-family:'Lora',serif;font-size:var(--fs-h1);font-weight:600;line-height:1.15;color:var(--text)}
.brand-title em{font-style:italic;color:var(--accent2)}
.home-desc{padding:0 22px 32px;animation:fadeUp .5s .1s ease both}
.home-desc p{color:var(--text-muted);font-size:var(--fs-body);line-height:1.65}
.home-desc strong{color:var(--text);font-weight:500}
.skills-pills{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
.pill{background:var(--surface);border:1.5px solid var(--border);color:var(--text-muted);font-size:13px;font-weight:600;letter-spacing:.3px;padding:5px 13px;border-radius:20px}
.home-nav{padding:0 18px 40px;display:flex;flex-direction:column;gap:12px}
.nav-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);cursor:pointer;overflow:hidden;transition:all .2s;animation:fadeUp .5s ease both;display:flex;align-items:stretch}
.nav-card:nth-child(1){animation-delay:.15s}
.nav-card:nth-child(2){animation-delay:.25s}
.nav-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.nav-card:active{transform:scale(.98)}
.nav-card-accent{width:5px;flex-shrink:0}
.nav-card:nth-child(1) .nav-card-accent{background:var(--accent3)}
.nav-card:nth-child(2) .nav-card-accent{background:var(--accent2)}
.nav-card-body{padding:20px 20px 20px 18px;flex:1}
.nav-card-title{font-weight:600;font-size:var(--fs-h3);margin-bottom:5px;display:flex;align-items:center;gap:9px;flex-wrap:wrap}
.nav-card-sub{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.55}
.nav-badge{font-size:11px;font-weight:700;padding:3px 9px;border-radius:12px;letter-spacing:.3px}
.badge-theory{background:rgba(92,184,255,.15);color:var(--accent3)}
.badge-practice{background:rgba(232,112,58,.15);color:var(--accent2)}

/* ===== THEORY - PAGINATED ===== */
#theory{background:var(--bg);height:100%}
#theory.active{display:flex;flex-direction:column}
.theory-top-bar{padding:52px 18px 0;background:var(--bg);flex-shrink:0}
.theory-top-inner{display:flex;align-items:center;gap:12px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.theory-top-title{font-family:'Lora',serif;font-size:var(--fs-h3);font-weight:600;flex:1}
.theory-pagination{font-size:var(--fs-xs);color:var(--text-muted);font-weight:600;letter-spacing:.5px}
.theory-progress{height:3px;background:var(--surface2);flex-shrink:0}
.theory-progress-fill{height:100%;background:var(--accent3);border-radius:2px;transition:width .4s ease}

/* Slide container */
.theory-slides{flex:1;overflow:hidden;position:relative}
.theory-slide{position:absolute;inset:0;overflow-y:auto;padding:22px 18px 20px;display:none;flex-direction:column;animation:fadeIn .3s ease}
.theory-slide.active{display:flex}

/* Slide card */
.slide-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;flex:0 0 auto}
.slide-card-head{padding:20px 20px 16px;border-bottom:1px solid var(--border)}
.slide-num{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}
.slide-title{font-family:'Lora',serif;font-size:var(--fs-h2);font-weight:600;line-height:1.25;color:var(--text)}
.slide-card-body{padding:20px}
.slide-card-body p{font-size:var(--fs-body);color:var(--text-muted);line-height:1.7;margin-bottom:14px}
.slide-card-body p:last-child{margin-bottom:0}
.slide-card-body strong{color:var(--text);font-weight:600}

/* Theory nav buttons */
.theory-nav{flex-shrink:0;padding:14px 18px 32px;display:flex;gap:10px;align-items:center}
.theory-nav .btn-secondary{flex:1}
.theory-nav .btn-primary{flex:1}
.t-nav-btn{flex:1;padding:15px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-body);font-weight:600;cursor:pointer;border-radius:var(--radius-sm);transition:all .2s;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;gap:6px}
.t-nav-prev{background:var(--surface);color:var(--text-muted)}
.t-nav-prev:hover{background:var(--surface2)}
.t-nav-prev:disabled{opacity:.3;cursor:not-allowed}
.t-nav-next{background:var(--accent2);color:white;border-color:var(--accent2)}
.t-nav-next:hover{opacity:.9}

/* Emotion table */
.emotion-table{border-radius:var(--radius-sm);overflow:hidden;border:1.5px solid var(--border);margin:14px 0}
.et-header{display:grid;grid-template-columns:1fr 1.2fr 1.2fr;background:var(--accent);color:var(--bg)}
.et-header div,.et-row div{padding:11px 12px;font-size:var(--fs-sm);font-weight:600;line-height:1.3}
.et-header div{font-size:12px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.et-row{display:grid;grid-template-columns:1fr 1.2fr 1.2fr;border-top:1px solid var(--border)}
.et-row:nth-child(even){background:var(--surface2)}
.et-emotion{font-weight:700;color:var(--text)}
.et-impulse{color:var(--wrong);font-style:italic}
.et-opposite{color:var(--correct);font-weight:600}

/* Function blocks */
.function-blocks{display:flex;flex-direction:column;gap:10px;margin-top:14px}
.func-block{background:var(--surface2);border-radius:var(--radius-sm);padding:14px 16px;border:1px solid var(--border)}
.func-icon{font-size:22px;margin-bottom:8px}
.func-title{font-size:var(--fs-body);font-weight:600;color:var(--text);margin-bottom:4px}
.func-desc{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.6}

/* Bio-social two col */
.biosocial-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.bio-col{background:var(--surface2);border-radius:var(--radius-sm);padding:14px;border:1px solid var(--border)}
.bio-col-title{font-size:12px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
.bio-col.bio-side .bio-col-title{color:var(--accent)}
.bio-col.env-side .bio-col-title{color:var(--accent2)}
.bio-col ul{list-style:none;padding:0}
.bio-col li{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.5;padding-left:14px;position:relative;margin-bottom:5px}
.bio-col li::before{content:'¬∑';position:absolute;left:0;color:var(--text-dim);font-size:18px;line-height:1.3}

/* Steps list */
.steps-list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
.step-item{display:flex;gap:13px;align-items:flex-start}
.step-n{width:34px;height:34px;border-radius:10px;background:var(--surface2);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:var(--fs-sm);font-weight:700;flex-shrink:0}
.step-n.vh-n{color:var(--accent3)}
.step-n.ao-n{color:var(--accent2)}
.step-text strong{display:block;font-size:var(--fs-body);font-weight:600;color:var(--text);margin-bottom:3px}
.step-text p{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.6}

/* Impulso notice */
.impulso-notice{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;margin-top:12px}
.impulso-notice-title{font-size:var(--fs-sm);font-weight:700;color:var(--text);margin-bottom:8px}
.notice-item{display:flex;gap:10px;align-items:flex-start;margin-bottom:7px}
.notice-dot{width:7px;height:7px;border-radius:50%;background:var(--accent2);margin-top:7px;flex-shrink:0}
.notice-item p{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.55}

/* When-box */
.when-grid{display:flex;flex-direction:column;gap:10px;margin-top:14px}
.when-card{background:var(--surface2);border-radius:var(--radius-sm);padding:14px 16px;border:1px solid var(--border)}
.when-card-label{font-size:12px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px}
.when-card.vh-card .when-card-label{color:var(--accent3)}
.when-card.ao-card .when-card-label{color:var(--accent2)}
.when-card p{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.6}

/* Thermostat */
.thermo-block{background:var(--surface2);border-radius:var(--radius-sm);padding:16px;display:flex;gap:15px;align-items:flex-start;border:1px solid var(--border);margin:14px 0}
.thermo-icon{font-size:34px;flex-shrink:0}
.thermo-text strong{font-size:var(--fs-body);font-weight:600;color:var(--text);display:block;margin-bottom:5px}
.thermo-text p{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.6}

/* ===== PRACTICE ===== */
#practice{background:var(--bg);min-height:100%}
.practice-bar{padding:52px 18px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.practice-bar-title{font-family:'Lora',serif;font-size:var(--fs-h3);font-weight:600;flex:1}
.levels-wrap{padding:18px 18px 40px}
.levels-label{font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:14px}
.level-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:20px 18px;cursor:pointer;position:relative;overflow:hidden;transition:all .2s;margin-bottom:12px;display:flex;gap:16px;align-items:flex-start}
.level-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.level-card:active{transform:scale(.98)}
.level-card.locked{opacity:.45;cursor:not-allowed}
.level-card.completed{border-color:rgba(61,190,138,.35)}
.level-stripe{position:absolute;top:0;left:0;width:4px;height:100%}
.lvl-0 .level-stripe{background:var(--accent)}
.lvl-1 .level-stripe{background:var(--accent2)}
.lvl-2 .level-stripe{background:var(--correct)}
.level-icon-box{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
.lvl-0 .level-icon-box{background:rgba(245,197,24,.12)}
.lvl-1 .level-icon-box{background:rgba(232,112,58,.12)}
.lvl-2 .level-icon-box{background:rgba(61,190,138,.12)}
.level-info{flex:1}
.level-name{font-weight:600;font-size:var(--fs-h3);margin-bottom:2px}
.level-person{font-size:var(--fs-sm);color:var(--text-muted);margin-bottom:7px}
.level-desc{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.55}
.level-badge{font-size:12px;font-weight:700;padding:4px 11px;border-radius:20px;display:inline-block;margin-top:8px}
.badge-easy{background:rgba(245,197,24,.12);color:var(--accent)}
.badge-mid{background:rgba(232,112,58,.12);color:var(--accent2)}
.badge-hard{background:rgba(61,190,138,.12);color:var(--correct)}
.score-chip{position:absolute;top:16px;right:16px;background:var(--correct);color:white;font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px}
.lock-icon{position:absolute;top:16px;right:16px;color:var(--text-dim);font-size:18px}

/* ===== SESSION ===== */
#session{display:none;flex-direction:column;height:100%}
#session.active{display:flex}
.sess-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:52px 16px 14px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.sess-info{flex:1;min-width:0}
.sess-patient{font-weight:600;font-size:var(--fs-body);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sess-level{font-size:var(--fs-sm);color:var(--text-muted);margin-top:2px}
.sess-controls{display:flex;align-items:center;gap:8px}
.score-pill{background:var(--surface2);border:1.5px solid var(--border);border-radius:20px;padding:5px 13px;font-size:14px;font-weight:700;color:var(--accent)}
.guide-btn{width:38px;height:38px;border-radius:50%;background:var(--surface2);border:1.5px solid var(--border);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .2s}
.chat-area{flex:1;overflow-y:auto;padding:18px 16px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.chat-msg{max-width:84%;animation:fadeIn .3s ease}
.chat-msg.patient{align-self:flex-start;animation:slideRight .3s ease}
.chat-msg.therapist{align-self:flex-end;animation:slideLeft .3s ease}
.chat-msg.narrator{align-self:center}
.bubble{padding:12px 16px;border-radius:20px;font-size:var(--fs-body);line-height:1.6}
.patient .bubble{background:var(--patient-bg);color:var(--text);border-bottom-left-radius:4px}
.therapist .bubble{background:var(--accent2);color:white;border-bottom-right-radius:4px}
.narrator .bubble{background:transparent;color:var(--text-dim);font-size:var(--fs-sm);text-align:center;font-style:italic;padding:3px 12px}
.step-badge{display:inline-block;background:rgba(61,190,138,.12);color:var(--correct);font-size:13px;font-weight:600;padding:4px 12px;border-radius:14px;margin-top:7px;letter-spacing:.3px}
.feedback-box{border-radius:var(--radius-sm);padding:12px 14px;margin-top:6px;font-size:var(--fs-sm);line-height:1.55;animation:fadeIn .3s ease}
.feedback-box.ok{background:rgba(61,190,138,.07);border:1.5px solid rgba(61,190,138,.2);color:var(--correct)}
.feedback-box.fail{background:rgba(232,85,85,.07);border:1.5px solid rgba(232,85,85,.2);color:var(--wrong)}
.typing-indicator{display:flex;gap:5px;align-items:center;padding:13px 16px;background:var(--patient-bg);border-radius:20px;border-bottom-left-radius:4px;width:fit-content}
.typing-dot{width:8px;height:8px;background:var(--text-muted);border-radius:50%;animation:shimmer 1.2s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
.decision-area{background:var(--surface);border-top:1px solid var(--border);padding:12px 16px 30px;flex-shrink:0}
.decision-label{font-size:12px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.step-tag{background:var(--surface2);border:1.5px solid var(--border);color:var(--text-muted);font-size:12px;font-weight:600;padding:3px 10px;border-radius:20px}
.options-list{display:flex;flex-direction:column;gap:8px}
.opt-btn{background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-body);color:var(--text);cursor:pointer;text-align:left;line-height:1.5;transition:all .18s}
.opt-btn:hover{background:var(--surface3);border-color:rgba(255,255,255,.14);transform:translateX(2px)}
.opt-btn:active{transform:scale(.98)}
.opt-btn.correct{border-color:var(--correct);background:rgba(61,190,138,.07)}
.opt-btn.wrong{border-color:var(--wrong);background:rgba(232,85,85,.07)}

/* ===== RESULT ===== */
#result{min-height:100%;background:var(--bg)}
.result-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:52px 22px 20px}
.result-name{font-family:'Lora',serif;font-size:var(--fs-h2);font-weight:600}
.result-sub{color:var(--text-muted);font-size:var(--fs-sm);margin-top:4px}
.score-ring-wrap{display:flex;justify-content:center;padding:30px 22px 14px;animation:pop .4s ease}
.score-ring{width:148px;height:148px;border-radius:50%;border:7px solid var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-family:'Lora',serif;font-size:46px;font-weight:600;line-height:1}
.score-lbl{font-size:13px;color:var(--text-muted);margin-top:4px;letter-spacing:.5px}
.decisions-wrap{padding:4px 18px 22px}
.sec-label{font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);padding:12px 4px 10px}
.decision-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:15px;margin-bottom:9px;animation:fadeUp .3s ease both}
.decision-card.first{border-color:rgba(61,190,138,.25)}
.decision-card.retry{border-color:rgba(245,197,24,.2)}
.dc-header{display:flex;align-items:center;gap:10px;margin-bottom:4px}
.dc-icon{font-size:16px}
.dc-name{flex:1;font-size:var(--fs-sm);font-weight:600}
.dc-pts{font-size:14px;font-weight:700}
.dc-pts.full{color:var(--correct)}
.dc-pts.half{color:var(--accent)}
.dc-detail{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.45}
.result-actions{padding:8px 18px 40px;display:flex;flex-direction:column;gap:10px}

/* ===== CERTIFICATE ===== */
#certificate{min-height:100%;background:var(--bg)}
.cert-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:52px 22px 20px}
.cert-bar h2{font-family:'Lora',serif;font-size:var(--fs-h2);font-weight:600}
.cert-bar p{color:var(--text-muted);font-size:var(--fs-sm);margin-top:4px}
.cert-wrap{padding:22px 18px 6px;animation:fadeUp .4s ease}
.cert-card{background:var(--surface);border:2px solid var(--accent);border-radius:var(--radius);padding:32px 24px;position:relative;overflow:hidden;text-align:center}
.cert-pattern{position:absolute;inset:0;opacity:.025;background-image:repeating-linear-gradient(45deg,var(--accent) 0,var(--accent) 1px,transparent 0,transparent 50%);background-size:22px 22px;pointer-events:none}
.cert-line{width:54px;height:4px;background:var(--accent);border-radius:2px;margin:0 auto 20px}
.cert-micro{font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px}
.cert-main{font-family:'Lora',serif;font-size:22px;font-weight:600;line-height:1.3;margin-bottom:20px}
.cert-to{font-size:var(--fs-sm);color:var(--text-dim);margin-bottom:6px}
.cert-name{font-family:'Lora',serif;font-size:28px;font-style:italic;color:var(--accent2);margin-bottom:20px;min-height:38px}
.cert-chips{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;margin-bottom:20px}
.cert-chip{background:var(--surface2);border:1.5px solid var(--border);color:var(--text-muted);font-size:12px;font-weight:600;padding:5px 12px;border-radius:20px}
.cert-score{font-family:'Lora',serif;font-size:40px;font-weight:600;color:var(--accent);margin-bottom:4px}
.cert-score-lbl{font-size:var(--fs-sm);color:var(--text-muted);margin-bottom:20px}
.cert-divider{height:1px;background:var(--border);margin:16px 0}
.cert-disclaimer{font-size:11px;color:var(--text-dim);line-height:1.6}
.cert-handle{font-size:12px;color:var(--text-dim);margin-top:6px;letter-spacing:.4px}
.cert-input-wrap{padding:18px 18px 6px}
.cert-input-lbl{font-size:var(--fs-sm);color:var(--text-muted);margin-bottom:8px;display:block}
.cert-input{width:100%;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:14px 18px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-body);color:var(--text);outline:none;transition:border-color .2s}
.cert-input:focus{border-color:var(--accent)}
.cert-actions{padding:14px 18px 40px;display:flex;flex-direction:column;gap:10px}

/* ===== GUIDE MODAL ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:100;animation:fadeIn .2s ease}
.overlay.open{display:flex;align-items:flex-end}
.sheet{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-height:88vh;overflow-y:auto;animation:fadeUp .25s ease}
.sheet-handle{width:40px;height:4px;background:var(--surface3);border-radius:2px;margin:14px auto 4px}
.sheet-header{padding:12px 20px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.sheet-header h3{font-family:'Lora',serif;font-size:var(--fs-h3);font-weight:600}
.sheet-close{width:34px;height:34px;border-radius:50%;background:var(--surface2);border:none;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px}
.guide-tabs{display:flex;border-bottom:1px solid var(--border)}
.guide-tab{flex:1;padding:12px;font-family:'IBM Plex Sans',sans-serif;font-size:var(--fs-sm);font-weight:600;color:var(--text-muted);background:none;border:none;border-bottom:2.5px solid transparent;cursor:pointer;transition:all .2s}
.guide-tab.active{color:var(--accent2);border-bottom-color:var(--accent2)}
.guide-body{padding:16px 20px 32px;display:flex;flex-direction:column;gap:14px}
.g-step{display:flex;gap:13px}
.g-num{width:32px;height:32px;border-radius:9px;background:var(--surface2);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}
.g-text strong{display:block;font-size:var(--fs-body);font-weight:600;color:var(--text);margin-bottom:3px}
.g-text p{font-size:var(--fs-sm);color:var(--text-muted);line-height:1.55}
</style>
</head>
<body>

<!-- HOME -->
<div id="home" class="screen active">
  <div class="home-top">
    <div>
      <div class="brand-label">DBT ¬∑ Entrenamiento Cl√≠nico</div>
      <div class="brand-title">Modo<br><em>Sesi√≥n</em></div>
    </div>
    <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">üåô</button>
  </div>
  <div class="home-desc">
    <p>Aprend√© la teor√≠a y practic√° las habilidades de regulaci√≥n emocional de <strong>DBT</strong> en simulaciones de sesi√≥n reales.</p>
    <div class="skills-pills">
      <span class="pill">Verificar los Hechos</span>
      <span class="pill">Acci√≥n Opuesta</span>
      <span class="pill">Modo sesi√≥n</span>
    </div>
  </div>
  <div class="home-nav">
    <div class="nav-card" onclick="openTheory()">
      <div class="nav-card-accent"></div>
      <div class="nav-card-body">
        <div class="nav-card-title">üìñ Marco te√≥rico <span class="nav-badge badge-theory">PRIMERO</span></div>
        <div class="nav-card-sub">Qu√© son las emociones, por qu√© se desregulan, la Teor√≠a Biosocial y c√≥mo funcionan las herramientas. Basado en Boggiano & Gagliesi (2020) y Linehan (2020).</div>
      </div>
    </div>
    <div class="nav-card" onclick="showPractice()">
      <div class="nav-card-accent"></div>
      <div class="nav-card-body">
        <div class="nav-card-title">üéØ Casos cl√≠nicos <span class="nav-badge badge-practice">PR√ÅCTICA</span></div>
        <div class="nav-card-sub">Tres simulaciones en formato sesi√≥n. El paciente te escribe. Vos decid√≠s c√≥mo guiarlo. Cada decisi√≥n tiene consecuencias.</div>
      </div>
    </div>
  </div>
</div>

<!-- THEORY -->
<div id="theory" class="screen">
  <div class="theory-top-bar">
    <div class="theory-top-inner">
      <button class="back-btn" onclick="showScreen('home')">‚Üê</button>
      <div class="theory-top-title">Marco te√≥rico</div>
      <div class="theory-pagination" id="theoryPagination">1 / 9</div>
    </div>
    <div class="theory-progress"><div class="theory-progress-fill" id="theoryProgress" style="width:11%"></div></div>
  </div>
  <div class="theory-slides" id="theorySlidesContainer"></div>
  <div class="theory-nav">
    <button class="t-nav-btn t-nav-prev" id="tPrev" onclick="theoryNav(-1)" disabled>‚Üê Anterior</button>
    <button class="t-nav-btn t-nav-next" id="tNext" onclick="theoryNav(1)">Siguiente ‚Üí</button>
  </div>
</div>

<!-- PRACTICE -->
<div id="practice" class="screen">
  <div class="practice-bar">
    <button class="back-btn" onclick="showScreen('home')">‚Üê</button>
    <div class="practice-bar-title">Casos cl√≠nicos</div>
    <button class="theme-btn" onclick="toggleTheme()" style="font-size:17px;width:38px;height:38px">‚òÄÔ∏è</button>
  </div>
  <div class="levels-wrap">
    <div class="levels-label">Seleccion√° un caso</div>
    <div id="levelCards"></div>
  </div>
</div>

<!-- SESSION -->
<div id="session" class="screen">
  <div class="sess-bar">
    <button class="back-btn" onclick="showPractice()">‚Üê</button>
    <div class="sess-info">
      <div class="sess-patient" id="sessPatient"></div>
      <div class="sess-level" id="sessLevel"></div>
    </div>
    <div class="sess-controls">
      <div class="score-pill" id="scorePill">0 pts</div>
      <button class="guide-btn" onclick="openGuide()">üìã</button>
    </div>
  </div>
  <div class="chat-area" id="chatArea"></div>
  <div class="decision-area" id="decisionArea" style="display:none">
    <div class="decision-label">Tu respuesta <span class="step-tag" id="stepTag"></span></div>
    <div class="options-list" id="optionsList"></div>
  </div>
</div>

<!-- RESULT -->
<div id="result" class="screen">
  <div class="result-bar">
    <div class="result-name" id="resultName"></div>
    <div class="result-sub" id="resultSub"></div>
  </div>
  <div class="score-ring-wrap">
    <div class="score-ring" id="scoreRing">
      <div class="score-num" id="scoreNum">‚Äî</div>
      <div class="score-lbl">puntos</div>
    </div>
  </div>
  <div class="decisions-wrap">
    <div class="sec-label">Decisiones cl√≠nicas</div>
    <div id="decisionsBody"></div>
  </div>
  <div class="result-actions" id="resultActions"></div>
</div>

<!-- CERTIFICATE -->
<div id="certificate" class="screen">
  <div class="cert-bar">
    <h2>üèÖ Certificado de Entrenamiento</h2>
    <p>Completaste los 3 casos del simulador DBT.</p>
  </div>
  <div class="cert-wrap">
    <div class="cert-card">
      <div class="cert-pattern"></div>
      <div class="cert-line"></div>
      <div class="cert-micro">Certificado de participaci√≥n</div>
      <div class="cert-main">Entrenamiento en<br>Regulaci√≥n Emocional DBT</div>
      <div class="cert-to">Otorgado a</div>
      <div class="cert-name" id="certNameDisplay">Tu nombre</div>
      <div class="cert-chips">
        <span class="cert-chip">‚úì Verificar los Hechos</span>
        <span class="cert-chip">‚úì Acci√≥n Opuesta</span>
        <span class="cert-chip">‚úì 3 casos cl√≠nicos</span>
      </div>
      <div class="cert-score" id="certScore">‚Äî</div>
      <div class="cert-score-lbl">puntos totales obtenidos</div>
      <div class="cert-divider"></div>
      <div class="cert-disclaimer">Este certificado no tiene validez acad√©mica ni profesional.<br>Es un recurso de entrenamiento cl√≠nico.</div>
      <div class="cert-handle">@leo.eyzaguirre ¬∑ DBT Simulador</div>
    </div>
  </div>
  <div class="cert-input-wrap">
    <label class="cert-input-lbl">¬øC√≥mo quer√©s que aparezca tu nombre?</label>
    <input type="text" class="cert-input" id="certNameInput" placeholder="Ej: Lic. Mar√≠a Garc√≠a" oninput="updateCertName(this.value)">
  </div>
  <div class="cert-actions">
    <button class="btn-primary" onclick="shareCert()">Compartir certificado</button>
    <button class="btn-secondary" onclick="showScreen('home')">Volver al inicio</button>
  </div>
</div>

<!-- GUIDE MODAL -->
<div class="overlay" id="guideOverlay" onclick="closeGuideOverlay(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Referencia de pasos</h3>
      <button class="sheet-close" onclick="closeGuide()">‚úï</button>
    </div>
    <div class="guide-tabs">
      <button class="guide-tab active" onclick="switchTab('vh',this)">Verificar los Hechos</button>
      <button class="guide-tab" onclick="switchTab('ao',this)">Acci√≥n Opuesta</button>
    </div>
    <div class="guide-body" id="guideBody"></div>
  </div>
</div>

<script>
// ===================== THEORY SLIDES =====================
const THEORY_SLIDES = [
  {
    num:'01 ¬∑ Origen',
    title:'La Terapia Dial√©ctico Conductual',
    content:`
      <p>La <strong>Terapia Dial√©ctico Conductual (DBT)</strong> fue desarrollada por la Dra. Marsha Linehan en la Universidad de Washington. Es el tratamiento con mayor evidencia para la desregulaci√≥n emocional severa.</p>
      <p>Su nombre refleja la tensi√≥n central del tratamiento: la dial√©ctica entre <strong>aceptaci√≥n y cambio</strong>. Las habilidades de regulaci√≥n emocional son uno de sus cuatro m√≥dulos, junto a mindfulness, efectividad interpersonal y tolerancia al malestar.</p>
      <div class="highlight-box">"La Terapia Dial√©ctico Conductual ha demostrado eficacia en el tratamiento y prevenci√≥n de los problemas de salud mental asociados a la desregulaci√≥n emocional." ‚Äî Linehan (2020)</div>
      <span class="source-tag">Linehan, 2020 ¬∑ Boggiano & Gagliesi, 2020</span>
    `
  },
  {
    num:'02 ¬∑ Emociones',
    title:'Las emociones tienen funci√≥n',
    content:`
      <p>Antes de hablar de regulaci√≥n, necesitamos entender qu√© estamos regulando. Las emociones no son ruido ni debilidad ‚Äî son respuestas adaptativas con funciones precisas.</p>
      <p>Seg√∫n Boggiano y Gagliesi, las emociones hacen tres cosas fundamentales:</p>
      <div class="function-blocks">
        <div class="func-block">
          <div class="func-icon">‚ö°</div>
          <div class="func-title">Organizan y motivan la acci√≥n</div>
          <div class="func-desc">El miedo al ver un objeto sinuoso te hace saltar antes de saber si es una serpiente o una rama. Es preferible confundir una rama con una serpiente que una serpiente con una rama ‚Äî el miedo salva la vida.</div>
        </div>
        <div class="func-block">
          <div class="func-icon">üì°</div>
          <div class="func-title">Comunican a otros</div>
          <div class="func-desc">Si dec√≠s que est√°s triste pero tu expresi√≥n no lo dice, el otro le cree a tu cara. Las emociones son comunicaci√≥n no verbal de alta fidelidad ‚Äî muchas veces m√°s cre√≠ble que las palabras.</div>
        </div>
        <div class="func-block">
          <div class="func-icon">ü™û</div>
          <div class="func-title">Nos influyen a nosotros mismos</div>
          <div class="func-desc">Si me siento enojado, valida que algo fue injusto. Las emociones tienen una funci√≥n autorreferencial ‚Äî y eso puede volverse problem√°tico cuando la intensidad no encaja con los hechos.</div>
        </div>
      </div>
      <span class="source-tag">Boggiano & Gagliesi, 2020</span>
    `
  },
  {
    num:'03 ¬∑ Teor√≠a Biosocial',
    title:'Por qu√© se desregulan las emociones',
    content:`
      <p>La desregulaci√≥n emocional no es un defecto de car√°cter. DBT la explica como el resultado de la <strong>interacci√≥n a trav√©s del tiempo</strong> de dos factores:</p>
      <div class="biosocial-grid">
        <div class="bio-col bio-side">
          <div class="bio-col-title">Vulnerabilidad Emocional</div>
          <ul>
            <li>Alta sensibilidad a los est√≠mulos</li>
            <li>Alta reactividad emocional</li>
            <li>Lento retorno a la calma</li>
          </ul>
        </div>
        <div class="bio-col env-side">
          <div class="bio-col-title">Ambiente Invalidante</div>
          <ul>
            <li>Minimiza experiencias privadas</li>
            <li>No ense√±a habilidades de regulaci√≥n</li>
            <li>Refuerza conductas disfuncionales</li>
          </ul>
        </div>
      </div>
      <p style="margin-top:14px">Ninguno de los dos por s√≠ solo. La vulnerabilidad genera invalidaci√≥n, y la invalidaci√≥n amplifica la vulnerabilidad. Es un modelo <strong>transaccional</strong>, no aditivo.</p>
      <div class="highlight-box">Linehan compara la Vulnerabilidad Emocional con tener quemaduras de tercer grado: el m√°s m√≠nimo movimiento genera un malestar extremo que no termina de apaciguarse cuando llega una nueva ola.</div>
      <span class="source-tag">Boggiano & Gagliesi, 2020</span>
    `
  },
  {
    num:'04 ¬∑ Regulaci√≥n',
    title:'Regular no es apagar las emociones',
    content:`
      <p>Linehan define la regulaci√≥n emocional como la capacidad de inhibir la conducta impulsiva inapropiada, organizarse para accionar en funci√≥n a un objetivo, autocalmar la activaci√≥n fisiol√≥gica, y reenfocar la atenci√≥n ‚Äî incluso en presencia de emociones fuertes.</p>
      <div class="thermo-block">
        <div class="thermo-icon">üå°Ô∏è</div>
        <div class="thermo-text">
          <strong>Como un termostato, no un interruptor</strong>
          <p>Regular es ajustar la intensidad al nivel que tiene sentido para la situaci√≥n. No eliminar. Si un contratiempo menor genera la misma intensidad que una crisis real, el termostato est√° roto.</p>
        </div>
      </div>
      <p>El objetivo de las habilidades no es que los consultantes sientan menos ‚Äî es que puedan <strong>elegir c√≥mo actuar incluso cuando sienten mucho</strong>.</p>
      <span class="source-tag">Linehan, 2020</span>
    `
  },
  {
    num:'05 ¬∑ Las herramientas',
    title:'Cu√°ndo usar cada herramienta',
    content:`
      <p>DBT tiene herramientas espec√≠ficas para cambiar respuestas emocionales. No son intercambiables ‚Äî cada una responde a una pregunta diferente.</p>
      <div class="when-grid">
        <div class="when-card vh-card">
          <div class="when-card-label">üîç Verificar los Hechos ‚Äî cuando</div>
          <p>Reaccionamos a interpretaciones en lugar de hechos, y la emoci√≥n puede no ajustarse a la realidad. Verificar modifica la emoci√≥n modificando la lectura del evento.</p>
        </div>
        <div class="when-card ao-card">
          <div class="when-card-label">‚Ü©Ô∏è Acci√≥n Opuesta ‚Äî cuando</div>
          <p>La emoci√≥n no encaja con los hechos ‚Äî o su intensidad es desproporcionada ‚Äî y verificar no es suficiente. Actuamos opuesto al impulso para romper el ciclo de refuerzo.</p>
        </div>
      </div>
      <div class="highlight-box">‚ö†Ô∏è Si la emoci√≥n s√≠ encaja con los hechos, la herramienta es Resoluci√≥n de Problemas ‚Äî no Acci√≥n Opuesta. Confundir esto es el error m√°s frecuente en terapeutas en formaci√≥n.</div>
      <span class="source-tag">Linehan, 2020</span>
    `
  },
  {
    num:'06 ¬∑ Verificar los Hechos',
    title:'Los 6 pasos para verificar',
    content:`
      <p>A menudo no reaccionamos a los hechos ‚Äî reaccionamos a nuestras interpretaciones de los hechos. Estos son los seis pasos del protocolo (Ficha RE8, Linehan 2020):</p>
      <div class="steps-list">
        <div class="step-item"><div class="step-n vh-n">1</div><div class="step-text"><strong>¬øCu√°l es la emoci√≥n que quiero cambiar?</strong><p>Etiquetar con precisi√≥n. No "me siento mal" ‚Äî ¬øes bronca, miedo, verg√ºenza, culpa? Agregar intensidad 0-100.</p></div></div>
        <div class="step-item"><div class="step-n vh-n">2</div><div class="step-text"><strong>¬øCu√°l es el evento desencadenante?</strong><p>Solo hechos observables. Sin juicios ni absolutos. Lo que cualquiera con ojos podr√≠a haber visto.</p></div></div>
        <div class="step-item"><div class="step-n vh-n">3</div><div class="step-text"><strong>¬øCu√°les son mis interpretaciones?</strong><p>Separar el hecho de la historia construida encima. Las interpretaciones generan emociones tan intensas como los hechos reales.</p></div></div>
        <div class="step-item"><div class="step-n vh-n">4</div><div class="step-text"><strong>¬øEstoy asumiendo una amenaza?</strong><p>Etiquetar la amenaza. Evaluar su probabilidad real. Pensar en todos los otros resultados posibles.</p></div></div>
        <div class="step-item"><div class="step-n vh-n">5</div><div class="step-text"><strong>¬øCu√°l es la cat√°strofe?</strong><p>Si el peor resultado ocurriera, ¬øcu√°les son las consecuencias realistas? Imaginar que podemos manejarlo bien.</p></div></div>
        <div class="step-item"><div class="step-n vh-n">6</div><div class="step-text"><strong>¬øMi emoci√≥n y su intensidad encajan con los hechos?</strong><p>El veredicto. No si la emoci√≥n existe ‚Äî sino si su nivel tiene sentido dado lo que realmente ocurri√≥.</p></div></div>
      </div>
      <span class="source-tag">Linehan, 2020 ¬∑ Fichas RE8‚Äì8A</span>
    `
  },
  {
    num:'07 ¬∑ Acci√≥n Opuesta',
    title:'El impulso de acci√≥n: qu√© es y c√≥mo notarlo',
    content:`
      <p>Cada emoci√≥n genera un <strong>impulso de acci√≥n</strong>: una urgencia de hacer algo en particular. El miedo urge a huir, el enojo urge a atacar, la tristeza urge a aislarse. El impulso no es la acci√≥n ‚Äî es la presi√≥n interna hacia ella.</p>
      <p>Acci√≥n Opuesta es interrumpir ese circuito: actuar en direcci√≥n opuesta al impulso cuando la emoci√≥n no encaja con los hechos.</p>
      <div class="impulso-notice">
        <div class="impulso-notice-title">¬øC√≥mo notar el impulso de acci√≥n?</div>
        <div class="notice-item"><div class="notice-dot"></div><p><strong>En el cuerpo:</strong> la tensi√≥n muscular del enojo, el peso en el pecho de la tristeza, la energ√≠a de huida del miedo.</p></div>
        <div class="notice-item"><div class="notice-dot"></div><p><strong>En los pensamientos:</strong> "deber√≠a irme", "necesito confrontarlo", "no quiero ver a nadie".</p></div>
        <div class="notice-item"><div class="notice-dot"></div><p><strong>En los movimientos:</strong> cerrarse, retirarse, avanzar agresivamente, bajar la mirada.</p></div>
        <div class="notice-item"><div class="notice-dot"></div><p><strong>Pregunta directa:</strong> "¬øQu√© te est√° urgiendo hacer ahora mismo?"</p></div>
      </div>
      <div class="highlight-box">Cuando actuamos sobre un impulso que no es efectivo, reforzamos la emoci√≥n. Acci√≥n Opuesta rompe ese ciclo de refuerzo ‚Äî es una variaci√≥n de los tratamientos de exposici√≥n. ‚Äî Linehan (2020)</div>
      <span class="source-tag">Linehan, 2020</span>
    `
  },
  {
    num:'08 ¬∑ Acci√≥n Opuesta',
    title:'Emoci√≥n, impulso y acci√≥n opuesta',
    content:`
      <p>Cada emoci√≥n tiene sus propios impulsos t√≠picos. Acci√≥n Opuesta no significa actuar opuesto a cualquier lista ‚Äî significa actuar opuesto al <strong>impulso real de esa persona en esa situaci√≥n</strong>.</p>
      <div class="emotion-table">
        <div class="et-header">
          <div>Emoci√≥n</div>
          <div>Impulso de acci√≥n</div>
          <div>Acci√≥n opuesta</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Miedo</div>
          <div class="et-impulse">Huir / Evitar</div>
          <div class="et-opposite">Abordar / No evitar</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Enojo</div>
          <div class="et-impulse">Atacar / Confrontar</div>
          <div class="et-opposite">Ser amable / Media sonrisa</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Tristeza</div>
          <div class="et-impulse">Aislarte / Paralizarte</div>
          <div class="et-opposite">Activarte / Abordar</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Verg√ºenza</div>
          <div class="et-impulse">Esconderte / Evitar</div>
          <div class="et-opposite">Mostrarte con personas seguras</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Culpa</div>
          <div class="et-impulse">Justificarte</div>
          <div class="et-opposite">Reparar / Pedir disculpas</div>
        </div>
        <div class="et-row">
          <div class="et-emotion">Asco</div>
          <div class="et-impulse">Alejarte</div>
          <div class="et-opposite">Acercarte gradualmente</div>
        </div>
      </div>
      <div class="highlight-box">Entrena a los consultantes hasta que puedan decirlo autom√°ticamente: "¬øQu√© hac√©s cuando ten√©s miedo?" ‚Äî "¬°Hac√© lo que tem√©s!" ‚Äî Linehan (2020)</div>
      <span class="source-tag">Linehan, 2020 ¬∑ Fichas RE10‚Äì11</span>
    `
  },
  {
    num:'09 ¬∑ Acci√≥n Opuesta',
    title:'Los 6 pasos y la regla del "por completo"',
    content:`
      <p>Estos son los seis pasos del protocolo de Acci√≥n Opuesta (Ficha RE10, Linehan 2020):</p>
      <div class="steps-list">
        <div class="step-item"><div class="step-n ao-n">1</div><div class="step-text"><strong>Identificar y nombrar la emoci√≥n</strong><p>El mismo punto de partida. Sin nombre preciso, no hay blanco al que apuntar.</p></div></div>
        <div class="step-item"><div class="step-n ao-n">2</div><div class="step-text"><strong>Verificar los hechos</strong><p>Confirmar que la emoci√≥n no encaja ‚Äî o que actuar sobre ella no es efectivo. Es el puente entre las dos habilidades.</p></div></div>
        <div class="step-item"><div class="step-n ao-n">3</div><div class="step-text"><strong>Identificar el impulso de acci√≥n</strong><p>¬øQu√© te urge hacer o decir? Ese impulso espec√≠fico es el que vas a invertir.</p></div></div>
        <div class="step-item"><div class="step-n ao-n">4</div><div class="step-text"><strong>¬øActuar sobre el impulso es efectivo?</strong><p>Preguntale a la Mente Sabia. Si la respuesta es no, segu√≠s al paso 5.</p></div></div>
        <div class="step-item"><div class="step-n ao-n">5</div><div class="step-text"><strong>Actu√° de forma opuesta al impulso</strong><p>Opuesto a tu impulso real ‚Äî no a una lista gen√©rica. La emoci√≥n es la gu√≠a.</p></div></div>
        <div class="step-item"><div class="step-n ao-n">6</div><div class="step-text"><strong>Hacelo por completo</strong><p>Postura, tono de voz, gestos, pensamientos ‚Äî todo en la misma direcci√≥n. Ir a una fiesta para reducir la fobia social pero pasar toda la noche mirando el piso es Acci√≥n Opuesta a medias. No funciona.</p></div></div>
      </div>
      <span class="source-tag">Linehan, 2020 ¬∑ Fichas RE10‚Äì11</span>
    `
  },
];

// ===================== GUIDE DATA =====================
const GUIDE = {
  vh:[
    {q:'¬øCu√°l es la emoci√≥n que quiero cambiar?',d:'Etiquetar con precisi√≥n. No "me siento mal" ‚Äî ¬øbronca, miedo, verg√ºenza, culpa? Intensidad 0-100.'},
    {q:'¬øCu√°l es el evento desencadenante?',d:'Solo hechos observables. Sin juicios ni absolutos.'},
    {q:'¬øCu√°les son mis interpretaciones?',d:'Separar el hecho de la historia construida encima.'},
    {q:'¬øEstoy asumiendo una amenaza?',d:'Etiquetar la amenaza. Evaluar probabilidad real. Pensar en otros resultados posibles.'},
    {q:'¬øCu√°l es la cat√°strofe?',d:'Si el peor resultado ocurriera, ¬øcu√°les son las consecuencias realistas?'},
    {q:'¬øLa emoci√≥n y su intensidad encajan con los hechos?',d:'El veredicto ‚Äî no si existe, sino si su nivel tiene sentido.'},
  ],
  ao:[
    {q:'Identificar y nombrar la emoci√≥n',d:'Sin nombre preciso, no hay blanco al que apuntar.'},
    {q:'Verificar los hechos',d:'Confirmar que la emoci√≥n no encaja o no es efectivo actuar sobre ella.'},
    {q:'Identificar el impulso de acci√≥n',d:'¬øQu√© te urge hacer? Ese impulso es el que vas a invertir.'},
    {q:'¬øActuar sobre el impulso es efectivo?',d:'Preguntale a tu Mente Sabia. Si no, segu√≠s al paso 5.'},
    {q:'Actu√° de forma opuesta al impulso',d:'Opuesto a tu impulso real ‚Äî no a una lista gen√©rica.'},
    {q:'Hacelo por completo',d:'Postura, tono, gestos, pensamientos: todo en la misma direcci√≥n.'},
  ]
};

// ===================== CASES =====================
const LEVELS=[
  {id:0,title:'Valentina',sub:'26 a√±os ¬∑ Psic√≥loga junior',desc:'Verg√ºenza intensa despu√©s de equivocarse en una reuni√≥n. La emoci√≥n no encaja a esa intensidad.',diff:'F√°cil',diffClass:'badge-easy',icon:'üòü',maxScore:50,
  beats:[
    {type:'narrator',text:'‚Äî Valentina te escribe por WhatsApp ‚Äî'},
    {type:'patient',text:'Hola, necesito que me ayudes. Pas√© algo horrible hoy y no me lo puedo sacar de la cabeza.'},
    {type:'patient',text:'Estoy pensando en pedir licencia o algo as√≠.'},
    {type:'decision',stepLabel:'VH ¬∑ Paso 1',options:[
      {text:'¬øQu√© emoci√≥n est√°s sintiendo ahora mismo?',correct:true,pts:10,reaction:'Verg√ºenza. Mucha. Un 85/100. Hoy en la reuni√≥n di una respuesta completamente equivocada delante de todo el equipo.',ok:'Correcto ‚Äî el primer movimiento es identificar y nombrar la emoci√≥n antes de cualquier otra cosa.',badge:'VH Paso 1: emoci√≥n identificada'},
      {text:'¬øQu√© fue lo que pas√≥? Contame todo.',correct:false,reaction:'Hoy en la reuni√≥n me confund√≠ con los datos y di informaci√≥n incorrecta. Ahora todos van a pensar que soy incompetente...',fail:'Fuiste directo al contenido antes de anclar la emoci√≥n. El relato se expande y perd√©s el foco cl√≠nico.'},
      {text:'Tranquila, seguro no fue para tanto.',correct:false,reaction:'...F√°cil decirlo desde afuera.',fail:'Minimizaste antes de explorar. El paciente se siente invalidado y se cierra.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Pasos 2 y 3',options:[
      {text:'¬øQu√© es exactamente lo que pas√≥ ‚Äî solo hechos, sin interpretaciones?',correct:true,pts:10,reaction:'Hmm... el hecho es que di una respuesta incorrecta cuando me preguntaron. Lo otro ‚Äî que todos piensan que soy incompetente ‚Äî eso no lo s√© en realidad.',ok:'Separaste el evento observable de las interpretaciones. Esos son los Pasos 2 y 3.',badge:'VH Pasos 2-3: hechos vs. interpretaciones'},
      {text:'¬øC√≥mo reaccionaron tus compa√±eros exactamente?',correct:false,reaction:'Algunos me miraron, uno me pregunt√≥ si estaba bien... no s√©, quiz√°s notaron que algo estaba mal.',fail:'Fuiste a las consecuencias en lugar de separar hechos de interpretaciones.'},
      {text:'¬øEsto te pas√≥ antes?',correct:false,reaction:'S√≠, una o dos veces. Siempre me pasa en las reuniones importantes...',fail:'Buscar patrones hist√≥ricos puede amplificar la emoci√≥n cuando a√∫n no separaste los hechos del evento espec√≠fico.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Pasos 4 y 5',options:[
      {text:'¬øCu√°l es la peor consecuencia realista de lo que pas√≥ hoy?',correct:true,pts:10,reaction:'Que alguien piense que me equivoqu√©... una vez. Dicho as√≠ suena muy diferente a lo que sent√≠a. Pero igual lo siento muy fuerte.',ok:'Evaluaste la cat√°strofe real vs. la imaginada. La √∫ltima frase de Valentina es la se√±al exacta de que la emoci√≥n no encaja a esa intensidad.',badge:'VH Pasos 4-5: amenaza y cat√°strofe'},
      {text:'Basta de catastrofizar, eso no ayuda.',correct:false,reaction:'S√© que soy exagerada, me lo dicen siempre...',fail:'Etiquetaste el pensamiento sin explorarlo. La autoinvalidaci√≥n se refuerza.'},
      {text:'¬øY si tu jefe estuvo en esa reuni√≥n?',correct:false,reaction:'No... no lo s√©. Ahora estoy peor.',fail:'Amplificaste la amenaza en lugar de evaluarla.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Paso 6',options:[
      {text:'¬øUn 85% de verg√ºenza tiene sentido por haberte equivocado una vez en una reuni√≥n?',correct:true,pts:10,reaction:'No... supongo que no. Pero mi cuerpo no lo registra as√≠ todav√≠a.',ok:'La emoci√≥n existe pero su intensidad no encaja con los hechos. Eso es exactamente cu√°ndo entr√°s en Acci√≥n Opuesta.',badge:'VH Paso 6: intensidad no encaja'},
      {text:'Entonces ya sab√©s que exageraste.',correct:false,reaction:'...S√≠. Siempre soy exagerada.',fail:'Diagnosticaste sin explorar. El paciente internaliza el juicio en lugar de desarrollar la habilidad.'},
      {text:'¬øQu√© soluciones ten√©s para evitar que vuelva a pasar?',correct:false,reaction:'Podr√≠a prepararme m√°s...',fail:'Saltaste a Resoluci√≥n de Problemas antes de completar Verificar los Hechos.'}
    ]},
    {type:'patient',text:'Entiendo lo que dec√≠s. Pero cuando pienso en ir a trabajar ma√±ana se me cierra el pecho.'},
    {type:'decision',stepLabel:'AO ¬∑ Pasos 3‚Äì6',options:[
      {text:'¬øQu√© te urge hacer con tus compa√±eros ma√±ana, y c√≥mo ser√≠a hacer exactamente lo contrario ‚Äî con cuerpo, tono y postura?',correct:true,pts:10,reaction:'Me urge evitarlos, no hablar en las reuniones. Lo contrario ser√≠a ir, participar, hablar cuando tenga algo para decir. Con postura recta, no con la cabeza baja.',ok:'Identificaste el impulso, evaluaste efectividad y definiste la acci√≥n opuesta completa ‚Äî postura, voz, presencia. No a medias.',badge:'AO Pasos 3-6: impulso ‚Üí opuesto completo'},
      {text:'Forzate a ir a trabajar ma√±ana y ya.',correct:false,reaction:'S√≠... supongo.',fail:'Diste la instrucci√≥n sin identificar el impulso ni trabajar la dimensi√≥n corporal. Acci√≥n Opuesta a medias.'},
      {text:'¬øPod√©s comprometerte a no evitar a tus compa√±eros?',correct:false,reaction:'Voy a intentarlo...',fail:'El compromiso es vago y no define el comportamiento concreto. Sin postura y tono, el paciente no sabe qu√© hacer.'}
    ]}
  ]},
  {id:1,title:'Marcos',sub:'34 a√±os ¬∑ Contador',desc:'Bronca intensa con su hermano que le debe dinero. Emociones mezcladas y resistencia al proceso.',diff:'Intermedio',diffClass:'badge-mid',icon:'üò§',maxScore:50,
  beats:[
    {type:'narrator',text:'‚Äî Marcos te escribe en medio de una situaci√≥n activa ‚Äî'},
    {type:'patient',text:'Necesito hablar. Mi hermano me debe plata hace 4 meses y hoy lo vi en Instagram de vacaciones. Estoy que exploto.'},
    {type:'patient',text:'Tengo ganas de mandarle un mensaj√≥n o ir a su casa directamente.'},
    {type:'decision',stepLabel:'VH ¬∑ Paso 1',options:[
      {text:'Antes de hacer cualquier cosa ‚Äî ¬øqu√© emoci√≥n est√°s sintiendo, y qu√© tan intensa?',correct:true,pts:10,reaction:'Bronca. Un 80/100. Y algo de tristeza tambi√©n ‚Äî me siento traicionado por alguien que es mi familia.',ok:'Nombraste dos emociones y pediste intensidad. Cuando hay emociones mezcladas es clave identificar cu√°l es la primaria.',badge:'VH Paso 1: emociones mixtas identificadas'},
      {text:'¬øQu√© le vas a decir cuando lo contactes?',correct:false,reaction:'Eso es lo que no s√©. Si le mando lo que tengo ganas de mandar va a ser un desastre.',fail:'Fuiste directo a la acci√≥n. Sin identificar emociones primero, cualquier estrategia va a estar al servicio de la urgencia.'},
      {text:'Entiendo que est√©s enojado, es muy injusto.',correct:false,reaction:'S√≠, exactamente. O sea, ¬øc√≥mo puede...?',fail:'Validar es importante, pero ac√° amplific√≥ la emoci√≥n. Primero identificar, despu√©s validar selectivamente.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Pasos 2 y 3',options:[
      {text:'¬øQu√© es lo que viste hoy exactamente ‚Äî solo hechos observables, sin lo que interpret√°s?',correct:true,pts:10,reaction:'Una foto en Instagram donde est√° en la playa con amigos. Lo que interpreto ‚Äî que tiene plata para vacaciones y no para devolverme lo m√≠o ‚Äî eso no lo s√© con certeza.',ok:'La foto es el hecho. "Tiene plata y no me paga" es la interpretaci√≥n. Esa distinci√≥n cambia todo.',badge:'VH Pasos 2-3: hechos vs. interpretaciones'},
      {text:'¬øAntes de esto te hab√≠a dado se√±ales de que no iba a pagar?',correct:false,reaction:'Siempre fue as√≠. Una vez tard√≥ meses en devolverme algo...',fail:'Buscaste patrones hist√≥ricos antes de clarificar los hechos del evento actual. Eso puede solidificar la interpretaci√≥n como si fuera un hecho.'},
      {text:'Y tu hermano, ¬øsabe que lo necesit√°s?',correct:false,reaction:'Le mand√© tres mensajes. Los vio. No contest√≥.',fail:'Buen dato pero salteaste la distinci√≥n hechos-interpretaciones. Sin ese paso, la bronca sigue mezclada con suposiciones.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Paso 6',options:[
      {text:'La bronca por sentirte ignorado tiene sentido. Pero ¬ø80/100 encaja con lo que pod√©s confirmar?',correct:true,pts:10,reaction:'No s√©... s√≠ me ignor√≥, eso es real. Pero tampoco s√© si tiene plata o no. Quiz√°s el 80 es mucho para lo que puedo confirmar.',ok:'Validaste la emoci√≥n y trabajaste la intensidad sin invalidarla. La bronca puede encajar ‚Äî pero no al 80 con la informaci√≥n disponible.',badge:'VH Paso 6: intensidad vs. hechos confirmados'},
      {text:'Tu hermano te ignor√≥, as√≠ que la bronca est√° justificada.',correct:false,reaction:'Exacto, y encima de vacaciones...',fail:'Validaste la emoci√≥n pero reforzaste la intensidad sin verificar la interpretaci√≥n.'},
      {text:'En realidad no sab√©s si tiene plata, as√≠ que no ten√©s razones para estar enojado.',correct:false,reaction:'Pero me ignor√≥. Eso es real.',fail:'Invalidaste la emoci√≥n en lugar de trabajar la intensidad. Marcos tiene raz√≥n: el ignorar s√≠ ocurri√≥.'}
    ]},
    {type:'patient',text:'Pero igual, aunque sea un 60, sigue siendo mi hermano y me fall√≥. No puedo simplemente actuar como si nada.'},
    {type:'decision',stepLabel:'AO ¬∑ Concepto + Paso 3',options:[
      {text:'Acci√≥n Opuesta no es actuar como si nada. Es que cuando actu√°s sobre un impulso que no es efectivo, lo reforz√°s. ¬øQu√© te urge hacer ahora mismo?',correct:true,pts:10,reaction:'Confrontarlo. Ir a su casa o mandarle un mensaje dici√©ndole todo lo que pienso.',ok:'Clarificaste el concepto sin invalidar. Ahora ten√©s el impulso de acci√≥n identificado con precisi√≥n.',badge:'AO Paso 3: impulso identificado'},
      {text:'Entiendo, pero si actu√°s sobre la emoci√≥n vas a empeorar las cosas.',correct:false,reaction:'Eso no me ayuda. ¬øQu√© hago entonces?',fail:'Avanzaste sin validar ni explicar la l√≥gica de Acci√≥n Opuesta.'},
      {text:'Ten√©s raz√≥n. Mejor hablemos de c√≥mo recuperar el dinero.',correct:false,reaction:'S√≠, eso es lo que necesito...',fail:'Saltaste a Resoluci√≥n de Problemas antes de regular la emoci√≥n. Con 60/100 de bronca, cualquier estrategia va a estar contaminada.'}
    ]},
    {type:'decision',stepLabel:'AO ¬∑ Pasos 4‚Äì6',options:[
      {text:'¬øConfrontarlo ahora, con esta intensidad, te va a acercar a recuperar el dinero o a mantener la relaci√≥n?',correct:true,pts:10,reaction:'No... probablemente empeore todo. Aunque tampoco puedo ignorarlo.',ok:'Evaluaste efectividad con Mente Sabia y Marcos lleg√≥ solo a la conclusi√≥n. La parte v√°lida se puede trabajar con Resoluci√≥n de Problemas despu√©s.',badge:'AO Pasos 4-6: efectividad evaluada'},
      {text:'Hac√© lo contrario: no le escribas, esper√° a estar m√°s tranquilo.',correct:false,reaction:'S√≠, supongo.',fail:'Diste la instrucci√≥n sin el proceso. Marcos no entiende por qu√© ‚Äî y probablemente igualmente le mande el mensaj√≥n.'},
      {text:'¬øY si le mand√°s un mensaje breve y concreto pidiendo una fecha de pago?',correct:false,reaction:'Con la bronca que tengo igual le escribo mal.',fail:'Fuiste a Resoluci√≥n de Problemas sin regular la emoci√≥n primero.'}
    ]}
  ]},
  {id:2,title:'Elena',sub:'41 a√±os ¬∑ Gerente de proyectos',desc:'Fue despedida despu√©s de 8 a√±os. Su tristeza encaja con los hechos. Caso para terapeutas avanzados.',diff:'Avanzado',diffClass:'badge-hard',icon:'üòî',maxScore:40,
  beats:[
    {type:'narrator',text:'‚Äî Elena llega a sesi√≥n tres d√≠as despu√©s de ser despedida ‚Äî'},
    {type:'patient',text:'Me despidieron el jueves. Ocho a√±os en esa empresa. Me lo comunicaron por mail.'},
    {type:'patient',text:'Estoy muy triste. No puedo dormir, no tengo ganas de nada. Y tambi√©n estoy enojada, pero lo que m√°s siento es tristeza.'},
    {type:'decision',stepLabel:'VH ¬∑ Paso 1',options:[
      {text:'¬øCu√°l es la emoci√≥n m√°s fuerte ahora, y qu√© tan intensa?',correct:true,pts:10,reaction:'Tristeza. Un 75/100. Perd√≠ algo que fue muy importante para m√≠. Y la forma en que lo manejaron ‚Äî por mail, sin ni una reuni√≥n.',ok:'Identificaste la emoci√≥n primaria. Elena distingue la tristeza (por la p√©rdida) de la bronca (por el trato). Dos emociones, dos rutas distintas.',badge:'VH Paso 1: emoci√≥n primaria identificada'},
      {text:'Eso es muy duro. ¬øTen√©s apoyo en casa?',correct:false,reaction:'S√≠, mi pareja est√° muy presente. Pero igual no puedo con esto.',fail:'Exploraste la red de apoyo antes de anclar la emoci√≥n. √ötil, pero no es el primer movimiento en este protocolo.'},
      {text:'¬øQu√© vas a hacer ahora con el trabajo?',correct:false,reaction:'No s√©. No puedo ni pensar en eso todav√≠a.',fail:'Fuiste a la acci√≥n. La respuesta de Elena lo dice claramente: no est√° lista para eso.'}
    ]},
    {type:'decision',stepLabel:'VH ¬∑ Paso 6 ‚Äî decisi√≥n clave',options:[
      {text:'Perdiste un trabajo de 8 a√±os de forma abrupta. La tristeza ante una p√©rdida real encaja completamente con los hechos.',correct:true,pts:10,reaction:'S√≠... s√© que tiene sentido sentirme as√≠. Pero igual es muy dif√≠cil.',ok:'Cuando la emoci√≥n encaja con los hechos, Acci√≥n Opuesta no es la herramienta. La tristeza es v√°lida y tiene funci√≥n.',badge:'VH Paso 6: la emoci√≥n S√ç encaja'},
      {text:'Igual, 75% parece mucho. Vamos a trabajar con Acci√≥n Opuesta.',correct:false,reaction:'¬øActuar opuesto a la tristeza? ¬øForzarme a estar bien?',fail:'Este es el error central del nivel avanzado: aplicar Acci√≥n Opuesta cuando la emoci√≥n s√≠ encaja. La tristeza por una p√©rdida real no se regula con AO.'},
      {text:'La tristeza es normal pero no pod√©s quedarte paralizada.',correct:false,reaction:'Lo s√©, pero no puedo hacer nada ahora mismo.',fail:'Invalidaste la funci√≥n adaptativa de la tristeza. Ante una p√©rdida real, el sistema necesita conservar recursos primero.'}
    ]},
    {type:'patient',text:'Y lo de la bronca ‚Äî me parece que ah√≠ s√≠ hay algo para hacer. La forma en que me lo comunicaron fue un faltazo.'},
    {type:'decision',stepLabel:'Integraci√≥n: dos emociones, dos rutas',options:[
      {text:'La tristeza por la p√©rdida encaja y necesita validaci√≥n y Resoluci√≥n de Problemas. La bronca por el trato ‚Äî ah√≠ verificamos si la intensidad encaja.',correct:true,pts:10,reaction:'Eso tiene mucho sentido. Son dos cosas distintas.',ok:'Misma situaci√≥n, dos emociones, dos rutas. Tristeza ‚Üí Resoluci√≥n de Problemas. Bronca ‚Üí verificar intensidad ‚Üí ¬øAO o PS?',badge:'Integraci√≥n: cada emoci√≥n tiene su ruta'},
      {text:'Las dos emociones encajan, as√≠ que Resoluci√≥n de Problemas para ambas.',correct:false,reaction:'Las dos... s√≠, supongo.',fail:'La bronca todav√≠a necesita verificaci√≥n de intensidad. No toda emoci√≥n que encaja tiene la intensidad justa.'},
      {text:'Concentr√©monos en la tristeza, la bronca la dejamos para despu√©s.',correct:false,reaction:'De acuerdo.',fail:'Elena misma se√±al√≥ que en la bronca hay algo para hacer. Ignorarlo puede sentirse como invalidaci√≥n.'}
    ]},
    {type:'decision',stepLabel:'Resoluci√≥n de Problemas',options:[
      {text:'La tristeza tiene funci√≥n: primero conservar recursos, despu√©s movilizar. ¬øQu√© necesit√°s ahora para atravesarla sin hundirte?',correct:true,pts:10,reaction:'Creo que necesito un poco de tiempo para procesarlo. Y despu√©s ‚Äî hablar con personas de la industria, actualizar el CV. Pero no hoy.',ok:'Acompa√±aste la funci√≥n de la tristeza y abriste la puerta a la movilizaci√≥n cuando Elena est√© lista. Resoluci√≥n de Problemas al servicio de la emoci√≥n, no contra ella.',badge:'Resoluci√≥n de Problemas: con la emoci√≥n'},
      {text:'¬øQu√© estrategias concretas ten√©s para encontrar un nuevo trabajo?',correct:false,reaction:'Ahora mismo no tengo cabeza para eso...',fail:'Fuiste a estrategias concretas demasiado pronto. Elena lo dice claramente.'},
      {text:'Lo m√°s importante ahora es que no te quedes sola con esto.',correct:false,reaction:'S√≠, mi pareja...',fail:'El apoyo social es v√°lido pero no es Resoluci√≥n de Problemas. Elena necesita un plan alineado con d√≥nde est√° emocionalmente.'}
    ]}
  ]}
];

// ===================== THEORY STATE =====================
let currentSlide = 0;
const totalSlides = THEORY_SLIDES.length;

function openTheory() {
  buildTheorySlides();
  currentSlide = 0;
  renderSlide(0);
  showScreen('theory');
}

function buildTheorySlides() {
  const container = document.getElementById('theorySlidesContainer');
  if (container.children.length > 0) return; // already built
  container.innerHTML = THEORY_SLIDES.map((s, i) => `
    <div class="theory-slide ${i===0?'active':''}" id="slide-${i}">
      <div class="slide-card">
        <div class="slide-card-head">
          <div class="slide-num">${s.num}</div>
          <div class="slide-title">${s.title}</div>
        </div>
        <div class="slide-card-body">${s.content}</div>
      </div>
      ${i === totalSlides-1 ? `
        <div style="margin-top:16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:22px;text-align:center">
          <p style="font-size:var(--fs-body);color:var(--text-muted);margin-bottom:16px;line-height:1.65">Ahora que ten√©s el marco completo, <strong style="color:var(--text)">practic√° con casos reales</strong>. El paciente te escribe ‚Äî vos decid√≠s.</p>
          <button class="btn-primary" onclick="showPractice()">Ir a los casos cl√≠nicos ‚Üí</button>
        </div>
      ` : ''}
    </div>
  `).join('');
}

function renderSlide(idx) {
  document.querySelectorAll('.theory-slide').forEach(s => s.classList.remove('active'));
  document.getElementById(`slide-${idx}`).classList.add('active');
  document.getElementById(`slide-${idx}`).scrollTop = 0;
  document.getElementById('theoryPagination').textContent = `${idx+1} / ${totalSlides}`;
  document.getElementById('theoryProgress').style.width = `${((idx+1)/totalSlides)*100}%`;
  document.getElementById('tPrev').disabled = idx === 0;
  document.getElementById('tNext').textContent = idx === totalSlides-1 ? '‚úì Practicar' : 'Siguiente ‚Üí';
  if (idx === totalSlides-1) {
    document.getElementById('tNext').onclick = () => showPractice();
  } else {
    document.getElementById('tNext').onclick = () => theoryNav(1);
  }
}

function theoryNav(dir) {
  const next = currentSlide + dir;
  if (next < 0 || next >= totalSlides) return;
  currentSlide = next;
  renderSlide(currentSlide);
}

// ===================== PRACTICE =====================
function showPractice() {
  renderLevelCards();
  showScreen('practice');
}

function renderLevelCards() {
  const c = document.getElementById('levelCards');
  c.innerHTML = LEVELS.map((l,i) => {
    const done = ST.completedLevels[i];
    const locked = i>0 && !ST.completedLevels[i-1];
    return `<div class="level-card lvl-${i} ${done?'completed':''} ${locked?'locked':''}" onclick="${locked?'':'startLevel('+i+')'}">
      <div class="level-stripe"></div>
      ${done?`<span class="score-chip">${done.score}/${done.max}</span>`:''}
      ${locked?`<span class="lock-icon">üîí</span>`:''}
      <div class="level-icon-box">${l.icon}</div>
      <div class="level-info">
        <div class="level-name">${l.title}</div>
        <div class="level-person">${l.sub}</div>
        <div class="level-desc">${l.desc}</div>
        <span class="level-badge ${l.diffClass}">${l.diff}</span>
      </div>
    </div>`;
  }).join('');
}

// ===================== SESSION STATE =====================
const ST = {
  theme:'dark', currentLevel:null, beatIndex:0, score:0, results:[],
  completedLevels:{}, totalScore:0, currentDecision:null, waiting:false,
  firstTry:true, resolve:null
};

function startLevel(idx) {
  const l = LEVELS[idx];
  if (idx>0 && !ST.completedLevels[idx-1]) return;
  ST.currentLevel=idx; ST.beatIndex=0; ST.score=0; ST.results=[]; ST.waiting=false; ST.firstTry=true;
  document.getElementById('sessPatient').textContent=`${l.title} ¬∑ ${l.sub}`;
  document.getElementById('sessLevel').textContent=`Nivel ${idx+1} ‚Äî ${l.diff}`;
  document.getElementById('scorePill').textContent='0 pts';
  document.getElementById('chatArea').innerHTML='';
  document.getElementById('decisionArea').style.display='none';
  showScreen('session');
  setTimeout(()=>runBeats(), 300);
}

async function runBeats() {
  const l = LEVELS[ST.currentLevel];
  while (ST.beatIndex < l.beats.length) {
    const b = l.beats[ST.beatIndex];
    if (b.type==='decision') { await showDecision(b); ST.beatIndex++; }
    else { await showMsg(b.type, b.text); ST.beatIndex++; await delay(420); }
  }
  await delay(600); showResult();
}

function showMsg(type, text, badge) {
  return new Promise(res => {
    const chat = document.getElementById('chatArea');
    if (type==='patient') {
      const typing = document.createElement('div');
      typing.className='chat-msg patient';
      typing.innerHTML='<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
      chat.appendChild(typing); scrollChat();
      setTimeout(()=>{
        typing.innerHTML=`<div class="bubble">${text}</div>`;
        if(badge){const b=document.createElement('div');b.className='chat-msg patient';b.innerHTML=`<span class="step-badge">‚úì ${badge}</span>`;chat.appendChild(b);}
        scrollChat(); res();
      }, 950);
    } else {
      const m = document.createElement('div');
      m.className=`chat-msg ${type}`;
      m.innerHTML=`<div class="bubble">${text}</div>`;
      chat.appendChild(m);
      if(badge){const b=document.createElement('div');b.className='chat-msg patient';b.innerHTML=`<span class="step-badge">‚úì ${badge}</span>`;chat.appendChild(b);}
      scrollChat(); setTimeout(res, 200);
    }
  });
}

function showDecision(beat) {
  return new Promise(res => {
    ST.currentDecision=beat; ST.waiting=true; ST.firstTry=true; ST.resolve=res;
    document.getElementById('stepTag').textContent=beat.stepLabel;
    document.getElementById('optionsList').innerHTML=beat.options.map((o,i)=>`<button class="opt-btn" onclick="selectOpt(${i})">${o.text}</button>`).join('');
    document.getElementById('decisionArea').style.display='block';
    document.querySelectorAll('.opt-btn').forEach((b,i)=>{b.style.animation=`fadeUp .22s ${i*.06}s ease both`;});
  });
}

async function selectOpt(idx) {
  if (!ST.waiting) return;
  const beat = ST.currentDecision; const opt = beat.options[idx];
  document.querySelectorAll('.opt-btn').forEach(b=>b.style.pointerEvents='none');
  const chat = document.getElementById('chatArea');
  const tm = document.createElement('div'); tm.className='chat-msg therapist';
  tm.innerHTML=`<div class="bubble">${opt.text}</div>`;
  chat.appendChild(tm); scrollChat();
  await delay(550);
  if (opt.correct) {
    await showMsg('patient', opt.reaction);
    const fb = document.createElement('div'); fb.className='feedback-box ok'; fb.textContent=opt.ok; chat.appendChild(fb);
    if(opt.badge){const b=document.createElement('div');b.className='chat-msg patient';b.innerHTML=`<span class="step-badge">‚úì ${opt.badge}</span>`;chat.appendChild(b);}
    scrollChat();
    const pts = ST.firstTry ? opt.pts : Math.floor(opt.pts/2);
    ST.score += pts;
    ST.results.push({label:beat.stepLabel, pts, maxPts:opt.pts, firstTry:ST.firstTry, badge:opt.badge});
    document.getElementById('scorePill').textContent=`${ST.score} pts`;
    document.getElementById('decisionArea').style.display='none';
    ST.waiting=false; await delay(500); ST.resolve();
  } else {
    ST.firstTry=false;
    document.querySelectorAll('.opt-btn')[idx].classList.add('wrong');
    await delay(300);
    await showMsg('patient', opt.reaction);
    const fb = document.createElement('div'); fb.className='feedback-box fail'; fb.textContent=opt.fail; chat.appendChild(fb);
    scrollChat(); await delay(1300);
    document.getElementById('optionsList').innerHTML=beat.options.map((o,i)=>`<button class="opt-btn" onclick="selectOpt(${i})">${o.text}</button>`).join('');
    document.querySelectorAll('.opt-btn').forEach((b,i)=>{b.style.animation=`fadeUp .2s ${i*.05}s ease both`;});
  }
}

function scrollChat() {
  const c = document.getElementById('chatArea');
  setTimeout(()=>c.scrollTo({top:c.scrollHeight, behavior:'smooth'}), 50);
}

// ===================== RESULT =====================
function showResult() {
  const l = LEVELS[ST.currentLevel];
  const pct = Math.round(ST.score/l.maxScore*100);
  document.getElementById('resultName').textContent=`${l.title} ¬∑ Completado`;
  document.getElementById('resultSub').textContent=`${l.diff} ¬∑ ${ST.results.length} pasos trabajados`;
  const ring = document.getElementById('scoreRing');
  const num = document.getElementById('scoreNum');
  num.textContent = ST.score;
  const color = pct>=80?'#3DBE8A':pct>=60?'#F5C518':'#E85555';
  ring.style.borderColor=color; num.style.color=color;
  document.getElementById('decisionsBody').innerHTML=ST.results.map((r,i)=>`
    <div class="decision-card ${r.firstTry?'first':'retry'}" style="animation-delay:${i*.07}s">
      <div class="dc-header">
        <span class="dc-icon">${r.firstTry?'‚úì':'‚Ü∫'}</span>
        <span class="dc-name">${r.badge||r.label}</span>
        <span class="dc-pts ${r.pts===r.maxPts?'full':'half'}">${r.pts}/${r.maxPts}</span>
      </div>
      <div class="dc-detail">${r.firstTry?'Primer intento correcto':'Correcto tras reintento'}</div>
    </div>`).join('');
  ST.completedLevels[ST.currentLevel]={score:ST.score, max:l.maxScore};
  const allDone = Object.keys(ST.completedLevels).length===3;
  const actions = document.getElementById('resultActions');
  if (allDone) {
    ST.totalScore = Object.values(ST.completedLevels).reduce((a,b)=>a+b.score,0);
    actions.innerHTML=`<button class="btn-primary" onclick="showCertificate()">Ver mi certificado üèÖ</button><button class="btn-secondary" onclick="showPractice()">Volver a los casos</button>`;
  } else {
    const next = ST.currentLevel+1;
    actions.innerHTML=`${next<LEVELS.length?`<button class="btn-primary" onclick="startLevel(${next})">Siguiente caso ‚Üí</button>`:''}
      <button class="btn-secondary" onclick="showPractice()">Volver a los casos</button>`;
  }
  showScreen('result');
}

// ===================== CERTIFICATE =====================
function showCertificate() {
  document.getElementById('certScore').textContent=ST.totalScore;
  document.getElementById('certNameDisplay').textContent='Tu nombre';
  document.getElementById('certNameInput').value='';
  showScreen('certificate');
}
function updateCertName(v){document.getElementById('certNameDisplay').textContent=v||'Tu nombre';}
function shareCert() {
  const text=`Complet√© el entrenamiento en Regulaci√≥n Emocional DBT (Verificar los Hechos + Acci√≥n Opuesta) con ${ST.totalScore} puntos en el simulador de @leo.eyzaguirre üß†\n\n#DBT #Psicolog√≠aContextual #RegulacionEmocional`;
  if(navigator.share)navigator.share({title:'Certificado DBT Simulador',text});
  else navigator.clipboard.writeText(text).then(()=>alert('Texto copiado al portapapeles'));
}

// ===================== GUIDE =====================
let guideTab='vh';
function openGuide(){document.getElementById('guideOverlay').classList.add('open');renderGuide(guideTab);}
function closeGuide(){document.getElementById('guideOverlay').classList.remove('open');}
function closeGuideOverlay(e){if(e.target===document.getElementById('guideOverlay'))closeGuide();}
function switchTab(tab,el){guideTab=tab;document.querySelectorAll('.guide-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderGuide(tab);}
function renderGuide(tab) {
  const isAO=tab==='ao';
  document.getElementById('guideBody').innerHTML=GUIDE[tab].map((s,i)=>`
    <div class="g-step">
      <div class="g-num" style="color:${isAO?'var(--accent2)':'var(--accent3)'}">${i+1}</div>
      <div class="g-text"><strong>${s.q}</strong><p>${s.d}</p></div>
    </div>`).join('');
}

// ===================== THEME =====================
function toggleTheme() {
  ST.theme=ST.theme==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',ST.theme);
  document.getElementById('themeBtn').textContent=ST.theme==='dark'?'üåô':'‚òÄÔ∏è';
}

// ===================== NAV =====================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.getElementById(id).scrollTop=0;
}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}
</script>
</body>
</html>
